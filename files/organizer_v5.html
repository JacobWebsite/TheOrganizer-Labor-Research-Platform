<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Organizer — Labor Research Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#faf9f7',
                        warmgray: {
                            100: '#f5f3f0',
                            200: '#e8e5e0',
                            300: '#d4d0c8',
                            400: '#a8a298',
                            500: '#7d7770',
                            600: '#5c5752',
                            700: '#3d3935',
                            800: '#2a2725',
                            900: '#1a1a1a'
                        },
                        accent: {
                            red: '#c41e3a',
                            redDark: '#9e1830',
                            redLight: '#e8d4d8'
                        }
                    },
                    fontFamily: {
                        'headline': ['"Playfair Display"', 'serif'],
                        'body': ['"Source Sans Pro"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Source Sans Pro', sans-serif; }
        .headline { font-family: 'Playfair Display', serif; }
        
        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f5f3f0; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d4d0c8; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a298; }
        
        /* Tab styling */
        .tab-inactive { color: #7d7770; }
        .tab-active { background: #1a1a1a; color: white; }
        
        /* List item states */
        .list-item { border-left: 3px solid transparent; transition: all 0.15s ease; }
        .list-item:hover { background: #f5f3f0; }
        .list-item.selected { background: white; border-left-color: #1a1a1a; }
        .list-item.keyboard-focus { outline: 2px solid #8B4513; outline-offset: -2px; background: #faf8f5; }
        
        /* Print styles */
        @media print {
            body { background: white !important; }
            .no-print, nav, header, footer, #searchFilters, #listViewContainer, #mapViewContainer, 
            button, .view-toggle, #detailActionSection, #detailMap { display: none !important; }
            #detailContent { overflow: visible !important; height: auto !important; }
            .badge { border: 1px solid #ccc !important; }
            @page { margin: 1in; }
        }
        .print-only { display: none; }
        @media print { .print-only { display: block; } }
        
        /* Badge styles */
        .badge { font-size: 11px; padding: 2px 8px; border-radius: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
        .badge-private { background: #1a1a1a; color: white; }
        .badge-public { background: #d1e7dd; color: #0a5132; }
        .badge-federal { background: #fff3cd; color: #664d03; }
        .badge-rla { background: #e2d9f3; color: #432874; }
        .badge-industry { background: #f0ede8; color: #5c5752; }
        
        /* Collapsible */
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 500px; }
        
        /* Map container */
        #detailMap { height: 160px; border-radius: 6px; }
        #fullMapContainer { height: calc(100vh - 380px); min-height: 500px; border-radius: 8px; }
        
        /* Custom cluster markers */
        .marker-cluster-small { background-color: rgba(139, 69, 19, 0.6); }
        .marker-cluster-small div { background-color: rgba(139, 69, 19, 0.8); }
        .marker-cluster-medium { background-color: rgba(139, 69, 19, 0.7); }
        .marker-cluster-medium div { background-color: rgba(139, 69, 19, 0.9); }
        .marker-cluster-large { background-color: rgba(139, 69, 19, 0.8); }
        .marker-cluster-large div { background-color: rgba(139, 69, 19, 1); }
        .marker-cluster { color: white; font-weight: bold; }
        
        /* Corporate family cluster markers */
        .corporate-cluster-icon { background: transparent; }
        .corporate-cluster {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 14px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            border: 2px solid white;
        }
        
        /* View toggle */
        .view-toggle { display: inline-flex; border-radius: 6px; overflow: hidden; border: 1px solid #e8e5e0; }
        .view-toggle button { padding: 6px 12px; font-size: 13px; background: white; color: #5c5752; border: none; cursor: pointer; transition: all 0.2s; }
        .view-toggle button:hover { background: #f5f3f0; }
        .view-toggle button.active { background: #1a1a1a; color: white; }
        .view-toggle button:first-child { border-right: 1px solid #e8e5e0; }
        
        /* Input focus states */
        input:focus, select:focus { outline: none; border-color: #1a1a1a; }
        
        /* Typeahead dropdown */
        .typeahead-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #e8e5e0; 
            border-top: none;
            border-radius: 0 0 6px 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }
        .typeahead-dropdown.open { display: block; }
        .typeahead-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f5f3f0; }
        .typeahead-item:last-child { border-bottom: none; }
        .typeahead-item:hover, .typeahead-item.bg-warmgray-100 { background: #f5f3f0; }
        .typeahead-category {
            position: sticky;
            top: 0;
            background: #faf9f7;
            border-bottom: 1px solid #e8e5e0;
            font-size: 11px;
            padding: 8px 14px;
            color: #7d7770;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* Map containment fixes - prevent pop-out bugs */
        #fullMapContainer, #detailMap, #corporateFamilyMap {
            contain: layout paint;
            position: relative;
            overflow: hidden;
        }

        /* Body scroll lock when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        /* Clickable entity links */
        .entity-link {
            cursor: pointer;
            text-decoration-line: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        .entity-link:hover {
            text-decoration-style: solid;
            color: #c41e3a;
        }

        /* Law firm warning badge */
        .badge-law-firm {
            background: #fef3c7;
            color: #92400e;
            font-size: 10px;
        }
    </style>
</head>

<body class="bg-cream min-h-screen">
    <!-- ============================================ -->
    <!-- HEADER -->
    <!-- ============================================ -->
    <header class="bg-warmgray-900 text-white">
        <div class="max-w-7xl mx-auto px-6 py-5">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="headline text-2xl font-bold tracking-tight">The Organizer</h1>
                    <p class="text-warmgray-400 text-sm mt-0.5">Labor Research Tool</p>
                </div>
                <div class="flex items-center gap-8 text-sm">
                    <button onclick="openAnalyticsDashboard()" 
                        class="flex items-center gap-2 px-4 py-2 bg-warmgray-800 hover:bg-warmgray-700 rounded-lg transition-colors"
                        title="Analytics Dashboard">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        <span>Analytics</span>
                    </button>
                    <div class="text-right">
                        <div class="text-warmgray-400">Workers</div>
                        <div class="text-lg font-semibold" id="headerWorkers">14.5M</div>
                    </div>
                    <div class="text-right">
                        <div class="text-warmgray-400">Employers</div>
                        <div class="text-lg font-semibold" id="headerEmployers">99,907</div>
                    </div>
                    <div class="text-right">
                        <div class="text-warmgray-400">Unions</div>
                        <div class="text-lg font-semibold" id="headerUnions">26,665</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ============================================ -->
    <!-- MAIN CONTENT -->
    <!-- ============================================ -->
    <main class="max-w-7xl mx-auto px-6 py-6">
        
        <!-- ============================================ -->
        <!-- SEARCH MODE TOGGLE -->
        <!-- ============================================ -->
        <div class="mb-5 flex justify-between items-center">
            <div class="inline-flex gap-1 p-1 bg-warmgray-200 rounded-full">
                <button id="tabEmployers" onclick="setSearchMode('employers')" 
                    class="tab-active px-6 py-2 text-sm font-semibold rounded-full transition-all">
                    Search Employers
                </button>
                <button id="tabUnions" onclick="setSearchMode('unions')" 
                    class="tab-inactive px-6 py-2 text-sm font-semibold rounded-full transition-all hover:text-warmgray-700">
                    Search Unions
                </button>
            </div>
            <div class="flex items-center gap-4">
                <!-- Saved Searches Dropdown -->
                <div class="relative">
                    <button onclick="toggleSavedSearches()" 
                        class="text-sm text-warmgray-500 hover:text-warmgray-700 font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                        Saved Searches
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="savedSearchesDropdown" class="hidden absolute right-0 top-full mt-2 w-72 bg-white rounded-lg shadow-lg border border-warmgray-200 z-50">
                        <div class="p-3 border-b border-warmgray-100">
                            <button onclick="saveCurrentSearch()" 
                                class="w-full text-left text-sm text-warmgray-600 hover:text-warmgray-900 flex items-center gap-2 py-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Save current search...
                            </button>
                        </div>
                        <div id="savedSearchesList" class="max-h-64 overflow-y-auto">
                            <div class="p-3 text-sm text-warmgray-400 text-center">No saved searches</div>
                        </div>
                    </div>
                </div>
                <button onclick="openOrganizingScorecard()" 
                    class="text-sm text-green-700 hover:text-green-800 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Organizing Targets
                </button>
                <button onclick="openNationalUnionsBrowser()"
                    class="text-sm text-accent-red hover:text-accent-redDark font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Browse National Unions
                </button>
                <span class="text-warmgray-300">|</span>
                <button onclick="openElectionsModal()"
                    class="text-sm text-blue-700 hover:text-blue-800 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Elections
                </button>
                <button onclick="openUnifiedEmployersModal()"
                    class="text-sm text-purple-700 hover:text-purple-800 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    All Employers
                </button>
                <button onclick="openTrendsModal()"
                    class="text-sm text-emerald-700 hover:text-emerald-800 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                    Trends
                </button>
                <button onclick="openPublicSectorModal()"
                    class="text-sm text-orange-700 hover:text-orange-800 font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                    </svg>
                    Public Sector
                </button>
                <span class="text-warmgray-300">|</span>
                <button onclick="runDebugCheck()"
                    class="text-sm text-red-600 hover:text-red-700 font-medium">
                    Debug
                </button>
            </div>
        </div>

        <!-- Debug Output -->
        <div id="debugOutput" class="hidden bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4 text-sm font-mono"></div>

        <!-- ============================================ -->
        <!-- SEARCH & FILTERS -->
        <!-- ============================================ -->
        <div class="bg-white rounded-lg shadow-sm border border-warmgray-200 mb-5">
            <div class="p-5">
                <!-- Row 1: Main search + Industry typeahead -->
                <div class="flex gap-4 mb-4">
                    <!-- Main search input -->
                    <div class="flex-1 relative">
                        <input type="text" id="mainSearch" 
                            placeholder="Search by name..."
                            class="w-full px-4 py-3 border-2 border-warmgray-300 rounded-lg text-base font-medium placeholder-warmgray-400 focus:border-warmgray-900">
                        <div id="mainSearchTypeahead" class="typeahead-dropdown">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Industry typeahead -->
                    <div class="w-80 relative" id="industrySearchContainer">
                        <input type="text" id="industrySearch" 
                            placeholder="Industry, union, or occupation..."
                            class="w-full px-4 py-3 border border-warmgray-300 rounded-lg text-sm placeholder-warmgray-400"
                            autocomplete="off">
                        <div id="industryTypeahead" class="typeahead-dropdown max-h-80 overflow-y-auto custom-scroll">
                            <!-- Populated by JS -->
                        </div>
                        <!-- Tag container for selected industry -->
                        <div id="industryTagContainer" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Row 2: Geographic cascade + Sector filter -->
                <div class="flex gap-3 items-center">
                    <!-- State -->
                    <div class="w-44">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="stateFilter" onchange="onStateChange()" 
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-md text-sm bg-white">
                            <option value="">All States</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    
                    <!-- Metro (depends on state) -->
                    <div class="w-52">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Metro Area</label>
                        <select id="metroFilter" onchange="onMetroChange()" 
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-md text-sm bg-white" disabled>
                            <option value="">Select state first</option>
                        </select>
                    </div>
                    
                    <!-- City (depends on metro or state) -->
                    <div class="w-44">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">City</label>
                        <select id="cityFilter" 
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-md text-sm bg-white" disabled>
                            <option value="">Select metro first</option>
                        </select>
                    </div>
                    
                    <div class="w-px h-10 bg-warmgray-200 mx-2"></div>
                    
                    <!-- Sector filter -->
                    <div class="w-40">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Sector</label>
                        <select id="sectorFilter" 
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-md text-sm bg-white">
                            <option value="">All Sectors</option>
                            <option value="PRIVATE">Private</option>
                            <option value="PUBLIC_SECTOR">Public (State/Local)</option>
                            <option value="FEDERAL">Federal</option>
                            <option value="RLA">RLA (Rail/Airline)</option>
                        </select>
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <!-- Search button -->
                    <button onclick="executeSearch()" 
                        class="px-6 py-2 bg-warmgray-900 text-white font-semibold rounded-md hover:bg-warmgray-800 transition-colors">
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- RESULTS HEADER (Collapsible Stats) -->
        <!-- ============================================ -->
        <div class="bg-warmgray-100 border border-warmgray-200 rounded-lg mb-4">
            <!-- Summary row (always visible) -->
            <div class="px-5 py-3 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <span class="text-warmgray-600">
                        <strong class="text-warmgray-900" id="resultCount">0</strong> <span id="resultCountLabel">employers</span>
                    </span>
                    <span class="text-warmgray-400">·</span>
                    <span class="text-warmgray-600">
                        <strong class="text-warmgray-900" id="resultWorkers">0</strong> <span id="resultWorkersLabel">workers</span>
                    </span>
                    <span class="text-warmgray-400">·</span>
                    <span class="text-warmgray-600">
                        <strong class="text-warmgray-900" id="resultLocals">0</strong> <span id="resultLocalsLabel">locals</span>
                    </span>
                </div>
                <button onclick="toggleStats()" class="text-sm text-warmgray-500 hover:text-warmgray-700 flex items-center gap-1">
                    <span id="statsToggleText">Show breakdown</span>
                    <svg id="statsToggleIcon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Expanded stats (collapsible) -->
            <div id="statsExpanded" class="collapsible-content">
                <div class="px-5 py-4 border-t border-warmgray-200 grid grid-cols-4 gap-6">
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-2">By Sector</div>
                        <div class="space-y-1 text-sm" id="statsBySector">
                            <div class="flex justify-between"><span>Private</span><span class="font-semibold">—</span></div>
                            <div class="flex justify-between"><span>Public</span><span class="font-semibold">—</span></div>
                            <div class="flex justify-between"><span>Federal</span><span class="font-semibold">—</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-2">Top Industries</div>
                        <div class="space-y-1 text-sm" id="statsByIndustry">
                            <div class="flex justify-between"><span>Healthcare</span><span class="font-semibold">—</span></div>
                            <div class="flex justify-between"><span>Education</span><span class="font-semibold">—</span></div>
                            <div class="flex justify-between"><span>Manufacturing</span><span class="font-semibold">—</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-2">Top Metros</div>
                        <div class="space-y-1 text-sm" id="statsByMetro">
                            <div class="flex justify-between"><span>—</span><span class="font-semibold">—</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-2">Top Unions</div>
                        <div class="space-y-1 text-sm" id="statsByUnion">
                            <div class="flex justify-between"><span>—</span><span class="font-semibold">—</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- VIEW TOGGLE -->
        <!-- ============================================ -->
        <div class="flex justify-between items-center mb-4">
            <div class="text-sm text-warmgray-500">
                <span id="resultsCount">0</span> results
                <span id="mappableCount" class="text-warmgray-400 ml-2"></span>
            </div>
            <div class="flex items-center gap-3">
                <button id="shareBtn" onclick="copyShareLink()" 
                    class="text-sm text-warmgray-500 hover:text-warmgray-700 flex items-center gap-1 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    <span id="shareBtnText">Share</span>
                </button>
                <button id="exportBtn" onclick="exportResults()" 
                    class="text-sm text-warmgray-500 hover:text-warmgray-700 flex items-center gap-1 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export CSV
                </button>
                <button id="compareBtn" onclick="openComparison()" 
                    class="text-sm text-warmgray-500 hover:text-warmgray-700 flex items-center gap-1 relative">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Compare
                    <span id="comparisonBadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-accent-red text-white text-xs rounded-full flex items-center justify-center">0</span>
                </button>
                <div class="view-toggle">
                    <button id="listViewBtn" class="active" onclick="setView('list')">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        List
                    </button>
                    <button id="mapViewBtn" onclick="setView('map')">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Map
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- MAP VIEW (hidden by default) -->
        <!-- ============================================ -->
        <div id="mapViewContainer" class="hidden mb-5">
            <div class="bg-white rounded-lg shadow-sm border border-warmgray-200 overflow-hidden">
                <div id="fullMapContainer"></div>
            </div>
            <!-- Selected item panel (below map) -->
            <div id="mapSelectionPanel" class="mt-4 hidden">
                <div class="bg-white rounded-lg shadow-sm border border-warmgray-200 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="mapSelectedName" class="font-semibold text-lg text-warmgray-900"></h3>
                            <p id="mapSelectedLocation" class="text-sm text-warmgray-500"></p>
                        </div>
                        <div id="mapSelectedBadges" class="flex gap-2"></div>
                    </div>
                    <div class="mt-3 flex gap-4 text-sm">
                        <div id="mapSelectedStats"></div>
                    </div>
                    <div class="mt-3">
                        <button id="mapViewDetailBtn" class="text-sm font-medium text-accent-red hover:text-accent-redDark">
                            View full details →
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SPLIT PANE: LIST + DETAIL -->
        <!-- ============================================ -->
        <div id="listViewContainer" class="flex gap-5" style="min-height: 600px;">
            
            <!-- LEFT: Results List -->
            <div class="w-2/5 bg-white rounded-lg shadow-sm border border-warmgray-200 flex flex-col">
                <!-- List header -->
                <div class="px-4 py-3 border-b border-warmgray-200 flex justify-between items-center">
                    <span class="text-sm font-semibold text-warmgray-700">Results</span>
                    <select id="sortBy" class="text-sm border border-warmgray-200 rounded px-2 py-1">
                        <option value="workers">Sort: Workers ↓</option>
                        <option value="name">Sort: Name A-Z</option>
                        <option value="date">Sort: Recent first</option>
                    </select>
                </div>
                
                <!-- List items -->
                <div id="resultsList" class="flex-1 overflow-y-auto custom-scroll">
                    <!-- Empty state -->
                    <div id="emptyState" class="p-8 text-center">
                        <div class="text-warmgray-400 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <div id="emptyStateTitle" class="text-warmgray-500 font-medium">Search for employers or unions</div>
                        <div id="emptyStateSubtitle" class="text-warmgray-400 text-sm mt-1">Use the filters above to find organized workplaces</div>
                    </div>
                    
                    <!-- Sample list items (will be generated by JS) -->
                    <div id="listItems" class="hidden">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Pagination -->
                <div id="pagination" class="px-4 py-3 border-t border-warmgray-200 flex justify-between items-center hidden">
                    <button id="prevPage" class="text-sm text-warmgray-500 hover:text-warmgray-700 disabled:opacity-40" disabled>
                        ← Previous
                    </button>
                    <span id="pageInfo" class="text-sm text-warmgray-500">Page 1 of 1</span>
                    <button id="nextPage" class="text-sm text-warmgray-500 hover:text-warmgray-700 disabled:opacity-40" disabled>
                        Next →
                    </button>
                </div>
            </div>
            
            <!-- RIGHT: Detail Panel -->
            <div class="w-3/5 bg-white rounded-lg shadow-sm border border-warmgray-200 flex flex-col">
                
                <!-- Empty state for detail -->
                <div id="detailEmpty" class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-warmgray-300 mb-3">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div id="detailEmptyText" class="text-warmgray-400 font-medium">Select an employer to view details</div>
                    </div>
                </div>
                
                <!-- Detail content (hidden until selection) -->
                <div id="detailContent" class="flex-1 overflow-y-auto custom-scroll hidden">
                    <!-- Header -->
                    <div class="p-5 border-b border-warmgray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 id="detailName" class="headline text-2xl font-bold text-warmgray-900">Name</h2>
                                <p id="detailLocation" class="text-warmgray-500 mt-1">City, State ZIP</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <div id="detailBadges" class="flex gap-2">
                                    <span class="badge badge-private">Private</span>
                                </div>
                                <button onclick="printReport()" class="text-warmgray-400 hover:text-warmgray-600" title="Print Report">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key metrics (dynamic content) -->
                    <div class="p-5 border-b border-warmgray-200">
                        <div id="detailMetrics" class="grid grid-cols-3 gap-4">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Map -->
                    <div class="p-5 border-b border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Location</div>
                        <div id="detailMap" class="bg-warmgray-200 rounded-lg"></div>
                    </div>
                    
                    <!-- Filing/Financial details (dynamic content) -->
                    <div id="detailFilingSection" class="p-5 border-b border-warmgray-200">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Industry/Projections (dynamic content) -->
                    <div id="detailProjections" class="p-5 border-b border-warmgray-200">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Corporate Structure (employer only) -->
                    <div id="detailCorporateSection" class="p-5 border-b border-warmgray-200">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide">Corporate Family</div>
                            <span id="corporateLoadingBadge" class="text-xs text-warmgray-400 hidden">Loading...</span>
                        </div>
                        <div id="corporateContent">
                            <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                                Searching for related employers...
                            </div>
                        </div>
                    </div>
                    
                    <!-- OSHA Safety Record (employer only) -->
                    <div id="detailOshaSection" class="p-5 border-b border-warmgray-200">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide">Safety Record (OSHA)</div>
                            <span id="oshaLoadingBadge" class="text-xs text-warmgray-400 hidden">Loading...</span>
                        </div>
                        <div id="oshaContent">
                            <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                                Checking OSHA data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- NLRB Election History (employer only) -->
                    <div id="detailNlrbSection" class="p-5 border-b border-warmgray-200">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide">NLRB History</div>
                            <span id="nlrbLoadingBadge" class="text-xs text-warmgray-400 hidden">Loading...</span>
                        </div>
                        <div id="nlrbContent">
                            <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                                Checking NLRB records...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employers Covered (union only) -->
                    <div id="detailEmployersSection" class="p-5 border-b border-warmgray-200 hidden">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Financial Trends Chart (union only) -->
                    <div id="detailTrendsSection" class="p-5 border-b border-warmgray-200 hidden">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Membership & Financial Trends</div>
                        <canvas id="trendsChart" height="180"></canvas>
                    </div>
                    
                    <!-- Financial Details (union only) -->
                    <div id="detailFinancialsSection" class="p-5 border-b border-warmgray-200 hidden">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Sister Locals (union only) -->
                    <div id="detailSisterLocalsSection" class="p-5 border-b border-warmgray-200 hidden">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Geographic Distribution (union only) -->
                    <div id="detailGeoSection" class="p-5 border-b border-warmgray-200 hidden">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- News Mentions -->
                    <div id="detailNewsSection" class="p-5 border-b border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Recent News</div>
                        <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                            News monitoring coming soon
                        </div>
                    </div>
                    
                    <!-- Action Button -->
                    <div id="detailActionSection" class="p-5">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================ -->
    <!-- FIND SIMILAR MODAL -->
    <!-- ============================================ -->
    <div id="findSimilarModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="headline text-xl font-bold text-warmgray-900">Find Similar Employers</h3>
                    <p class="text-sm text-warmgray-500 mt-0.5">Non-union employers from OSHA data with safety violations</p>
                </div>
                <button onclick="closeFindSimilar()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal content - Form -->
            <div id="findSimilarForm" class="p-6 overflow-y-auto">
                <!-- Source employer reference -->
                <div class="bg-warmgray-100 rounded-lg p-4 mb-5">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Based on</div>
                    <div class="font-semibold text-warmgray-900" id="similarSourceName">Kaiser Permanente</div>
                    <div class="text-sm text-warmgray-500" id="similarSourceDetails">Healthcare · Oakland, CA · 58,420 workers</div>
                </div>
                
                <!-- Match criteria toggles -->
                <div class="mb-5">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Match Criteria</div>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="matchIndustry" checked class="rounded border-warmgray-300 text-warmgray-900 focus:ring-warmgray-500">
                            <span class="text-sm">Same industry (<span id="matchIndustryLabel">Healthcare - NAICS 62</span>)</span>
                        </label>
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="matchNonUnion" checked class="rounded border-warmgray-300 text-warmgray-900 focus:ring-warmgray-500">
                            <span class="text-sm font-medium text-accent-red">Non-union only (from OSHA data)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Geography override -->
                <div class="mb-5">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Geography</div>
                    <div class="flex gap-3">
                        <select id="similarGeoLevel" class="px-3 py-2 border border-warmgray-300 rounded-md text-sm flex-1">
                            <option value="city">Same City</option>
                            <option value="state" selected>Same State</option>
                            <option value="radius">Within Radius</option>
                        </select>
                        <input type="number" id="similarRadius" value="50" min="10" max="200"
                            class="px-3 py-2 border border-warmgray-300 rounded-md text-sm w-24 hidden" disabled>
                        <span id="similarRadiusLabel" class="text-sm text-warmgray-500 self-center hidden">miles</span>
                    </div>
                </div>
                
                <!-- Size filter -->
                <div class="mb-6">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Minimum Employees</div>
                    <select id="similarMinSize" class="px-3 py-2 border border-warmgray-300 rounded-md text-sm w-full">
                        <option value="0">Any size</option>
                        <option value="10" selected>10+ employees</option>
                        <option value="50">50+ employees</option>
                        <option value="100">100+ employees</option>
                        <option value="250">250+ employees</option>
                    </select>
                </div>
                
                <!-- Action buttons -->
                <div class="flex gap-3">
                    <button onclick="executeFindSimilar()" id="findSimilarBtn"
                        class="flex-1 py-3 bg-warmgray-900 text-white font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                        Find Similar Employers
                    </button>
                    <button onclick="closeFindSimilar()" 
                        class="px-6 py-3 border border-warmgray-300 text-warmgray-700 font-semibold rounded-lg hover:bg-warmgray-50 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- Modal content - Results (hidden initially) -->
            <div id="findSimilarResults" class="hidden flex-1 overflow-hidden flex flex-col">
                <!-- Results header -->
                <div class="px-6 py-3 bg-warmgray-50 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0">
                    <div>
                        <span class="font-semibold text-warmgray-900" id="similarResultsCount">47 potential targets found</span>
                        <span class="text-sm text-warmgray-500 ml-2" id="similarResultsSource">from OSHA data</span>
                    </div>
                    <button onclick="showFindSimilarForm()" class="text-sm text-accent-red hover:underline">
                        ← Modify Search
                    </button>
                </div>
                
                <!-- Results list -->
                <div class="overflow-y-auto flex-1 p-4" id="similarResultsList">
                    <!-- Results populated by JS -->
                </div>
            </div>
            
            <!-- Loading state -->
            <div id="findSimilarLoading" class="hidden p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-warmgray-900 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Searching OSHA establishments...</p>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- NATIONAL UNION DASHBOARD MODAL -->
    <!-- ============================================ -->
    <div id="nationalDashboardModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <div>
                    <h2 id="dashboardTitle" class="headline text-2xl font-bold text-warmgray-900">SEIU</h2>
                    <p class="text-sm text-warmgray-500">National Union Dashboard</p>
                </div>
                <button onclick="closeNationalDashboard()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Loading state -->
            <div id="dashboardLoading" class="p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-warmgray-900 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading dashboard data...</p>
            </div>
            
            <!-- Dashboard content -->
            <div id="dashboardContent" class="hidden flex-1 overflow-y-auto p-6">
                <!-- Summary cards -->
                <div class="grid grid-cols-5 gap-4 mb-6">
                    <div class="bg-warmgray-100 rounded-lg p-4 text-center">
                        <div id="dashLocalCount" class="text-3xl font-bold text-warmgray-900">0</div>
                        <div class="text-xs text-warmgray-500 uppercase tracking-wide">Locals</div>
                    </div>
                    <div class="bg-warmgray-100 rounded-lg p-4 text-center">
                        <div id="dashMemberCount" class="text-3xl font-bold text-accent-red">0</div>
                        <div class="text-xs text-warmgray-500 uppercase tracking-wide">Members</div>
                    </div>
                    <div class="bg-warmgray-100 rounded-lg p-4 text-center">
                        <div id="dashEmployerCount" class="text-3xl font-bold text-warmgray-900">0</div>
                        <div class="text-xs text-warmgray-500 uppercase tracking-wide">Employers</div>
                    </div>
                    <div class="bg-warmgray-100 rounded-lg p-4 text-center">
                        <div id="dashWorkerCount" class="text-3xl font-bold text-warmgray-900">0</div>
                        <div class="text-xs text-warmgray-500 uppercase tracking-wide">Workers Covered</div>
                    </div>
                    <div class="bg-warmgray-100 rounded-lg p-4 text-center">
                        <div id="dashStateCount" class="text-3xl font-bold text-warmgray-900">0</div>
                        <div class="text-xs text-warmgray-500 uppercase tracking-wide">States</div>
                    </div>
                </div>
                
                <!-- Trends badges -->
                <div id="dashTrends" class="mb-6 flex gap-4 hidden">
                    <span id="dashMemberTrend" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                    <span id="dashAssetTrend" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>
                
                <!-- Two column layout -->
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left column -->
                    <div class="space-y-6">
                        <!-- Financial trends chart -->
                        <div class="bg-white border border-warmgray-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Membership Trend</h3>
                            <canvas id="dashTrendsChart" height="200"></canvas>
                        </div>
                        
                        <!-- Top locals -->
                        <div class="bg-white border border-warmgray-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Largest Locals</h3>
                            <div id="dashTopLocals" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right column -->
                    <div class="space-y-6">
                        <!-- Geographic distribution -->
                        <div class="bg-white border border-warmgray-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Geographic Distribution</h3>
                            <div id="dashGeoDistribution" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Industry breakdown -->
                        <div class="bg-white border border-warmgray-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Industry Breakdown</h3>
                            <div id="dashIndustries" class="flex flex-wrap gap-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Top employers -->
                        <div class="bg-white border border-warmgray-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Largest Employers</h3>
                            <div id="dashTopEmployers" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="px-6 py-4 border-t border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <div id="dashSectors" class="flex gap-2">
                    <!-- Sector badges -->
                </div>
                <div class="flex gap-3">
                    <button id="searchLocalsBtn" onclick="searchLocalsForCurrentAffiliation()"
                        class="px-4 py-2 bg-warmgray-100 text-warmgray-700 font-semibold rounded-lg hover:bg-warmgray-200 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Search All Locals
                    </button>
                    <button onclick="closeNationalDashboard()"
                        class="px-6 py-2 bg-warmgray-900 text-white font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- NATIONAL UNIONS BROWSER MODAL -->
    <!-- ============================================ -->
    <div id="nationalBrowserModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900">National Unions</h2>
                    <p class="text-sm text-warmgray-500">Select a union to view its dashboard</p>
                </div>
                <button onclick="closeNationalBrowser()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Loading state -->
            <div id="browserLoading" class="p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-warmgray-900 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading national unions...</p>
            </div>
            
            <!-- Content -->
            <div id="browserContent" class="hidden flex-1 overflow-y-auto p-4">
                <div id="browserList" class="grid grid-cols-2 gap-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- COMPARISON MODAL -->
    <!-- ============================================ -->
    <div id="comparisonModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900">Compare</h2>
                    <p id="comparisonSubtitle" class="text-sm text-warmgray-500">Side-by-side comparison</p>
                </div>
                <button onclick="closeComparison()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Comparison content -->
            <div id="comparisonContent" class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Left item -->
                    <div id="compareLeft" class="border border-warmgray-200 rounded-lg p-4">
                        <div class="text-center text-warmgray-400 py-8">
                            <p>Select first item to compare</p>
                        </div>
                    </div>
                    <!-- Right item -->
                    <div id="compareRight" class="border border-warmgray-200 rounded-lg p-4">
                        <div class="text-center text-warmgray-400 py-8">
                            <p>Select second item to compare</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="px-6 py-4 border-t border-warmgray-200 flex justify-between items-center flex-shrink-0">
                <button onclick="clearComparison()" class="text-sm text-warmgray-500 hover:text-warmgray-700">
                    Clear comparison
                </button>
                <button onclick="closeComparison()" 
                    class="px-6 py-2 bg-warmgray-900 text-white font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ORGANIZING SCORECARD MODAL -->
    <!-- ============================================ -->
    <div id="scorecardModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-green-50 to-white">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Organizing Scorecard
                    </h2>
                    <p class="text-sm text-warmgray-500">Non-union establishments scored by organizing potential</p>
                </div>
                <button onclick="closeOrganizingScorecard()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Filters -->
            <div class="px-6 py-4 border-b border-warmgray-200 bg-warmgray-50">
                <div class="flex gap-4 items-end flex-wrap">
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Presets</label>
                        <button onclick="loadAFSCME_NY_Preset()"
                            class="px-3 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                            AFSCME NY
                        </button>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="scorecardState" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Industry</label>
                        <select id="scorecardIndustry" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Industries</option>
                            <option value="11">Agriculture</option>
                            <option value="21">Mining</option>
                            <option value="22">Utilities</option>
                            <option value="23">Construction</option>
                            <option value="31">Manufacturing</option>
                            <option value="42">Wholesale Trade</option>
                            <option value="44">Retail Trade</option>
                            <option value="48">Transportation</option>
                            <option value="51">Information</option>
                            <option value="52">Finance</option>
                            <option value="53">Real Estate</option>
                            <option value="54">Professional Services</option>
                            <option value="56">Admin & Waste Services</option>
                            <option value="61">Education</option>
                            <option value="62">Healthcare</option>
                            <option value="71">Arts & Entertainment</option>
                            <option value="72">Accommodation & Food</option>
                            <option value="81">Other Services</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Min Employees</label>
                        <input type="number" id="scorecardMinEmp" value="50" min="1" max="10000"
                            class="w-24 px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Max Employees</label>
                        <input type="number" id="scorecardMaxEmp" value="5000" min="1" max="100000"
                            class="w-24 px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Min Score</label>
                        <input type="number" id="scorecardMinScore" value="30" min="0" max="100"
                            class="w-20 px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Contracts</label>
                        <select id="scorecardContracts" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All</option>
                            <option value="true">Has Contracts</option>
                            <option value="false">No Contracts</option>
                        </select>
                    </div>
                    <button onclick="loadScorecardResults()"
                        class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>
            
            <!-- Loading state -->
            <div id="scorecardLoading" class="hidden p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-green-600 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Scoring establishments...</p>
            </div>
            
            <!-- Results -->
            <div id="scorecardContent" class="flex-1 overflow-hidden flex">
                <!-- Results list -->
                <div class="w-1/2 border-r border-warmgray-200 overflow-y-auto">
                    <div id="scorecardResultsInfo" class="px-4 py-2 bg-warmgray-50 text-sm text-warmgray-500 border-b border-warmgray-200">
                        Click "Search" to find organizing targets
                    </div>
                    <div id="scorecardResults" class="divide-y divide-warmgray-100">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Detail panel -->
                <div class="w-1/2 overflow-y-auto">
                    <div id="scorecardDetailEmpty" class="p-8 text-center text-warmgray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-warmgray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        <p>Select an establishment to view score breakdown</p>
                    </div>
                    <div id="scorecardDetail" class="hidden p-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="px-6 py-3 border-t border-warmgray-200 bg-warmgray-50 text-xs text-warmgray-500">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="font-semibold text-warmgray-700">Score Components:</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-red-500 mr-1"></span> Safety (0-25)</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-blue-500 mr-1"></span> Industry (0-15)</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-purple-500 mr-1"></span> Geographic (0-15)</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-yellow-500 mr-1"></span> Size (0-15)</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-green-500 mr-1"></span> NLRB (0-15)</span>
                    <span><span class="inline-block w-3 h-3 rounded bg-orange-500 mr-1"></span> Govt Contracts (0-15)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ANALYTICS DASHBOARD MODAL -->
    <!-- ============================================ -->
    <div id="analyticsDashboardModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-cream rounded-xl shadow-2xl w-full max-w-7xl min-h-[90vh] m-4">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 bg-warmgray-900 text-white rounded-t-xl px-6 py-4 flex justify-between items-center">
                <div>
                    <h2 class="headline text-xl font-bold flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Analytics Dashboard
                    </h2>
                    <p class="text-warmgray-400 text-sm">Platform-wide metrics and trends</p>
                </div>
                <button onclick="closeAnalyticsDashboard()" class="text-warmgray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Loading state -->
            <div id="dashboardLoading" class="p-12 text-center">
                <div class="inline-block w-10 h-10 border-4 border-warmgray-300 border-t-warmgray-900 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading dashboard data...</p>
            </div>
            
            <!-- Dashboard content -->
            <div id="dashboardContent" class="hidden p-6">
                <!-- Summary Cards Row -->
                <div class="grid grid-cols-6 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Total Unions</div>
                        <div id="dashUnions" class="text-2xl font-bold text-warmgray-900 mt-1">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Members</div>
                        <div id="dashMembers" class="text-2xl font-bold text-accent-red mt-1">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Employers</div>
                        <div id="dashEmployers" class="text-2xl font-bold text-warmgray-900 mt-1">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Workers Covered</div>
                        <div id="dashWorkers" class="text-2xl font-bold text-warmgray-900 mt-1">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">OSHA Establishments</div>
                        <div id="dashOsha" class="text-2xl font-bold text-warmgray-900 mt-1">-</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">NLRB Cases (1yr)</div>
                        <div id="dashNlrb" class="text-2xl font-bold text-warmgray-900 mt-1">-</div>
                        <div id="dashNlrbWins" class="text-xs text-green-600 mt-1"></div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- Membership Trends Chart -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Membership Trends</h3>
                        <div class="h-64">
                            <canvas id="membershipChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- NLRB Elections Chart -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">NLRB Elections by Year</h3>
                        <div class="h-64">
                            <canvas id="nlrbChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Second Charts Row -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <!-- F-7 Filings Chart -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Bargaining Notices (F-7 Filings)</h3>
                        <div class="h-64">
                            <canvas id="f7Chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- OSHA Violations Chart -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">OSHA Violations by Year</h3>
                        <div class="h-64">
                            <canvas id="oshaChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Section: NLRB Activity + Growth Tables -->
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <!-- Recent NLRB Elections -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Recent NLRB Elections</h3>
                        <div id="recentNlrb" class="space-y-2 max-h-72 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Top Growing Unions -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            Growing Unions (YoY)
                        </h3>
                        <div id="growingUnions" class="space-y-2 max-h-72 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Top Declining Unions -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            Declining Unions (YoY)
                        </h3>
                        <div id="decliningUnions" class="space-y-2 max-h-72 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Geographic + Top Lists -->
                <div class="grid grid-cols-3 gap-6">
                    <!-- Top States by Union Membership -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Top States by Membership</h3>
                        <div id="topStates" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Top Affiliations -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Top National Unions</h3>
                        <div id="topAffiliations" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Top Industries -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-4">Top Industries</h3>
                        <div id="topIndustries" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- CORPORATE FAMILY MODAL -->
    <!-- ============================================ -->
    <div id="corporateFamilyModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-cream rounded-xl shadow-2xl w-full max-w-6xl min-h-[85vh] m-4">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 bg-gradient-to-r from-warmgray-800 to-warmgray-700 text-white rounded-t-xl px-6 py-4 flex justify-between items-center">
                <div>
                    <h2 class="headline text-xl font-bold flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span id="corporateFamilyTitle">Corporate Family</span>
                    </h2>
                    <p class="text-warmgray-300 text-sm" id="corporateFamilySubtitle">Related employers and locations</p>
                </div>
                <button onclick="closeCorporateFamily()" class="text-warmgray-300 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Loading state -->
            <div id="corporateFamilyLoading" class="p-12 text-center">
                <div class="inline-block w-10 h-10 border-4 border-warmgray-300 border-t-warmgray-900 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Analyzing corporate relationships...</p>
            </div>
            
            <!-- Content -->
            <div id="corporateFamilyContent" class="hidden p-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Total Locations</div>
                        <div id="cfLocations" class="text-3xl font-bold text-warmgray-900 mt-1">—</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Total Workers</div>
                        <div id="cfWorkers" class="text-3xl font-bold text-accent-red mt-1">—</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">States</div>
                        <div id="cfStates" class="text-3xl font-bold text-warmgray-900 mt-1">—</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Unions</div>
                        <div id="cfUnions" class="text-3xl font-bold text-warmgray-900 mt-1">—</div>
                    </div>
                </div>
                
                <!-- Main content grid -->
                <div class="grid grid-cols-3 gap-6">
                    <!-- Left: Location list -->
                    <div class="col-span-2">
                        <div class="bg-white rounded-lg shadow-sm border border-warmgray-200">
                            <div class="px-4 py-3 border-b border-warmgray-200 flex justify-between items-center">
                                <h3 class="text-sm font-semibold text-warmgray-700 uppercase">All Locations</h3>
                                <span id="cfLocationCount" class="text-xs text-warmgray-500"></span>
                            </div>
                            <div id="cfLocationList" class="divide-y divide-warmgray-100 max-h-96 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Map -->
                        <div class="mt-4 bg-white rounded-lg shadow-sm border border-warmgray-200 p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-3">Location Map</h3>
                            <div id="corporateFamilyMap" class="h-64 rounded-lg bg-warmgray-100"></div>
                        </div>
                    </div>
                    
                    <!-- Right: Breakdowns -->
                    <div class="space-y-4">
                        <!-- By State -->
                        <div class="bg-white rounded-lg shadow-sm border border-warmgray-200 p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-3">By State</h3>
                            <div id="cfByState" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- By Union -->
                        <div class="bg-white rounded-lg shadow-sm border border-warmgray-200 p-4">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-3">By Union</h3>
                            <div id="cfByUnion" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Matching Info -->
                        <div class="bg-warmgray-100 rounded-lg p-4">
                            <h3 class="text-xs font-semibold text-warmgray-500 uppercase mb-2">Matching Method</h3>
                            <p class="text-sm text-warmgray-600">
                                <span class="font-medium">Root Name:</span> 
                                <span id="cfRootName" class="font-mono text-xs bg-warmgray-200 px-2 py-0.5 rounded">—</span>
                            </p>
                            <p class="text-xs text-warmgray-400 mt-2">
                                Employers matched by normalized company name. May include subsidiaries, divisions, and multiple locations.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- UNIFIED EMPLOYERS MODAL -->
    <!-- ============================================ -->
    <div id="unifiedEmployersModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-purple-50 to-white">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        All Employers
                    </h2>
                    <p class="text-sm text-warmgray-500">Unified employer database from all sources</p>
                </div>
                <button onclick="closeUnifiedEmployersModal()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Filters -->
            <div class="px-6 py-4 border-b border-warmgray-200 bg-warmgray-50">
                <div class="flex gap-4 items-end flex-wrap">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Name Search</label>
                        <input type="text" id="unifiedNameSearch" placeholder="Search by employer name..."
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="unifiedState" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Source</label>
                        <select id="unifiedSource" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Sources</option>
                            <option value="F7">F-7 (Private Sector CBAs)</option>
                            <option value="NLRB">NLRB (Election Participants)</option>
                            <option value="VR">VR (Voluntary Recognition)</option>
                            <option value="PUBLIC">Public Sector</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Has Union</label>
                        <select id="unifiedHasUnion" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">Any</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Has OSHA</label>
                        <select id="unifiedHasOsha" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">Any</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <button onclick="loadUnifiedEmployers()"
                        class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>

            <!-- Loading state -->
            <div id="unifiedLoading" class="hidden p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-purple-600 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading employers...</p>
            </div>

            <!-- Results -->
            <div id="unifiedContent" class="flex-1 overflow-hidden flex">
                <!-- Results list -->
                <div class="w-1/2 border-r border-warmgray-200 overflow-y-auto">
                    <div id="unifiedResultsInfo" class="px-4 py-2 bg-warmgray-50 text-sm text-warmgray-500 border-b border-warmgray-200">
                        Click "Search" to find employers
                    </div>
                    <div id="unifiedResults" class="divide-y divide-warmgray-100">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Detail panel -->
                <div class="w-1/2 overflow-y-auto">
                    <div id="unifiedDetailEmpty" class="p-8 text-center text-warmgray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-warmgray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <p>Select an employer to view details</p>
                    </div>
                    <div id="unifiedDetail" class="hidden p-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="px-6 py-3 border-t border-warmgray-200 bg-warmgray-50 text-xs text-warmgray-500">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="font-semibold text-warmgray-700">Sources:</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-700 mr-1">F7</span> Private sector CBAs</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700 mr-1">NLRB</span> Election participants</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700 mr-1">VR</span> Voluntary recognition</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-orange-100 text-orange-700 mr-1">PUBLIC</span> Public sector</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- NLRB ELECTIONS MODAL -->
    <!-- ============================================ -->
    <div id="electionsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-blue-50 to-white">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        NLRB Elections
                    </h2>
                    <p class="text-sm text-warmgray-500">Union representation elections from NLRB</p>
                </div>
                <button onclick="closeElectionsModal()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Filters -->
            <div class="px-6 py-4 border-b border-warmgray-200 bg-warmgray-50">
                <div class="flex gap-4 items-end flex-wrap">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Employer Name</label>
                        <input type="text" id="electionsEmployerSearch" placeholder="Search by employer name..."
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="electionsState" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Year</label>
                        <select id="electionsYear" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Years</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Result</label>
                        <select id="electionsResult" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Results</option>
                            <option value="won">Union Won</option>
                            <option value="lost">Union Lost</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Min Voters</label>
                        <input type="number" id="electionsMinVoters" value="" min="1" placeholder="Any"
                            class="w-20 px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="electionsExcludeLawFirms" checked
                            class="w-4 h-4 rounded border-warmgray-300 text-blue-600 focus:ring-blue-500">
                        <label for="electionsExcludeLawFirms" class="text-xs text-warmgray-600">Exclude law firms</label>
                    </div>
                    <button onclick="loadElections()"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>

            <!-- Loading state -->
            <div id="electionsLoading" class="hidden p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading elections...</p>
            </div>

            <!-- Results -->
            <div id="electionsContent" class="flex-1 overflow-hidden flex">
                <!-- Results list -->
                <div class="w-1/2 border-r border-warmgray-200 overflow-y-auto">
                    <div id="electionsResultsInfo" class="px-4 py-2 bg-warmgray-50 text-sm text-warmgray-500 border-b border-warmgray-200">
                        Click "Search" to find elections
                    </div>
                    <div id="electionsResults" class="divide-y divide-warmgray-100">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Detail panel -->
                <div class="w-1/2 overflow-y-auto">
                    <div id="electionsDetailEmpty" class="p-8 text-center text-warmgray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-warmgray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <p>Select an election to view details</p>
                    </div>
                    <div id="electionsDetail" class="hidden p-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="px-6 py-3 border-t border-warmgray-200 bg-warmgray-50 text-xs text-warmgray-500">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="font-semibold text-warmgray-700">Results:</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700 mr-1">WON</span> Union certified</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700 mr-1">LOST</span> Union not certified</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-700 mr-1">PENDING</span> In progress</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PUBLIC SECTOR MODAL -->
    <!-- ============================================ -->
    <div id="publicSectorModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col m-4">
            <!-- Modal header -->
            <div class="px-6 py-4 border-b border-warmgray-200 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-orange-50 to-white">
                <div>
                    <h2 class="headline text-xl font-bold text-warmgray-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                        </svg>
                        Public Sector
                    </h2>
                    <p class="text-sm text-warmgray-500">Public sector unions and employers</p>
                </div>
                <button onclick="closePublicSectorModal()" class="text-warmgray-400 hover:text-warmgray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Sub-view toggle -->
            <div class="px-6 py-3 border-b border-warmgray-200 bg-warmgray-50">
                <div class="inline-flex gap-1 p-1 bg-warmgray-200 rounded-full">
                    <button id="psLocalsTab" onclick="setPublicSectorView('locals')"
                        class="px-4 py-1.5 text-sm font-semibold rounded-full transition-all bg-warmgray-900 text-white">
                        Union Locals
                    </button>
                    <button id="psEmployersTab" onclick="setPublicSectorView('employers')"
                        class="px-4 py-1.5 text-sm font-semibold rounded-full transition-all text-warmgray-600 hover:text-warmgray-800">
                        Employers
                    </button>
                </div>
            </div>

            <!-- Filters for Locals -->
            <div id="psLocalsFilters" class="px-6 py-4 border-b border-warmgray-200 bg-white">
                <div class="flex gap-4 items-end flex-wrap">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Name Search</label>
                        <input type="text" id="psLocalsNameSearch" placeholder="Search union locals..."
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="psLocalsState" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Parent Union</label>
                        <select id="psLocalsParent" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Unions</option>
                        </select>
                    </div>
                    <button onclick="loadPublicSectorLocals()"
                        class="px-6 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>

            <!-- Filters for Employers (hidden by default) -->
            <div id="psEmployersFilters" class="px-6 py-4 border-b border-warmgray-200 bg-white hidden">
                <div class="flex gap-4 items-end flex-wrap">
                    <div class="flex-1 min-w-48">
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Name Search</label>
                        <input type="text" id="psEmployersNameSearch" placeholder="Search employers..."
                            class="w-full px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">State</label>
                        <select id="psEmployersState" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Employer Type</label>
                        <select id="psEmployersType" class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <button onclick="loadPublicSectorEmployers()"
                        class="px-6 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition-colors">
                        Search
                    </button>
                </div>
            </div>

            <!-- Loading state -->
            <div id="publicSectorLoading" class="hidden p-12 text-center">
                <div class="inline-block w-8 h-8 border-4 border-warmgray-300 border-t-orange-600 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading...</p>
            </div>

            <!-- Results -->
            <div id="publicSectorContent" class="flex-1 overflow-hidden flex">
                <!-- Results list -->
                <div class="w-1/2 border-r border-warmgray-200 overflow-y-auto">
                    <div id="publicSectorResultsInfo" class="px-4 py-2 bg-warmgray-50 text-sm text-warmgray-500 border-b border-warmgray-200">
                        Click "Search" to browse public sector data
                    </div>
                    <div id="publicSectorResults" class="divide-y divide-warmgray-100">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Detail panel -->
                <div class="w-1/2 overflow-y-auto">
                    <div id="publicSectorDetailEmpty" class="p-8 text-center text-warmgray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-warmgray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                        </svg>
                        <p>Select an item to view details</p>
                    </div>
                    <div id="publicSectorDetail" class="hidden p-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="px-6 py-3 border-t border-warmgray-200 bg-warmgray-50 text-xs text-warmgray-500">
                <div class="flex items-center gap-4 flex-wrap">
                    <span class="font-semibold text-warmgray-700">Employer Types:</span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-700 mr-1">FEDERAL</span></span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700 mr-1">STATE</span></span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-orange-100 text-orange-700 mr-1">COUNTY</span></span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700 mr-1">CITY</span></span>
                    <span><span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-700 mr-1">SCHOOL</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- TRENDS DASHBOARD MODAL -->
    <!-- ============================================ -->
    <div id="trendsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-cream rounded-xl shadow-2xl w-full max-w-7xl min-h-[85vh] m-4">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 bg-gradient-to-r from-emerald-700 to-emerald-600 text-white rounded-t-xl px-6 py-4 flex justify-between items-center">
                <div>
                    <h2 class="headline text-xl font-bold flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                        </svg>
                        Trends & Analytics
                    </h2>
                    <p class="text-emerald-200 text-sm">Historical membership and election trends (2010-2024)</p>
                </div>
                <button onclick="closeTrendsModal()" class="text-emerald-200 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Sub-tabs -->
            <div class="bg-white border-b border-warmgray-200 px-6 py-3">
                <div class="flex gap-2">
                    <button id="trendsTabOverview" onclick="setTrendsTab('overview')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg bg-emerald-100 text-emerald-700">
                        Overview
                    </button>
                    <button id="trendsTabMembership" onclick="setTrendsTab('membership')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg text-warmgray-600 hover:bg-warmgray-100">
                        Membership Trends
                    </button>
                    <button id="trendsTabElections" onclick="setTrendsTab('elections')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg text-warmgray-600 hover:bg-warmgray-100">
                        Election Trends
                    </button>
                    <button id="trendsTabByState" onclick="setTrendsTab('byState')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg text-warmgray-600 hover:bg-warmgray-100">
                        By State
                    </button>
                    <button id="trendsTabByAffiliation" onclick="setTrendsTab('byAffiliation')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg text-warmgray-600 hover:bg-warmgray-100">
                        By Affiliation
                    </button>
                </div>
            </div>

            <!-- Loading state -->
            <div id="trendsLoading" class="p-12 text-center">
                <div class="inline-block w-10 h-10 border-4 border-warmgray-300 border-t-emerald-600 rounded-full animate-spin mb-4"></div>
                <p class="text-warmgray-600">Loading trends data...</p>
            </div>

            <!-- Content panels -->
            <div id="trendsContent" class="hidden p-6">
                <!-- Overview Panel -->
                <div id="trendsPanelOverview">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase">Total Members (2024)</div>
                            <div id="trendsMembers2024" class="text-2xl font-bold text-warmgray-900 mt-1">—</div>
                            <div id="trendsMembersChange" class="text-sm text-warmgray-500 mt-1"></div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase">Avg Annual Change</div>
                            <div id="trendsAvgChange" class="text-2xl font-bold text-warmgray-900 mt-1">—</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase">Election Win Rate</div>
                            <div id="trendsWinRate" class="text-2xl font-bold text-emerald-600 mt-1">—</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <div class="text-xs font-semibold text-warmgray-500 uppercase">Elections (2024)</div>
                            <div id="trendsElections2024" class="text-2xl font-bold text-warmgray-900 mt-1">—</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">Membership Over Time</h3>
                            <div class="h-64">
                                <canvas id="trendsOverviewChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">Election Outcomes</h3>
                            <div class="h-64">
                                <canvas id="trendsElectionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Membership Panel -->
                <div id="trendsPanelMembership" class="hidden">
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200 mb-6">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">National Membership (2010-2024)</h3>
                        <div class="h-80">
                            <canvas id="trendsMembershipChart"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Top Growing Affiliations</h4>
                            <div id="trendsTopGrowing" class="space-y-2 text-sm"></div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Declining Affiliations</h4>
                            <div id="trendsDeclining" class="space-y-2 text-sm"></div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Sector Breakdown</h4>
                            <div id="trendsSectors" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Elections Panel -->
                <div id="trendsPanelElections" class="hidden">
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200 mb-6">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">Election Outcomes by Year</h3>
                        <div class="h-80">
                            <canvas id="trendsElectionsByYearChart"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Win Rate by Year</h4>
                            <div id="trendsWinRateByYear" class="space-y-2 text-sm max-h-48 overflow-y-auto"></div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Elections by State (Top 10)</h4>
                            <div id="trendsElectionsByState" class="space-y-2 text-sm max-h-48 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- By State Panel -->
                <div id="trendsPanelByState" class="hidden">
                    <div class="mb-4 flex gap-4 items-end">
                        <div>
                            <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Select State</label>
                            <select id="trendsStateSelect" onchange="loadStateTrends()"
                                class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                                <option value="">Choose a state...</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200 mb-6">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">State Membership Trend</h3>
                        <div class="h-80">
                            <canvas id="trendsStateChart"></canvas>
                        </div>
                    </div>
                    <div id="trendsStateInfo" class="grid grid-cols-3 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- By Affiliation Panel -->
                <div id="trendsPanelByAffiliation" class="hidden">
                    <div class="mb-4 flex gap-4 items-end">
                        <div>
                            <label class="block text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Select Affiliation</label>
                            <select id="trendsAffiliationSelect" onchange="loadAffiliationTrends()"
                                class="px-3 py-2 border border-warmgray-300 rounded-lg text-sm">
                                <option value="">Choose an affiliation...</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200 mb-6">
                        <h3 class="text-sm font-semibold text-warmgray-700 uppercase mb-4">Affiliation Membership Trend</h3>
                        <div class="h-80">
                            <canvas id="trendsAffiliationChart"></canvas>
                        </div>
                    </div>
                    <div id="trendsAffiliationInfo" class="grid grid-cols-3 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE
        // ==========================================
        const API_BASE = 'http://localhost:8001/api';
        
        let currentMode = 'employers'; // 'employers' or 'unions'
        let currentResults = [];
        let selectedItem = null;
        let currentPage = 1;
        let totalPages = 1;
        let detailMap = null;
        let detailMarker = null;
        
        // Map view state
        let currentView = 'list'; // 'list' or 'map'
        let fullMap = null;
        let markerClusterGroup = null;
        let mapMarkers = new Map(); // id -> marker
        
        // Comparison state
        let comparisonItems = [null, null]; // [leftItem, rightItem]
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            setupTypeahead();
            setupGeoChangeListeners();
            setupKeyboardShortcuts();

            // Sort dropdown triggers search
            document.getElementById('sortBy').addEventListener('change', () => executeSearch());
            
            // Check for URL params before loading
            const hasUrlParams = parseUrlAndSearch();
            
            // Load initial data
            await Promise.all([
                loadStates(),
                loadHeaderStats()
            ]);
            
            // Apply any pending URL params after data loads
            if (hasUrlParams) {
                await applyPendingUrlParams();
            }

            // Debug: Check if modal functions are defined
            console.log('=== MODAL FUNCTIONS CHECK ===');
            console.log('openUnifiedEmployersModal:', typeof openUnifiedEmployersModal);
            console.log('openElectionsModal:', typeof openElectionsModal);
            console.log('openPublicSectorModal:', typeof openPublicSectorModal);
            console.log('openTrendsModal:', typeof openTrendsModal);
            console.log('API_BASE:', API_BASE);
        });

        async function runDebugCheck() {
            const output = document.getElementById('debugOutput');
            output.classList.remove('hidden');

            let html = '<h3 class="font-bold mb-2">Debug Check</h3>';

            // Check functions
            html += '<div class="mb-2"><strong>Modal Functions:</strong></div>';
            html += `<div>openUnifiedEmployersModal: ${typeof openUnifiedEmployersModal}</div>`;
            html += `<div>openElectionsModal: ${typeof openElectionsModal}</div>`;
            html += `<div>openPublicSectorModal: ${typeof openPublicSectorModal}</div>`;
            html += `<div>openTrendsModal: ${typeof openTrendsModal}</div>`;

            // Check API_BASE
            html += `<div class="mt-2"><strong>API_BASE:</strong> ${API_BASE}</div>`;

            // Check main state filter
            const stateFilter = document.getElementById('stateFilter');
            html += `<div><strong>State Filter Options:</strong> ${stateFilter ? stateFilter.options.length : 'NOT FOUND'}</div>`;

            // Test API
            html += '<div class="mt-2"><strong>API Tests:</strong></div>';
            try {
                const r1 = await fetch(`${API_BASE}/health`);
                const d1 = await r1.json();
                html += `<div style="color:green">✓ Health: ${d1.status}</div>`;
            } catch(e) {
                html += `<div style="color:red">✗ Health: ${e.message}</div>`;
            }

            try {
                const r2 = await fetch(`${API_BASE}/employers/unified/search?limit=2`);
                const d2 = await r2.json();
                html += `<div style="color:green">✓ Unified: ${d2.total} total</div>`;
            } catch(e) {
                html += `<div style="color:red">✗ Unified: ${e.message}</div>`;
            }

            try {
                const r3 = await fetch(`${API_BASE}/nlrb/elections/search?limit=2`);
                const d3 = await r3.json();
                html += `<div style="color:green">✓ Elections: ${d3.total} total</div>`;
            } catch(e) {
                html += `<div style="color:red">✗ Elections: ${e.message}</div>`;
            }

            // Check modal elements
            html += '<div class="mt-2"><strong>Modal Elements:</strong></div>';
            html += `<div>unifiedEmployersModal: ${document.getElementById('unifiedEmployersModal') ? 'EXISTS' : 'MISSING'}</div>`;
            html += `<div>electionsModal: ${document.getElementById('electionsModal') ? 'EXISTS' : 'MISSING'}</div>`;
            html += `<div>publicSectorModal: ${document.getElementById('publicSectorModal') ? 'EXISTS' : 'MISSING'}</div>`;
            html += `<div>trendsModal: ${document.getElementById('trendsModal') ? 'EXISTS' : 'MISSING'}</div>`;

            output.innerHTML = html;
        }

        function initMap() {
            detailMap = L.map('detailMap').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(detailMap);
        }
        
        function initFullMap() {
            if (fullMap) return; // Already initialized
            
            fullMap = L.map('fullMapContainer').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(fullMap);
            
            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 100) size = 'large';
                    else if (count > 10) size = 'medium';
                    
                    return L.divIcon({
                        html: `<div><span>${count}</span></div>`,
                        className: `marker-cluster marker-cluster-${size}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            fullMap.addLayer(markerClusterGroup);
        }
        
        function setView(view) {
            currentView = view;
            
            // Update toggle buttons
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('mapViewBtn').classList.toggle('active', view === 'map');
            
            // Show/hide containers
            document.getElementById('listViewContainer').classList.toggle('hidden', view === 'map');
            document.getElementById('mapViewContainer').classList.toggle('hidden', view === 'list');
            
            if (view === 'map') {
                initFullMap();
                // Need to invalidate size after container becomes visible
                // Using 250ms delay for modal transitions
                setTimeout(() => {
                    fullMap.invalidateSize();
                    updateMapMarkers();
                }, 250);
            }
        }
        
        function updateMapMarkers() {
            if (!fullMap || !markerClusterGroup) return;
            
            // Clear existing markers
            markerClusterGroup.clearLayers();
            mapMarkers.clear();
            
            // Count mappable items
            let mappable = 0;
            
            // Add markers for all results with coordinates
            currentResults.forEach(item => {
                if (!item.latitude || !item.longitude) return;
                mappable++;
                
                const id = currentMode === 'employers' ? item.employer_id : item.f_num;
                const name = currentMode === 'employers' ? item.employer_name : formatUnionName(item);
                const workers = currentMode === 'employers' 
                    ? (item.latest_unit_size || 0) 
                    : (item.members || 0);
                
                // Create custom icon based on size
                const iconSize = workers > 1000 ? 12 : (workers > 100 ? 10 : 8);
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: ${iconSize}px; 
                        height: ${iconSize}px; 
                        background: #8B4513; 
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [iconSize, iconSize],
                    iconAnchor: [iconSize/2, iconSize/2]
                });
                
                const marker = L.marker([item.latitude, item.longitude], { icon });
                
                // Popup content
                const popupContent = `
                    <div style="min-width: 180px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(name)}</div>
                        <div style="color: #666; font-size: 12px;">${item.city || ''}, ${item.state || ''}</div>
                        <div style="margin-top: 6px; font-size: 13px;">
                            <strong>${formatNumber(workers)}</strong> ${currentMode === 'employers' ? 'workers' : 'members'}
                        </div>
                        <button onclick="selectFromMap('${id}')" style="
                            margin-top: 8px;
                            color: #8B4513;
                            font-size: 12px;
                            font-weight: 500;
                            cursor: pointer;
                            background: none;
                            border: none;
                            padding: 0;
                        ">View details →</button>
                    </div>
                `;
                marker.bindPopup(popupContent);
                
                // Click handler
                marker.on('click', () => {
                    showMapSelection(item);
                });
                
                markerClusterGroup.addLayer(marker);
                mapMarkers.set(String(id), marker);
            });
            
            // Update mappable count display
            const countEl = document.getElementById('mappableCount');
            if (mappable < currentResults.length) {
                countEl.textContent = `(${mappable} with coordinates)`;
            } else {
                countEl.textContent = '';
            }
            
            // Fit bounds if we have markers
            if (mappable > 0) {
                const bounds = markerClusterGroup.getBounds();
                fullMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
            }
        }
        
        function showMapSelection(item) {
            const panel = document.getElementById('mapSelectionPanel');
            panel.classList.remove('hidden');
            
            const id = currentMode === 'employers' ? item.employer_id : item.f_num;
            const name = currentMode === 'employers' ? item.employer_name : formatUnionName(item);
            
            document.getElementById('mapSelectedName').textContent = name;
            document.getElementById('mapSelectedLocation').textContent = 
                `${item.city || 'Unknown'}, ${item.state || ''}`;
            
            // Badges
            const sector = item.union_sector || item.sector;
            const sectorClass = getSectorBadgeClass(sector);
            document.getElementById('mapSelectedBadges').innerHTML = `
                <span class="badge ${sectorClass}">${formatSectorName(sector)}</span>
            `;
            
            // Stats
            if (currentMode === 'employers') {
                document.getElementById('mapSelectedStats').innerHTML = `
                    <span class="text-warmgray-600"><strong>${formatNumber(item.latest_unit_size || 0)}</strong> workers</span>
                    <span class="text-warmgray-400 mx-2">•</span>
                    <span class="text-warmgray-600">${escapeHtml(item.aff_abbr || item.latest_union_name || 'Unknown union')}</span>
                `;
            } else {
                document.getElementById('mapSelectedStats').innerHTML = `
                    <span class="text-warmgray-600"><strong>${formatNumber(item.members || 0)}</strong> members</span>
                    <span class="text-warmgray-400 mx-2">•</span>
                    <span class="text-warmgray-600">${formatNumber(item.f7_employer_count || 0)} employers</span>
                `;
            }
            
            // View detail button
            document.getElementById('mapViewDetailBtn').onclick = () => {
                setView('list');
                selectItem(id);
            };
        }
        
        function selectFromMap(id) {
            // Switch to list view and select item
            setView('list');
            selectItem(id);
        }
        
        function setupKeyboardShortcuts() {
            // Enter to search in main input
            document.getElementById('mainSearch').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    currentPage = 1;
                    executeSearch();
                }
            });
            
            // Enter to search in industry input (when dropdown closed)
            document.getElementById('industrySearch').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !document.getElementById('industryTypeahead').classList.contains('open')) {
                    e.preventDefault();
                    currentPage = 1;
                    executeSearch();
                }
            });
        }
        
        // ==========================================
        // LOAD INITIAL DATA
        // ==========================================
        async function loadStates() {
            try {
                const response = await fetch(`${API_BASE}/lookups/states`);
                const data = await response.json();
                const stateSelect = document.getElementById('stateFilter');
                
                // Clear existing options except "All States"
                stateSelect.innerHTML = '<option value="">All States</option>';
                
                // Sort by state abbreviation
                const states = data.states.sort((a, b) => a.state.localeCompare(b.state));
                
                states.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.state;
                    option.textContent = `${s.state} (${formatNumber(s.employer_count)})`;
                    stateSelect.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load states:', e);
            }
        }
        
        async function loadHeaderStats() {
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const data = await response.json();

                document.getElementById('headerWorkers').textContent = formatNumber(data.employers?.covered_workers || 0);
                document.getElementById('headerEmployers').textContent = formatNumber(data.employers?.total_employers || 0);
                document.getElementById('headerUnions').textContent = formatNumber(data.unions?.total_unions || 0);
            } catch (e) {
                console.error('Failed to load header stats:', e);
            }
        }
        
        // ==========================================
        // SEARCH MODE TOGGLE
        // ==========================================
        function setSearchMode(mode) {
            currentMode = mode;
            
            // Update tab styles
            document.getElementById('tabEmployers').className = mode === 'employers' 
                ? 'tab-active px-6 py-2 text-sm font-semibold rounded-full transition-all'
                : 'tab-inactive px-6 py-2 text-sm font-semibold rounded-full transition-all hover:text-warmgray-700';
            document.getElementById('tabUnions').className = mode === 'unions'
                ? 'tab-active px-6 py-2 text-sm font-semibold rounded-full transition-all'
                : 'tab-inactive px-6 py-2 text-sm font-semibold rounded-full transition-all hover:text-warmgray-700';
            
            // Update placeholder text
            document.getElementById('mainSearch').placeholder = mode === 'employers' 
                ? 'Search by employer name...'
                : 'Search by union name...';
            
            // Update empty state text
            document.getElementById('emptyStateTitle').textContent = mode === 'employers'
                ? 'Search for employers'
                : 'Search for unions';
            document.getElementById('emptyStateSubtitle').textContent = mode === 'employers'
                ? 'Find organized workplaces by name, industry, or location'
                : 'Find union locals by name, affiliation, or location';
            
            // Update detail empty state
            document.getElementById('detailEmptyText').textContent = mode === 'employers'
                ? 'Select an employer to view details'
                : 'Select a union to view details';
            
            // Clear results
            clearResults();
        }
        
        // ==========================================
        // FILTER OPTIONS LOADING
        // ==========================================
        
        // ==========================================
        // GEOGRAPHIC CASCADE
        // ==========================================
        function setupGeoChangeListeners() {
            document.getElementById('similarGeoLevel').addEventListener('change', (e) => {
                const radiusInput = document.getElementById('similarRadius');
                const radiusLabel = document.getElementById('similarRadiusLabel');
                if (e.target.value === 'radius') {
                    radiusInput.classList.remove('hidden');
                    radiusInput.disabled = false;
                    radiusLabel.classList.remove('hidden');
                } else {
                    radiusInput.classList.add('hidden');
                    radiusInput.disabled = true;
                    radiusLabel.classList.add('hidden');
                }
            });
        }
        
        function openFindSimilar(employer) {
            selectedItem = employer;
            
            // Populate source info
            document.getElementById('similarSourceName').textContent = employer.employer_name || 'Unknown';
            const naicsLabel = employer.naics_sector_name || `NAICS ${employer.naics?.substring(0,2) || 'N/A'}`;
            const location = [employer.city, employer.state].filter(Boolean).join(', ') || 'Unknown Location';
            const workers = employer.latest_unit_size ? formatNumber(employer.latest_unit_size) + ' workers' : '';
            document.getElementById('similarSourceDetails').textContent = [naicsLabel, location, workers].filter(Boolean).join(' · ');
            document.getElementById('matchIndustryLabel').textContent = naicsLabel;
            
            // Reset to form view
            showFindSimilarForm();
            
            // Show modal
            document.getElementById('findSimilarModal').classList.remove('hidden');
            document.getElementById('findSimilarModal').classList.add('flex');
        }
        
        function closeFindSimilar() {
            document.getElementById('findSimilarModal').classList.add('hidden');
            document.getElementById('findSimilarModal').classList.remove('flex');
        }
        
        // ==========================================
        // NATIONAL UNION DASHBOARD
        // ==========================================
        let dashboardChart = null;
        
        async function openNationalDashboard(affAbbr) {
            currentDashboardAffiliation = affAbbr;
            document.getElementById('nationalDashboardModal').classList.remove('hidden');
            document.getElementById('nationalDashboardModal').classList.add('flex');
            document.body.classList.add('modal-open');
            document.getElementById('dashboardTitle').textContent = affAbbr;
            document.getElementById('dashboardLoading').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/unions/national/${encodeURIComponent(affAbbr)}`);
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                renderNationalDashboard(data);
            } catch (e) {
                console.error('Failed to load national dashboard:', e);
                document.getElementById('dashboardLoading').innerHTML = `
                    <div class="text-red-600">Failed to load dashboard data</div>
                `;
            }
        }
        
        function closeNationalDashboard() {
            document.getElementById('nationalDashboardModal').classList.add('hidden');
            document.getElementById('nationalDashboardModal').classList.remove('flex');
            document.body.classList.remove('modal-open');

            // Destroy chart
            if (dashboardChart) {
                dashboardChart.destroy();
                dashboardChart = null;
            }
        }
        
        function renderNationalDashboard(data) {
            document.getElementById('dashboardLoading').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            
            const s = data.summary;
            
            // Summary cards
            document.getElementById('dashLocalCount').textContent = formatNumber(s.local_count || 0);
            document.getElementById('dashMemberCount').textContent = formatNumber(s.total_members || 0);
            document.getElementById('dashEmployerCount').textContent = formatNumber(s.total_employers || 0);
            document.getElementById('dashWorkerCount').textContent = formatNumber(s.covered_workers || 0);
            document.getElementById('dashStateCount').textContent = (s.states || []).length;
            
            // Trends
            const trends = data.trends || {};
            if (trends.member_change_pct !== undefined || trends.asset_change_pct !== undefined) {
                document.getElementById('dashTrends').classList.remove('hidden');
                
                if (trends.member_change_pct !== undefined) {
                    const el = document.getElementById('dashMemberTrend');
                    const isPos = trends.member_change_pct >= 0;
                    el.textContent = `${isPos ? '↑' : '↓'} ${Math.abs(trends.member_change_pct)}% members (${trends.years_of_data}yr)`;
                    el.className = `px-3 py-1 rounded-full text-sm font-medium ${isPos ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                }
                
                if (trends.asset_change_pct !== undefined) {
                    const el = document.getElementById('dashAssetTrend');
                    const isPos = trends.asset_change_pct >= 0;
                    el.textContent = `${isPos ? '↑' : '↓'} ${Math.abs(trends.asset_change_pct)}% assets`;
                    el.className = `px-3 py-1 rounded-full text-sm font-medium ${isPos ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
                }
            } else {
                document.getElementById('dashTrends').classList.add('hidden');
            }
            
            // Sector badges
            const sectors = s.sectors || [];
            document.getElementById('dashSectors').innerHTML = sectors.map(sector => {
                const sectorClass = getSectorBadgeClass(sector);
                return `<span class="badge ${sectorClass}">${formatSectorName(sector)}</span>`;
            }).join('');
            
            // Financial trends chart
            renderDashboardChart(data.financial_trends || []);
            
            // Top locals
            const locals = data.top_locals || [];
            document.getElementById('dashTopLocals').innerHTML = locals.length > 0 
                ? locals.map(local => `
                    <div class="flex justify-between items-center p-2 bg-warmgray-50 rounded hover:bg-warmgray-100 cursor-pointer"
                         onclick="selectLocalFromDashboard('${local.f_num}')">
                        <div>
                            <div class="font-medium text-sm text-warmgray-900">
                                ${local.local_number ? `Local ${local.local_number}` : escapeHtml(local.union_name || 'Unknown')}
                                ${local.desig_name ? `<span class="text-warmgray-500">${escapeHtml(local.desig_name)}</span>` : ''}
                            </div>
                            <div class="text-xs text-warmgray-500">${escapeHtml(local.city || '')}, ${local.state || ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-warmgray-900">${formatNumber(local.members || 0)}</div>
                            <div class="text-xs text-warmgray-400">${formatNumber(local.f7_employer_count || 0)} employers</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="text-warmgray-400 text-sm">No local data available</div>';
            
            // Geographic distribution - use by_state (filtered to current affiliation)
            const geo = data.by_state || [];
            const totalMembers = geo.reduce((sum, g) => sum + (g.total_members || 0), 0);
            document.getElementById('dashGeoDistribution').innerHTML = geo.length > 0
                ? geo.slice(0, 15).map(g => {
                    const pct = totalMembers > 0 ? Math.round((g.total_members || 0) / totalMembers * 100) : 0;
                    return `
                        <div class="flex items-center gap-3">
                            <div class="w-8 text-xs font-medium text-warmgray-700">${g.state}</div>
                            <div class="flex-1 bg-warmgray-200 rounded-full h-2">
                                <div class="bg-accent-red rounded-full h-2" style="width: ${pct}%"></div>
                            </div>
                            <div class="w-24 text-right text-xs">
                                <span class="text-warmgray-700">${formatNumber(g.total_members || 0)}</span>
                                <span class="text-warmgray-400">(${g.local_count})</span>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<div class="text-warmgray-400 text-sm">No geographic data available</div>';
            
            // Industries
            const industries = data.industry_distribution || [];
            document.getElementById('dashIndustries').innerHTML = industries.length > 0
                ? industries.map(ind => `
                    <span class="px-3 py-1 bg-warmgray-100 text-warmgray-700 text-sm rounded-full">
                        ${escapeHtml(ind.naics_sector_name || 'NAICS ' + ind.naics_2digit)}
                        <span class="text-warmgray-400">(${formatNumber(ind.total_workers || 0)})</span>
                    </span>
                `).join('')
                : '<div class="text-warmgray-400 text-sm">No industry data available</div>';
            
            // Top employers
            const employers = data.top_employers || [];
            document.getElementById('dashTopEmployers').innerHTML = employers.length > 0
                ? employers.slice(0, 10).map(emp => `
                    <div class="flex justify-between items-center p-2 bg-warmgray-50 rounded hover:bg-warmgray-100 cursor-pointer"
                         onclick="selectEmployerFromDashboard('${emp.employer_id}')">
                        <div>
                            <div class="font-medium text-sm text-warmgray-900">${escapeHtml(emp.employer_name)}</div>
                            <div class="text-xs text-warmgray-500">
                                ${escapeHtml(emp.city || '')}, ${emp.state || ''}
                                ${emp.local_number ? ` · Local ${emp.local_number}` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-warmgray-900">${formatNumber(emp.latest_unit_size || 0)}</div>
                            <div class="text-xs text-warmgray-400">workers</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="text-warmgray-400 text-sm">No employer data available</div>';
        }
        
        function renderDashboardChart(financials) {
            // Destroy existing chart
            if (dashboardChart) {
                dashboardChart.destroy();
                dashboardChart = null;
            }
            
            if (!financials || financials.length < 2) {
                document.getElementById('dashTrendsChart').parentElement.innerHTML = `
                    <h3 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Membership Trend</h3>
                    <div class="text-warmgray-400 text-sm py-8 text-center">Insufficient historical data</div>
                `;
                return;
            }
            
            // Reverse for chronological order
            const sorted = [...financials].reverse();
            const labels = sorted.map(f => f.yr_covered);
            const memberData = sorted.map(f => (f.total_members || 0) / 1000); // In thousands
            const assetData = sorted.map(f => (f.total_assets || 0) / 1000000); // In millions
            
            const ctx = document.getElementById('dashTrendsChart').getContext('2d');
            
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Members (K)',
                            data: memberData,
                            borderColor: '#8B4513',
                            backgroundColor: 'rgba(139, 69, 19, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Assets ($M)',
                            data: assetData,
                            borderColor: '#6B7280',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            tension: 0.3,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { boxWidth: 12, font: { size: 11 } }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Members (K)', font: { size: 10 } }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Assets ($M)', font: { size: 10 } },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        // Track current affiliation for linking
        let currentDashboardAffiliation = null;

        function selectLocalFromDashboard(fNum) {
            closeNationalDashboard();
            setSearchMode('unions');
            // Search for this specific union
            document.getElementById('mainSearch').value = fNum;
            executeSearch();
        }

        async function selectEmployerFromDashboard(employerId) {
            closeNationalDashboard();
            setSearchMode('employers');
            // Fetch the employer and add to results before selecting
            try {
                const response = await fetch(`${API_BASE}/employers/${employerId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.employer) {
                        currentResults = [data.employer];
                        selectItem(employerId);
                    }
                }
            } catch (e) {
                console.error('Failed to load employer:', e);
            }
        }

        function searchLocalsForCurrentAffiliation() {
            if (!currentDashboardAffiliation) return;
            searchLocalsForAffiliation(currentDashboardAffiliation);
        }

        function searchLocalsForAffiliation(affAbbr) {
            closeNationalDashboard();
            setSearchMode('unions');
            // Clear main search, set affiliation filter via selectedIndustry
            document.getElementById('mainSearch').value = '';
            // Set the industry filter to be a union affiliation
            selectedIndustry = { type: 'union', abbr: affAbbr, name: affAbbr };
            renderIndustryTag();
            executeSearch();
        }
        
        // ==========================================
        // NATIONAL UNIONS BROWSER
        // ==========================================
        async function openNationalUnionsBrowser() {
            document.getElementById('nationalBrowserModal').classList.remove('hidden');
            document.getElementById('nationalBrowserModal').classList.add('flex');
            document.getElementById('browserLoading').classList.remove('hidden');
            document.getElementById('browserContent').classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/unions/national?limit=100`);
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                renderNationalUnionsList(data.national_unions || []);
            } catch (e) {
                console.error('Failed to load national unions:', e);
                document.getElementById('browserLoading').innerHTML = `
                    <div class="text-red-600">Failed to load national unions</div>
                `;
            }
        }
        
        function closeNationalBrowser() {
            document.getElementById('nationalBrowserModal').classList.add('hidden');
            document.getElementById('nationalBrowserModal').classList.remove('flex');
        }
        
        function renderNationalUnionsList(unions) {
            document.getElementById('browserLoading').classList.add('hidden');
            document.getElementById('browserContent').classList.remove('hidden');
            
            const container = document.getElementById('browserList');
            
            if (unions.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-warmgray-400 py-8">No national unions found</div>';
                return;
            }
            
            container.innerHTML = unions.map(u => `
                <div class="bg-warmgray-50 rounded-lg p-4 hover:bg-warmgray-100 cursor-pointer transition-colors"
                     onclick="selectNationalUnion('${escapeHtml(u.aff_abbr)}')">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-lg text-warmgray-900">${escapeHtml(u.aff_abbr)}</div>
                        <div class="text-xs text-warmgray-400">${u.local_count} locals</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-warmgray-500">Members:</span>
                            <span class="font-semibold text-accent-red">${formatNumber(u.total_members || 0)}</span>
                        </div>
                        <div>
                            <span class="text-warmgray-500">Employers:</span>
                            <span class="font-semibold">${formatNumber(u.total_employers || 0)}</span>
                        </div>
                    </div>
                    <div class="text-xs text-warmgray-400 mt-2">
                        ${(u.states || []).length} states · ${formatNumber(u.covered_workers || 0)} workers covered
                    </div>
                </div>
            `).join('');
        }
        
        function selectNationalUnion(affAbbr) {
            closeNationalBrowser();
            openNationalDashboard(affAbbr);
        }
        
        function showFindSimilarForm() {
            document.getElementById('findSimilarForm').classList.remove('hidden');
            document.getElementById('findSimilarResults').classList.add('hidden');
            document.getElementById('findSimilarLoading').classList.add('hidden');
        }
        
        function showFindSimilarLoading() {
            document.getElementById('findSimilarForm').classList.add('hidden');
            document.getElementById('findSimilarResults').classList.add('hidden');
            document.getElementById('findSimilarLoading').classList.remove('hidden');
        }
        
        function showFindSimilarResults() {
            document.getElementById('findSimilarForm').classList.add('hidden');
            document.getElementById('findSimilarResults').classList.remove('hidden');
            document.getElementById('findSimilarLoading').classList.add('hidden');
        }
        
        async function executeFindSimilar() {
            if (!selectedItem || !selectedItem.employer_id) {
                alert('No employer selected');
                return;
            }
            
            showFindSimilarLoading();
            
            const geoLevel = document.getElementById('similarGeoLevel').value;
            const radiusMiles = document.getElementById('similarRadius').value || 50;
            const includeUnion = !document.getElementById('matchNonUnion').checked;
            
            const params = new URLSearchParams({
                geo_level: geoLevel,
                include_union: includeUnion,
                limit: 50
            });
            
            if (geoLevel === 'radius') {
                params.append('radius_miles', radiusMiles);
            }
            
            try {
                const response = await fetch(`${API_BASE}/employers/${selectedItem.employer_id}/similar?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displaySimilarResults(data);
            } catch (e) {
                console.error('Find Similar failed:', e);
                showFindSimilarForm();
                alert('Search failed. Make sure the API is running and OSHA data is loaded.');
            }
        }
        
        function displaySimilarResults(data) {
            const listEl = document.getElementById('similarResultsList');
            const results = data.similar_employers || [];
            
            // Update header
            document.getElementById('similarResultsCount').textContent = 
                `${results.length} potential target${results.length !== 1 ? 's' : ''} found`;
            document.getElementById('similarResultsSource').textContent = 
                data.data_source === 'osha' ? 'from OSHA enforcement data' : 'from F-7 employer data';
            
            if (results.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12 text-warmgray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-warmgray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/>
                        </svg>
                        <p class="font-medium">No similar employers found</p>
                        <p class="text-sm mt-1">Try expanding your geography or adjusting filters</p>
                    </div>
                `;
            } else {
                listEl.innerHTML = results.map(emp => renderSimilarCard(emp, data.data_source)).join('');
            }
            
            showFindSimilarResults();
        }
        
        function renderSimilarCard(emp, dataSource) {
            const riskColors = {
                'HIGH': 'bg-red-100 text-red-800 border-red-200',
                'MEDIUM': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'LOW': 'bg-green-100 text-green-800 border-green-200',
                'UNKNOWN': 'bg-warmgray-100 text-warmgray-600 border-warmgray-200'
            };
            
            const riskClass = riskColors[emp.risk_level] || riskColors['UNKNOWN'];
            const location = [emp.city, emp.state].filter(Boolean).join(', ');
            const employees = emp.employee_count ? formatNumber(emp.employee_count) + ' employees' : '';
            
            // OSHA-specific fields
            const violations = emp.total_violations || 0;
            const serious = emp.serious_violations || 0;
            const willful = emp.willful_violations || 0;
            const penalty = emp.total_penalty ? '$' + formatNumber(emp.total_penalty) : '';
            
            let violationBadges = '';
            if (dataSource === 'osha' && violations > 0) {
                violationBadges = `
                    <div class="flex gap-2 mt-2 flex-wrap">
                        <span class="text-xs px-2 py-0.5 rounded bg-warmgray-100 text-warmgray-700">
                            ${violations} violation${violations !== 1 ? 's' : ''}
                        </span>
                        ${serious > 0 ? `<span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">${serious} serious</span>` : ''}
                        ${willful > 0 ? `<span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">${willful} willful</span>` : ''}
                        ${penalty ? `<span class="text-xs px-2 py-0.5 rounded bg-warmgray-100 text-warmgray-700">${penalty} penalties</span>` : ''}
                    </div>
                `;
            }
            
            const nlrbBadge = emp.has_nlrb_history ? 
                '<span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700">NLRB history</span>' : '';
            
            return `
                <div class="border border-warmgray-200 rounded-lg p-4 mb-3 hover:border-warmgray-400 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-warmgray-900">${escapeHtml(emp.employer_name)}</h4>
                            <p class="text-sm text-warmgray-500">${escapeHtml(location)} ${employees ? '· ' + employees : ''}</p>
                            ${violationBadges}
                            ${nlrbBadge ? `<div class="mt-2">${nlrbBadge}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="text-xs px-2 py-1 rounded border ${riskClass} font-medium">
                                ${emp.risk_level || 'N/A'} risk
                            </span>
                            ${emp.naics ? `<span class="text-xs text-warmgray-400">NAICS ${emp.naics}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function onStateChange() {
            const state = document.getElementById('stateFilter').value;
            const metroSelect = document.getElementById('metroFilter');
            const citySelect = document.getElementById('cityFilter');
            
            // Reset dependent dropdowns
            metroSelect.innerHTML = '<option value="">All Metros</option>';
            citySelect.innerHTML = '<option value="">All Cities</option>';
            
            if (!state) {
                metroSelect.disabled = true;
                citySelect.disabled = true;
                return;
            }
            
            // Load metros for state
            metroSelect.disabled = false;
            citySelect.disabled = false;
            
            try {
                const response = await fetch(`${API_BASE}/lookups/metros?state=${state}`);
                const data = await response.json();
                
                if (data.metros && data.metros.length > 0) {
                    data.metros.forEach(metro => {
                        const option = document.createElement('option');
                        option.value = metro.cbsa_code;
                        option.textContent = `${metro.cbsa_title} (${formatNumber(metro.employer_count)})`;
                        metroSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.log('Metro loading failed:', e);
            }
            
            // Also load cities for state
            try {
                const response = await fetch(`${API_BASE}/lookups/cities?state=${state}`);
                const data = await response.json();
                
                if (data.cities && data.cities.length > 0) {
                    data.cities.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.city;
                        option.textContent = `${c.city} (${formatNumber(c.employer_count)})`;
                        citySelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.log('City loading failed:', e);
            }
        }
        
        async function onMetroChange() {
            const metro = document.getElementById('metroFilter').value;
            const citySelect = document.getElementById('cityFilter');
            
            citySelect.innerHTML = '<option value="">All Cities</option>';
            
            if (!metro) {
                // Metro cleared, reload all cities for state
                const state = document.getElementById('stateFilter').value;
                if (state) {
                    await loadCitiesForState(state);
                }
                return;
            }
            
            // Load cities for this metro
            try {
                const response = await fetch(`${API_BASE}/lookups/cities?cbsa=${metro}`);
                const data = await response.json();
                
                if (data.cities && data.cities.length > 0) {
                    data.cities.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.city;
                        option.textContent = `${c.city} (${formatNumber(c.employer_count)})`;
                        citySelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.log('City loading for metro failed:', e);
            }
        }
        
        async function loadCitiesForState(state) {
            const citySelect = document.getElementById('cityFilter');
            try {
                const response = await fetch(`${API_BASE}/lookups/cities?state=${state}`);
                const data = await response.json();
                
                citySelect.innerHTML = '<option value="">All Cities</option>';
                if (data.cities && data.cities.length > 0) {
                    data.cities.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.city;
                        option.textContent = `${c.city} (${formatNumber(c.employer_count)})`;
                        citySelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.log('City loading failed:', e);
            }
        }
        
        // ==========================================
        // TYPEAHEAD DATA
        // ==========================================
        const typeaheadData = {
            // NAICS 2-digit sectors
            naics_sectors: [
                { code: '11', name: 'Agriculture, Forestry, Fishing and Hunting', keywords: ['farm', 'farming', 'agricultural', 'forestry', 'logging', 'fishing'] },
                { code: '21', name: 'Mining, Quarrying, and Oil and Gas Extraction', keywords: ['mining', 'oil', 'gas', 'petroleum', 'coal', 'quarry'] },
                { code: '22', name: 'Utilities', keywords: ['utility', 'utilities', 'electric', 'power', 'water', 'gas', 'energy'] },
                { code: '23', name: 'Construction', keywords: ['construction', 'building', 'contractor', 'trades', 'carpenter', 'electrician', 'plumber'] },
                { code: '31', name: 'Manufacturing - Food, Beverage, Textiles', keywords: ['food', 'beverage', 'textile', 'apparel', 'clothing', 'meat', 'bakery'] },
                { code: '32', name: 'Manufacturing - Wood, Paper, Chemicals', keywords: ['wood', 'paper', 'chemical', 'plastics', 'rubber', 'petroleum', 'printing'] },
                { code: '33', name: 'Manufacturing - Metals, Machinery, Electronics', keywords: ['metal', 'steel', 'machinery', 'computer', 'electronics', 'automotive', 'aerospace', 'auto'] },
                { code: '42', name: 'Wholesale Trade', keywords: ['wholesale', 'distributor', 'distribution'] },
                { code: '44', name: 'Retail Trade - Motor Vehicles, Home', keywords: ['retail', 'car dealer', 'furniture', 'electronics store', 'hardware'] },
                { code: '45', name: 'Retail Trade - Grocery, General', keywords: ['grocery', 'supermarket', 'pharmacy', 'gas station', 'department store', 'retail'] },
                { code: '48', name: 'Transportation', keywords: ['transportation', 'trucking', 'airline', 'railroad', 'rail', 'transit', 'bus', 'shipping', 'freight'] },
                { code: '49', name: 'Warehousing and Postal', keywords: ['warehouse', 'warehousing', 'postal', 'courier', 'delivery', 'ups', 'fedex', 'amazon'] },
                { code: '51', name: 'Information', keywords: ['media', 'publishing', 'broadcasting', 'telecom', 'telecommunications', 'internet', 'software', 'film', 'movie', 'television', 'tv', 'radio', 'news'] },
                { code: '52', name: 'Finance and Insurance', keywords: ['bank', 'banking', 'insurance', 'credit union', 'financial', 'investment'] },
                { code: '53', name: 'Real Estate and Rental', keywords: ['real estate', 'property', 'rental', 'leasing'] },
                { code: '54', name: 'Professional, Scientific, Technical Services', keywords: ['legal', 'lawyer', 'accounting', 'engineering', 'architect', 'consulting', 'research', 'tech'] },
                { code: '55', name: 'Management of Companies', keywords: ['corporate', 'headquarters', 'holding company'] },
                { code: '56', name: 'Administrative and Waste Services', keywords: ['janitorial', 'janitor', 'custodian', 'security', 'guard', 'staffing', 'temp', 'waste', 'cleaning', 'building services'] },
                { code: '61', name: 'Educational Services', keywords: ['education', 'school', 'college', 'university', 'teacher', 'professor', 'k-12', 'training'] },
                { code: '62', name: 'Health Care and Social Assistance', keywords: ['healthcare', 'health care', 'hospital', 'nurse', 'nursing', 'doctor', 'medical', 'clinic', 'home health', 'social work', 'childcare', 'daycare'] },
                { code: '71', name: 'Arts, Entertainment, and Recreation', keywords: ['entertainment', 'sports', 'casino', 'gambling', 'theater', 'theatre', 'museum', 'amusement', 'recreation'] },
                { code: '72', name: 'Accommodation and Food Services', keywords: ['hotel', 'motel', 'restaurant', 'food service', 'hospitality', 'casino', 'bar', 'catering'] },
                { code: '81', name: 'Other Services', keywords: ['repair', 'automotive repair', 'personal services', 'laundry', 'religious', 'nonprofit'] },
                { code: '92', name: 'Public Administration', keywords: ['government', 'public sector', 'federal', 'state', 'municipal', 'city', 'county'] }
            ],
            
            // Common NAICS 3-4 digit subsectors
            naics_subsectors: [
                { code: '622', name: 'Hospitals', parent: '62', keywords: ['hospital', 'medical center'] },
                { code: '623', name: 'Nursing and Residential Care', parent: '62', keywords: ['nursing home', 'assisted living', 'residential care', 'senior'] },
                { code: '621', name: 'Ambulatory Health Care', parent: '62', keywords: ['clinic', 'physician', 'dentist', 'outpatient', 'home health'] },
                { code: '611', name: 'Elementary and Secondary Schools', parent: '61', keywords: ['k-12', 'school', 'elementary', 'high school', 'middle school'] },
                { code: '6113', name: 'Colleges and Universities', parent: '61', keywords: ['college', 'university', 'higher education', 'higher ed'] },
                { code: '484', name: 'Truck Transportation', parent: '48', keywords: ['trucking', 'truck driver', 'freight', 'hauling'] },
                { code: '493', name: 'Warehousing and Storage', parent: '49', keywords: ['warehouse', 'fulfillment', 'distribution center', 'logistics'] },
                { code: '492', name: 'Couriers and Messengers', parent: '49', keywords: ['courier', 'delivery', 'package', 'ups', 'fedex'] },
                { code: '7211', name: 'Hotels and Motels', parent: '72', keywords: ['hotel', 'motel', 'lodging', 'resort'] },
                { code: '7225', name: 'Restaurants', parent: '72', keywords: ['restaurant', 'fast food', 'dining', 'food service'] },
                { code: '4451', name: 'Grocery Stores', parent: '44', keywords: ['grocery', 'supermarket', 'food store'] },
                { code: '5121', name: 'Motion Picture and Video', parent: '51', keywords: ['film', 'movie', 'video production', 'hollywood', 'studio'] },
                { code: '5152', name: 'Cable and Subscription Programming', parent: '51', keywords: ['cable', 'streaming', 'television', 'tv'] },
                { code: '517', name: 'Telecommunications', parent: '51', keywords: ['telecom', 'phone', 'wireless', 'broadband', 'internet provider'] },
                { code: '238', name: 'Specialty Trade Contractors', parent: '23', keywords: ['electrician', 'plumber', 'hvac', 'roofing', 'painting', 'carpentry'] },
                { code: '3361', name: 'Motor Vehicle Manufacturing', parent: '33', keywords: ['auto', 'automotive', 'car', 'vehicle', 'assembly'] },
                { code: '3364', name: 'Aerospace Product Manufacturing', parent: '33', keywords: ['aerospace', 'aircraft', 'airplane', 'boeing', 'defense'] }
            ],
            
            // Union affiliations with industry associations
            unions: [
                { abbr: 'SEIU', name: 'Service Employees International Union', industries: ['62', '56'], keywords: ['healthcare', 'janitor', 'building services', 'home care'] },
                { abbr: 'UFCW', name: 'United Food and Commercial Workers', industries: ['44', '45', '31'], keywords: ['grocery', 'retail', 'meatpacking', 'food processing'] },
                { abbr: 'IBT', name: 'International Brotherhood of Teamsters', industries: ['48', '49', '42'], keywords: ['trucking', 'warehouse', 'delivery', 'ups', 'freight'] },
                { abbr: 'UAW', name: 'United Auto Workers', industries: ['33'], keywords: ['auto', 'automotive', 'manufacturing', 'assembly'] },
                { abbr: 'USW', name: 'United Steelworkers', industries: ['33', '32', '21'], keywords: ['steel', 'metal', 'manufacturing', 'mining', 'paper'] },
                { abbr: 'CWA', name: 'Communications Workers of America', industries: ['51', '52'], keywords: ['telecom', 'media', 'tech', 'call center', 'airline'] },
                { abbr: 'IBEW', name: 'International Brotherhood of Electrical Workers', industries: ['23', '22'], keywords: ['electrician', 'electrical', 'utility', 'construction'] },
                { abbr: 'AFSCME', name: 'American Federation of State County Municipal Employees', industries: ['92', '62', '61'], keywords: ['government', 'public sector', 'state', 'county', 'municipal'] },
                { abbr: 'AFT', name: 'American Federation of Teachers', industries: ['61', '62'], keywords: ['teacher', 'education', 'school', 'professor', 'healthcare'] },
                { abbr: 'NEA', name: 'National Education Association', industries: ['61'], keywords: ['teacher', 'education', 'school', 'k-12'] },
                { abbr: 'NNU', name: 'National Nurses United', industries: ['62'], keywords: ['nurse', 'nursing', 'rn', 'hospital'] },
                { abbr: 'UNITE HERE', name: 'UNITE HERE', industries: ['72', '71'], keywords: ['hotel', 'restaurant', 'hospitality', 'casino', 'food service'] },
                { abbr: 'LIUNA', name: 'Laborers International Union', industries: ['23'], keywords: ['laborer', 'construction', 'building'] },
                { abbr: 'UA', name: 'United Association (Plumbers & Pipefitters)', industries: ['23'], keywords: ['plumber', 'pipefitter', 'plumbing', 'hvac'] },
                { abbr: 'SMART', name: 'Sheet Metal Air Rail Transportation Workers', industries: ['23', '48'], keywords: ['sheet metal', 'hvac', 'rail', 'transit'] },
                { abbr: 'IAM', name: 'International Association of Machinists', industries: ['33', '48'], keywords: ['machinist', 'aerospace', 'airline', 'manufacturing'] },
                { abbr: 'ATU', name: 'Amalgamated Transit Union', industries: ['48'], keywords: ['transit', 'bus', 'driver', 'public transit'] },
                { abbr: 'TWU', name: 'Transport Workers Union', industries: ['48'], keywords: ['transit', 'airline', 'transportation'] },
                { abbr: 'UBC', name: 'United Brotherhood of Carpenters', industries: ['23'], keywords: ['carpenter', 'carpentry', 'woodwork', 'construction'] },
                { abbr: 'IUOE', name: 'International Union of Operating Engineers', industries: ['23'], keywords: ['crane', 'heavy equipment', 'operator', 'construction'] },
                { abbr: 'NALC', name: 'National Association of Letter Carriers', industries: ['49'], keywords: ['postal', 'mail', 'letter carrier', 'usps'] },
                { abbr: 'APWU', name: 'American Postal Workers Union', industries: ['49'], keywords: ['postal', 'mail', 'post office', 'usps'] },
                { abbr: 'AFGE', name: 'American Federation of Government Employees', industries: ['92'], keywords: ['federal', 'government', 'va', 'tsa', 'dod'] },
                { abbr: 'SAG-AFTRA', name: 'Screen Actors Guild - AFTRA', industries: ['51'], keywords: ['actor', 'film', 'television', 'radio', 'media'] },
                { abbr: 'IATSE', name: 'International Alliance of Theatrical Stage Employees', industries: ['51', '71'], keywords: ['stagehand', 'film', 'television', 'theater', 'production'] },
                { abbr: 'WGA', name: 'Writers Guild of America', industries: ['51'], keywords: ['writer', 'screenwriter', 'film', 'television'] },
                { abbr: 'DGA', name: 'Directors Guild of America', industries: ['51'], keywords: ['director', 'film', 'television'] },
                { abbr: 'ILA', name: 'International Longshoremen\'s Association', industries: ['48'], keywords: ['longshoremen', 'dockworker', 'port', 'shipping'] },
                { abbr: 'ILWU', name: 'International Longshore and Warehouse Union', industries: ['48', '49'], keywords: ['longshoremen', 'dockworker', 'port', 'warehouse'] }
            ],
            
            // Common occupation/role keywords mapped to industries
            occupations: [
                { term: 'nurse', display: 'Nurses / Nursing', naics: '62', union: 'NNU' },
                { term: 'teacher', display: 'Teachers / Education', naics: '61', union: 'AFT' },
                { term: 'truck driver', display: 'Truck Drivers', naics: '48', union: 'IBT' },
                { term: 'warehouse worker', display: 'Warehouse Workers', naics: '49', union: 'IBT' },
                { term: 'janitor', display: 'Janitors / Custodians', naics: '56', union: 'SEIU' },
                { term: 'security guard', display: 'Security Guards', naics: '56', union: 'SEIU' },
                { term: 'hotel worker', display: 'Hotel Workers', naics: '72', union: 'UNITE HERE' },
                { term: 'grocery worker', display: 'Grocery / Retail Workers', naics: '44', union: 'UFCW' },
                { term: 'auto worker', display: 'Auto Workers', naics: '33', union: 'UAW' },
                { term: 'steelworker', display: 'Steelworkers / Metal Workers', naics: '33', union: 'USW' },
                { term: 'electrician', display: 'Electricians', naics: '23', union: 'IBEW' },
                { term: 'plumber', display: 'Plumbers / Pipefitters', naics: '23', union: 'UA' },
                { term: 'carpenter', display: 'Carpenters', naics: '23', union: 'UBC' },
                { term: 'machinist', display: 'Machinists', naics: '33', union: 'IAM' },
                { term: 'flight attendant', display: 'Flight Attendants', naics: '48', union: 'AFA' },
                { term: 'pilot', display: 'Pilots', naics: '48', union: 'ALPA' },
                { term: 'bus driver', display: 'Bus / Transit Drivers', naics: '48', union: 'ATU' },
                { term: 'postal worker', display: 'Postal Workers', naics: '49', union: 'APWU' },
                { term: 'home health aide', display: 'Home Health Aides', naics: '62', union: 'SEIU' },
                { term: 'actor', display: 'Actors / Performers', naics: '51', union: 'SAG-AFTRA' },
                { term: 'stagehand', display: 'Stagehands / Crew', naics: '51', union: 'IATSE' }
            ]
        };
        
        // Currently selected industry filter
        let selectedIndustry = null;
        
        // ==========================================
        // TYPEAHEAD IMPLEMENTATION
        // ==========================================
        function setupTypeahead() {
            const industryInput = document.getElementById('industrySearch');
            const industryDropdown = document.getElementById('industryTypeahead');
            
            // Show dropdown on focus with popular options
            industryInput.addEventListener('focus', () => {
                if (industryInput.value.trim() === '') {
                    showPopularIndustries();
                } else {
                    filterTypeahead(industryInput.value);
                }
                industryDropdown.classList.add('open');
            });
            
            // Hide dropdown on blur (with delay for click handling)
            industryInput.addEventListener('blur', () => {
                setTimeout(() => industryDropdown.classList.remove('open'), 200);
            });
            
            // Filter on input
            industryInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query === '') {
                    showPopularIndustries();
                } else {
                    filterTypeahead(query);
                }
                industryDropdown.classList.add('open');
            });
            
            // Handle keyboard navigation
            industryInput.addEventListener('keydown', (e) => {
                handleTypeaheadKeyboard(e);
            });
        }
        
        function showPopularIndustries() {
            const dropdown = document.getElementById('industryTypeahead');
            
            // Show popular sectors
            const popularSectors = ['62', '61', '48', '72', '23', '33']; // Healthcare, Education, Transportation, Hospitality, Construction, Manufacturing
            const popularItems = typeaheadData.naics_sectors
                .filter(s => popularSectors.includes(s.code))
                .map(s => ({
                    type: 'naics',
                    code: s.code,
                    name: s.name,
                    category: 'Popular Industries'
                }));
            
            // Add popular unions
            const popularUnions = ['SEIU', 'IBT', 'UFCW', 'UAW', 'AFSCME'];
            const popularUnionItems = typeaheadData.unions
                .filter(u => popularUnions.includes(u.abbr))
                .map(u => ({
                    type: 'union',
                    abbr: u.abbr,
                    name: u.name,
                    category: 'Popular Unions'
                }));
            
            renderTypeaheadResults([...popularItems, ...popularUnionItems]);
        }
        
        function filterTypeahead(query) {
            const q = query.toLowerCase();
            const results = [];
            
            // Search NAICS sectors
            typeaheadData.naics_sectors.forEach(sector => {
                const nameMatch = sector.name.toLowerCase().includes(q);
                const codeMatch = sector.code.startsWith(q);
                const keywordMatch = sector.keywords.some(kw => kw.includes(q));
                
                if (nameMatch || codeMatch || keywordMatch) {
                    results.push({
                        type: 'naics',
                        code: sector.code,
                        name: sector.name,
                        category: 'Industry (NAICS)',
                        score: nameMatch ? 3 : (codeMatch ? 2 : 1)
                    });
                }
            });
            
            // Search NAICS subsectors
            typeaheadData.naics_subsectors.forEach(sub => {
                const nameMatch = sub.name.toLowerCase().includes(q);
                const codeMatch = sub.code.startsWith(q);
                const keywordMatch = sub.keywords.some(kw => kw.includes(q));
                
                if (nameMatch || codeMatch || keywordMatch) {
                    results.push({
                        type: 'naics',
                        code: sub.code,
                        name: sub.name,
                        parent: sub.parent,
                        category: 'Industry (NAICS)',
                        score: nameMatch ? 3 : (codeMatch ? 2 : 1)
                    });
                }
            });
            
            // Search unions
            typeaheadData.unions.forEach(union => {
                const abbrMatch = union.abbr.toLowerCase().includes(q);
                const nameMatch = union.name.toLowerCase().includes(q);
                const keywordMatch = union.keywords.some(kw => kw.includes(q));
                
                if (abbrMatch || nameMatch || keywordMatch) {
                    results.push({
                        type: 'union',
                        abbr: union.abbr,
                        name: union.name,
                        industries: union.industries,
                        category: 'Union',
                        score: abbrMatch ? 4 : (nameMatch ? 3 : 1)
                    });
                }
            });
            
            // Search occupations
            typeaheadData.occupations.forEach(occ => {
                if (occ.term.includes(q) || occ.display.toLowerCase().includes(q)) {
                    results.push({
                        type: 'occupation',
                        term: occ.term,
                        display: occ.display,
                        naics: occ.naics,
                        union: occ.union,
                        category: 'Occupation',
                        score: occ.term.includes(q) ? 3 : 2
                    });
                }
            });
            
            // Sort by score and limit results
            results.sort((a, b) => b.score - a.score);
            renderTypeaheadResults(results.slice(0, 12));
        }
        
        function renderTypeaheadResults(results) {
            const dropdown = document.getElementById('industryTypeahead');
            
            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div class="p-4 text-center text-warmgray-400 text-sm">
                        No matching industries found
                    </div>
                `;
                return;
            }
            
            // Group by category
            const grouped = {};
            results.forEach(r => {
                if (!grouped[r.category]) grouped[r.category] = [];
                grouped[r.category].push(r);
            });
            
            let html = '';
            
            for (const [category, items] of Object.entries(grouped)) {
                html += `<div class="typeahead-category px-3 py-2 text-xs font-semibold text-warmgray-400 uppercase tracking-wide bg-warmgray-50">${category}</div>`;
                
                items.forEach((item, idx) => {
                    const dataAttrs = `data-type="${item.type}" data-code="${item.code || item.abbr || item.term}" data-name="${item.name || item.display}"`;
                    
                    if (item.type === 'naics') {
                        html += `
                            <div class="typeahead-item" ${dataAttrs} onclick="selectTypeaheadItem(this)">
                                <div class="flex justify-between items-center">
                                    <span>${item.name}</span>
                                    <span class="text-xs text-warmgray-400 font-mono">NAICS ${item.code}</span>
                                </div>
                            </div>
                        `;
                    } else if (item.type === 'union') {
                        html += `
                            <div class="typeahead-item" ${dataAttrs} data-industries="${(item.industries || []).join(',')}" onclick="selectTypeaheadItem(this)">
                                <div class="flex justify-between items-center">
                                    <span><strong>${item.abbr}</strong> — ${item.name}</span>
                                </div>
                            </div>
                        `;
                    } else if (item.type === 'occupation') {
                        html += `
                            <div class="typeahead-item" ${dataAttrs} data-naics="${item.naics}" data-union="${item.union}" onclick="selectTypeaheadItem(this)">
                                <div class="flex justify-between items-center">
                                    <span>${item.display}</span>
                                    <span class="text-xs text-warmgray-400">${item.union} · NAICS ${item.naics}</span>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            dropdown.innerHTML = html;
        }
        
        function selectTypeaheadItem(element) {
            const type = element.dataset.type;
            const code = element.dataset.code;
            const name = element.dataset.name;
            
            const input = document.getElementById('industrySearch');
            
            if (type === 'naics') {
                input.value = name;
                selectedIndustry = { type: 'naics', code, name };
            } else if (type === 'union') {
                input.value = `${code} — ${name}`;
                selectedIndustry = { type: 'union', abbr: code, name, industries: element.dataset.industries?.split(',') };
            } else if (type === 'occupation') {
                input.value = name;
                selectedIndustry = { 
                    type: 'occupation', 
                    term: code, 
                    display: name, 
                    naics: element.dataset.naics,
                    union: element.dataset.union
                };
            }
            
            // Close dropdown
            document.getElementById('industryTypeahead').classList.remove('open');
            
            // Show selected indicator
            showSelectedIndustryTag();
        }
        
        function showSelectedIndustryTag() {
            if (!selectedIndustry) return;
            
            const tagContainer = document.getElementById('industryTagContainer');
            
            let tagText = '';
            
            if (selectedIndustry.type === 'naics') {
                tagText = `NAICS ${selectedIndustry.code}: ${selectedIndustry.name}`;
            } else if (selectedIndustry.type === 'union') {
                tagText = `Union: ${selectedIndustry.abbr}`;
            } else if (selectedIndustry.type === 'occupation') {
                tagText = `${selectedIndustry.display} (${selectedIndustry.union} · NAICS ${selectedIndustry.naics})`;
            }
            
            tagContainer.innerHTML = `
                <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-warmgray-900 text-white text-xs rounded-full">
                    <span>${tagText}</span>
                    <button onclick="clearIndustrySelection()" class="hover:text-warmgray-300 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </span>
            `;
        }
        
        function clearIndustrySelection() {
            selectedIndustry = null;
            document.getElementById('industrySearch').value = '';
            const tagContainer = document.getElementById('industryTagContainer');
            if (tagContainer) tagContainer.innerHTML = '';
        }
        
        // Keyboard navigation for typeahead
        let typeaheadFocusIndex = -1;
        
        function handleTypeaheadKeyboard(e) {
            const dropdown = document.getElementById('industryTypeahead');
            const items = dropdown.querySelectorAll('.typeahead-item');
            
            if (!dropdown.classList.contains('open') || items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                typeaheadFocusIndex = Math.min(typeaheadFocusIndex + 1, items.length - 1);
                updateTypeaheadFocus(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                typeaheadFocusIndex = Math.max(typeaheadFocusIndex - 1, 0);
                updateTypeaheadFocus(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (typeaheadFocusIndex >= 0 && items[typeaheadFocusIndex]) {
                    selectTypeaheadItem(items[typeaheadFocusIndex]);
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('open');
                typeaheadFocusIndex = -1;
            }
        }
        
        function updateTypeaheadFocus(items) {
            items.forEach((item, idx) => {
                if (idx === typeaheadFocusIndex) {
                    item.classList.add('bg-warmgray-100');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('bg-warmgray-100');
                }
            });
        }
        
        // ==========================================
        // SEARCH EXECUTION
        // ==========================================
        async function executeSearch() {
            // Show loading state
            showLoading(true);
            
            const params = new URLSearchParams();
            
            const mainSearch = document.getElementById('mainSearch').value.trim();
            const state = document.getElementById('stateFilter').value;
            const metro = document.getElementById('metroFilter').value;
            const city = document.getElementById('cityFilter').value;
            const sector = document.getElementById('sectorFilter').value;
            
            // Name search
            if (mainSearch) params.append('name', mainSearch);
            
            // Geography
            if (state) params.append('state', state);
            if (metro) params.append('metro', metro);
            if (city) params.append('city', city);
            
            // Sector filter - supported for both modes (PUBLIC_SECTOR queries ps_employers)
            if (sector) {
                params.append('sector', sector);
            }
            
            // Handle industry filter based on selection type
            if (selectedIndustry) {
                if (selectedIndustry.type === 'naics') {
                    params.append('naics', selectedIndustry.code.substring(0, 2));
                } else if (selectedIndustry.type === 'union') {
                    params.append('aff_abbr', selectedIndustry.abbr);
                } else if (selectedIndustry.type === 'occupation') {
                    params.append('naics', selectedIndustry.naics);
                }
            }
            
            // Pagination
            params.append('limit', '15');
            params.append('offset', String((currentPage - 1) * 15));
            
            const endpoint = currentMode === 'employers' ? 'employers/search' : 'unions/search';
            
            try {
                const response = await fetch(`${API_BASE}/${endpoint}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const rawData = await response.json();

                // Transform API response to expected format
                // API returns {total, employers} or {total, unions}
                // Frontend expects {total_count, results}
                const data = {
                    total_count: rawData.total || 0,
                    results: currentMode === 'employers' ? (rawData.employers || []) : (rawData.unions || [])
                };

                // Calculate aggregate stats from results
                if (currentMode === 'employers') {
                    data.total_workers = data.results.reduce((sum, r) => sum + (r.latest_unit_size || 0), 0);
                    data.total_locals = new Set(data.results.map(r => r.latest_union_fnum).filter(Boolean)).size;
                } else {
                    data.total_members = data.results.reduce((sum, r) => sum + (r.members || 0), 0);
                    data.total_employers = data.results.reduce((sum, r) => sum + (r.f7_employer_count || 0), 0);
                }

                displayResults(data);
                updateUrl();
                
                // Load stats breakdown for employer searches
                if (currentMode === 'employers') {
                    loadStatsBreakdown(params);
                }
            } catch (e) {
                console.error('Search failed:', e);
                showError('Search failed. Please check that the API is running on localhost:8001');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadStatsBreakdown(searchParams) {
            try {
                const response = await fetch(`${API_BASE}/stats/breakdown?${searchParams}`);
                if (!response.ok) return;
                
                const data = await response.json();
                populateStatsBreakdown(data);
            } catch (e) {
                console.log('Stats breakdown load failed:', e);
            }
        }
        
        function populateStatsBreakdown(data) {
            // Update totals in header
            if (data.totals) {
                document.getElementById('resultCount').textContent = formatNumber(data.totals.total_employers || 0);
                document.getElementById('resultWorkers').textContent = formatNumber(data.totals.total_workers || 0);
                document.getElementById('resultLocals').textContent = formatNumber(data.totals.total_locals || 0);
            }
            
            // By Sector
            const sectorEl = document.getElementById('statsBySector');
            if (data.by_sector && data.by_sector.length > 0) {
                const sectorNames = {
                    'PRIVATE': 'Private',
                    'PUBLIC_SECTOR': 'Public',
                    'FEDERAL': 'Federal',
                    'RLA': 'RLA',
                    'UNKNOWN': 'Other'
                };
                sectorEl.innerHTML = data.by_sector.map(s => `
                    <div class="flex justify-between">
                        <span>${sectorNames[s.sector] || s.sector}</span>
                        <span class="font-semibold">${formatNumber(s.worker_count)}</span>
                    </div>
                `).join('');
            } else {
                sectorEl.innerHTML = '<div class="text-warmgray-400 text-sm">No data</div>';
            }
            
            // By Industry
            const industryEl = document.getElementById('statsByIndustry');
            if (data.by_industry && data.by_industry.length > 0) {
                industryEl.innerHTML = data.by_industry.map(i => `
                    <div class="flex justify-between gap-2">
                        <span class="truncate" title="${escapeHtml(i.industry_name || 'NAICS ' + i.naics_code)}">${escapeHtml(truncateText(i.industry_name || 'NAICS ' + i.naics_code, 20))}</span>
                        <span class="font-semibold whitespace-nowrap">${formatNumber(i.worker_count)}</span>
                    </div>
                `).join('');
            } else {
                industryEl.innerHTML = '<div class="text-warmgray-400 text-sm">No data</div>';
            }
            
            // By Metro
            const metroEl = document.getElementById('statsByMetro');
            if (data.by_metro && data.by_metro.length > 0) {
                metroEl.innerHTML = data.by_metro.map(m => `
                    <div class="flex justify-between gap-2">
                        <span class="truncate" title="${escapeHtml(m.city)}, ${m.state}">${escapeHtml(truncateText(m.city, 15))}, ${m.state}</span>
                        <span class="font-semibold whitespace-nowrap">${formatNumber(m.worker_count)}</span>
                    </div>
                `).join('');
            } else {
                metroEl.innerHTML = '<div class="text-warmgray-400 text-sm">No data</div>';
            }
            
            // By Union
            const unionEl = document.getElementById('statsByUnion');
            if (data.by_union && data.by_union.length > 0) {
                unionEl.innerHTML = data.by_union.map(u => `
                    <div class="flex justify-between gap-2">
                        <span class="truncate" title="${escapeHtml(u.aff_abbr)}">${escapeHtml(u.aff_abbr)}</span>
                        <span class="font-semibold whitespace-nowrap">${formatNumber(u.worker_count)}</span>
                    </div>
                `).join('');
            } else {
                unionEl.innerHTML = '<div class="text-warmgray-400 text-sm">No data</div>';
            }
        }
        
        function truncateText(text, maxLen) {
            if (!text) return '';
            return text.length > maxLen ? text.substring(0, maxLen) + '…' : text;
        }
        
        function showLoading(isLoading) {
            const listContainer = document.getElementById('listItems');
            const emptyState = document.getElementById('emptyState');
            
            if (isLoading) {
                emptyState.classList.add('hidden');
                listContainer.classList.remove('hidden');
                listContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="animate-spin w-8 h-8 border-2 border-warmgray-300 border-t-warmgray-600 rounded-full mx-auto mb-3"></div>
                        <div class="text-warmgray-500">Searching...</div>
                    </div>
                `;
            }
        }
        
        function showError(message) {
            const listContainer = document.getElementById('listItems');
            listContainer.innerHTML = `
                <div class="p-8 text-center">
                    <div class="text-red-500 mb-2">
                        <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="text-warmgray-700 font-medium">${message}</div>
                    <button onclick="executeSearch()" class="mt-3 text-sm text-accent-red hover:underline">Try again</button>
                </div>
            `;
        }
        
        function displaySampleResults() {
            if (currentMode === 'employers') {
                // Demo data for employer layout testing
                const sampleData = {
                    total_count: 142,
                    total_workers: 234567,
                    total_locals: 38,
                    results: [
                        { employer_id: 1, employer_name: 'Kaiser Permanente', city: 'Oakland', state: 'CA', zip: '94612', latest_unit_size: 58420, union_name: 'SEIU-UHW Local 2005', aff_abbr: 'SEIU', sector: 'PRIVATE', naics: '622110', naics_sector_name: 'Hospitals', latitude: 37.8044, longitude: -122.2712, latest_notice_date: '2024-03-15' },
                        { employer_id: 2, employer_name: 'Dignity Health', city: 'San Francisco', state: 'CA', zip: '94102', latest_unit_size: 12350, union_name: 'SEIU Local 121RN', aff_abbr: 'SEIU', sector: 'PRIVATE', naics: '622110', naics_sector_name: 'Hospitals', latitude: 37.7749, longitude: -122.4194, latest_notice_date: '2024-02-20' },
                        { employer_id: 3, employer_name: 'Sutter Health', city: 'Sacramento', state: 'CA', zip: '95814', latest_unit_size: 8200, union_name: 'CNA/NNU', aff_abbr: 'NNU', sector: 'PRIVATE', naics: '622110', naics_sector_name: 'Hospitals', latitude: 38.5816, longitude: -121.4944, latest_notice_date: '2024-01-10' },
                        { employer_id: 4, employer_name: 'UCLA Medical Center', city: 'Los Angeles', state: 'CA', zip: '90095', latest_unit_size: 6890, union_name: 'AFSCME Local 3299', aff_abbr: 'AFSCME', sector: 'PUBLIC_SECTOR', naics: '622110', naics_sector_name: 'Hospitals', latitude: 34.0667, longitude: -118.4452, latest_notice_date: '2023-12-05' },
                        { employer_id: 5, employer_name: 'Stanford Health Care', city: 'Palo Alto', state: 'CA', zip: '94304', latest_unit_size: 5430, union_name: 'SEIU Local 2007', aff_abbr: 'SEIU', sector: 'PRIVATE', naics: '622110', naics_sector_name: 'Hospitals', latitude: 37.4419, longitude: -122.1430, latest_notice_date: '2024-04-01' },
                    ]
                };
                displayResults(sampleData);
            } else {
                // Demo data for union layout testing
                const sampleUnionData = {
                    total_count: 38,
                    total_members: 892450,
                    total_employers: 142,
                    results: [
                        { 
                            f_num: '545348', 
                            union_name: 'SEIU Local 2015', 
                            unit_name: 'SEIU Local 2015',
                            aff_abbr: 'SEIU', 
                            affiliation: 'Service Employees International Union',
                            city: 'Los Angeles', 
                            state: 'CA', 
                            members: 246113, 
                            employer_count: 847,
                            total_covered_workers: 312500,
                            sector: 'PRIVATE_MIXED',
                            receipts: 148372941,
                            assets: 168442757,
                            disbursements: 135107824,
                            top_industries: ['Healthcare', 'Home Care', 'Nursing Facilities'],
                            latitude: 34.0522,
                            longitude: -118.2437
                        },
                        { 
                            f_num: '31847', 
                            union_name: 'SEIU Local 1199', 
                            unit_name: 'SEIU United Healthcare Workers East',
                            aff_abbr: 'SEIU', 
                            affiliation: 'Service Employees International Union',
                            city: 'New York', 
                            state: 'NY', 
                            members: 324595, 
                            employer_count: 412,
                            total_covered_workers: 298000,
                            sector: 'PRIVATE_MIXED',
                            receipts: 224284814,
                            assets: 485717385,
                            disbursements: 220291696,
                            top_industries: ['Hospitals', 'Nursing Homes', 'Home Care'],
                            latitude: 40.7128,
                            longitude: -74.0060
                        },
                        { 
                            f_num: '15724', 
                            union_name: 'California Nurses Association', 
                            unit_name: 'California Nurses Association',
                            aff_abbr: 'NNU', 
                            affiliation: 'National Nurses United',
                            city: 'Oakland', 
                            state: 'CA', 
                            members: 133446, 
                            employer_count: 215,
                            total_covered_workers: 145000,
                            sector: 'PRIVATE',
                            receipts: 238604317,
                            assets: 513002801,
                            disbursements: 219526564,
                            top_industries: ['Hospitals', 'Medical Centers'],
                            latitude: 37.8044,
                            longitude: -122.2712
                        },
                        { 
                            f_num: '5568', 
                            union_name: 'Teamsters Joint Council 42', 
                            unit_name: 'Joint Council 42',
                            aff_abbr: 'IBT', 
                            affiliation: 'International Brotherhood of Teamsters',
                            city: 'Pomona', 
                            state: 'CA', 
                            members: 180006, 
                            employer_count: 1250,
                            total_covered_workers: 195000,
                            sector: 'PRIVATE',
                            receipts: 4485720,
                            assets: 3573068,
                            disbursements: 3784596,
                            top_industries: ['Trucking', 'Warehousing', 'Package Delivery'],
                            latitude: 34.0551,
                            longitude: -117.7500
                        },
                        { 
                            f_num: '25027', 
                            union_name: 'Carpenters Local 405', 
                            unit_name: 'Western States Regional Council of Carpenters',
                            aff_abbr: 'UBC', 
                            affiliation: 'United Brotherhood of Carpenters',
                            city: 'Los Angeles', 
                            state: 'CA', 
                            members: 88963, 
                            employer_count: 2100,
                            total_covered_workers: 92000,
                            sector: 'PRIVATE',
                            receipts: 386151115,
                            assets: 531402942,
                            disbursements: 458160991,
                            top_industries: ['Construction', 'Building Trades'],
                            latitude: 34.0522,
                            longitude: -118.2437
                        },
                    ]
                };
                displayResults(sampleUnionData);
            }
        }
        
        function displayResults(data) {
            currentResults = data.results || [];
            totalPages = Math.ceil((data.total_count || 0) / 50);
            resetKeyboardFocus();
            
            // Update counts based on mode
            if (currentMode === 'employers') {
                document.getElementById('resultCount').textContent = formatNumber(data.total_count || 0);
                document.getElementById('resultWorkers').textContent = formatNumber(data.total_workers || 0);
                document.getElementById('resultLocals').textContent = formatNumber(data.total_locals || 0);
                document.getElementById('resultCountLabel').textContent = 'employers';
                document.getElementById('resultWorkersLabel').textContent = 'workers';
                document.getElementById('resultLocalsLabel').textContent = 'locals';
            } else {
                document.getElementById('resultCount').textContent = formatNumber(data.total_count || 0);
                document.getElementById('resultWorkers').textContent = formatNumber(data.total_members || 0);
                document.getElementById('resultLocals').textContent = formatNumber(data.total_employers || 0);
                document.getElementById('resultCountLabel').textContent = 'unions';
                document.getElementById('resultWorkersLabel').textContent = 'members';
                document.getElementById('resultLocalsLabel').textContent = 'employers';
            }
            
            // Handle empty results
            if (currentResults.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('listItems').classList.add('hidden');
                document.getElementById('emptyStateTitle').textContent = 'No results found';
                document.getElementById('emptyStateSubtitle').textContent = 'Try adjusting your search criteria';
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('shareBtn').disabled = true;
                return;
            }
            
            // Enable export and share buttons
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('shareBtn').disabled = false;
            
            // Hide empty state, show list
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('listItems').classList.remove('hidden');
            
            // Render list items based on mode
            const listContainer = document.getElementById('listItems');
            
            if (currentMode === 'employers') {
                listContainer.innerHTML = currentResults.map((item, index) => `
                    <div class="list-item p-4 cursor-pointer border-b border-warmgray-100 ${index === 0 ? 'selected' : ''}" 
                         onclick="selectItem('${item.employer_id}')" 
                         data-id="${item.employer_id}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-warmgray-900 truncate">${escapeHtml(item.employer_name || 'Unknown')}</div>
                                <div class="text-sm text-warmgray-500 mt-1 truncate">
                                    ${escapeHtml(item.latest_union_name || item.aff_abbr || 'Unknown union')} · ${escapeHtml(item.city || '')}, ${escapeHtml(item.state || '')}
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                <div class="text-lg font-bold text-accent-red">${formatNumber(item.latest_unit_size || 0)}</div>
                                <div class="text-xs text-warmgray-400">workers</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                listContainer.innerHTML = currentResults.map((item, index) => `
                    <div class="list-item p-4 cursor-pointer border-b border-warmgray-100 ${index === 0 ? 'selected' : ''}" 
                         onclick="selectItem('${item.f_num}')" 
                         data-id="${item.f_num}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-warmgray-900 truncate">${escapeHtml(formatUnionName(item))}</div>
                                <div class="text-sm text-warmgray-500 mt-1">
                                    <span class="font-medium">${escapeHtml(item.aff_abbr || 'IND')}</span> · ${escapeHtml(item.city || '')}, ${escapeHtml(item.state || '')}
                                </div>
                                <div class="text-xs text-warmgray-400 mt-1">${formatNumber(item.f7_employer_count || 0)} employers covered</div>
                            </div>
                            <div class="text-right ml-3">
                                <div class="text-lg font-bold text-accent-red">${formatNumber(item.members || 0)}</div>
                                <div class="text-xs text-warmgray-400">members</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Show/hide pagination
            updatePagination();
            
            // Update results count
            document.getElementById('resultsCount').textContent = formatNumber(data.total_count || currentResults.length);
            
            // Update map if in map view
            if (currentView === 'map') {
                updateMapMarkers();
            }
            
            // Auto-select first item
            if (currentResults.length > 0) {
                const firstId = currentMode === 'employers' 
                    ? currentResults[0].employer_id 
                    : currentResults[0].f_num;
                selectItem(firstId);
            }
        }
        
        function updatePagination() {
            const paginationEl = document.getElementById('pagination');
            const pageInfoEl = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            if (totalPages <= 1) {
                paginationEl.classList.add('hidden');
                return;
            }
            
            paginationEl.classList.remove('hidden');
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; executeSearch(); } };
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; executeSearch(); } };
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            if (typeof str !== 'string') str = String(str);
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }
        
        // Format union name for display: "SEIU Local 2015 (Los Angeles, CA)"
        function formatUnionName(union) {
            const abbr = union.aff_abbr || '';
            let localPart = '';
            
            // Try to extract local number from union_name or unit_name
            const nameToCheck = union.union_name || union.unit_name || '';
            const localMatch = nameToCheck.match(/Local\s*(\d+[A-Z]*)/i);
            
            if (localMatch) {
                localPart = `Local ${localMatch[1]}`;
            } else if (union.desig_num) {
                localPart = `Local ${union.desig_num}`;
            } else if (union.unit_name && union.unit_name !== union.union_name) {
                // Use unit name if different
                localPart = union.unit_name;
            }
            
            // Build display name
            if (abbr && localPart) {
                return `${abbr} ${localPart}`;
            } else if (abbr) {
                return union.union_name || abbr;
            } else {
                return union.union_name || 'Unknown Union';
            }
        }
        
        function clearResults() {
            currentResults = [];
            selectedItem = null;
            
            // Reset counts
            document.getElementById('resultCount').textContent = '0';
            document.getElementById('resultWorkers').textContent = '0';
            document.getElementById('resultLocals').textContent = '0';
            
            // Reset labels based on mode
            if (currentMode === 'employers') {
                document.getElementById('resultCountLabel').textContent = 'employers';
                document.getElementById('resultWorkersLabel').textContent = 'workers';
                document.getElementById('resultLocalsLabel').textContent = 'locals';
            } else {
                document.getElementById('resultCountLabel').textContent = 'unions';
                document.getElementById('resultWorkersLabel').textContent = 'members';
                document.getElementById('resultLocalsLabel').textContent = 'employers';
            }
            
            // Show empty states
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('listItems').classList.add('hidden');
            document.getElementById('listItems').innerHTML = '';
            document.getElementById('detailEmpty').classList.remove('hidden');
            document.getElementById('detailContent').classList.add('hidden');
            
            // Clear map marker
            if (detailMarker) {
                detailMap.removeLayer(detailMarker);
                detailMarker = null;
            }
            detailMap.setView([39.8283, -98.5795], 4);
            
            // Clear full map
            if (markerClusterGroup) {
                markerClusterGroup.clearLayers();
                mapMarkers.clear();
            }
            document.getElementById('mapSelectionPanel').classList.add('hidden');
            document.getElementById('resultsCount').textContent = '0';
            document.getElementById('mappableCount').textContent = '';
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('shareBtn').disabled = true;
        }
        
        // ==========================================
        // EXPORT RESULTS
        // ==========================================
        function copyShareLink() {
            const url = getShareableUrl();
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('shareBtnText');
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = original; }, 2000);
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                prompt('Copy this link:', url);
            });
        }
        
        function exportResults() {
            if (!currentResults || currentResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            let csv = '';
            let filename = '';
            
            if (currentMode === 'employers') {
                // Employer columns
                const headers = [
                    'Employer ID', 'Employer Name', 'City', 'State', 'NAICS', 'Industry',
                    'Workers', 'Union', 'Local Number', 'Latitude', 'Longitude',
                    'Latest Notice Date', 'OSHA Establishment ID'
                ];
                csv = headers.join(',') + '\n';
                
                currentResults.forEach(r => {
                    const row = [
                        r.employer_id || '',
                        csvEscape(r.employer_name || ''),
                        csvEscape(r.city || ''),
                        r.state || '',
                        r.naics || '',
                        csvEscape(r.naics_sector_name || ''),
                        r.latest_unit_size || '',
                        csvEscape(r.latest_union_name || ''),
                        r.local_number || '',
                        r.latitude || '',
                        r.longitude || '',
                        r.latest_notice_date || '',
                        r.osha_estab_id || ''
                    ];
                    csv += row.join(',') + '\n';
                });
                
                filename = `employers_export_${new Date().toISOString().slice(0,10)}.csv`;
            } else {
                // Union columns
                const headers = [
                    'F-Number', 'Union Name', 'Affiliation', 'Local Number', 'Designation',
                    'City', 'State', 'Sector', 'Members', 'Employer Count', 'Workers Covered',
                    'Latitude', 'Longitude'
                ];
                csv = headers.join(',') + '\n';
                
                currentResults.forEach(r => {
                    const row = [
                        r.f_num || '',
                        csvEscape(r.union_name || ''),
                        r.aff_abbr || '',
                        r.local_number || '',
                        csvEscape(r.desig_name || ''),
                        csvEscape(r.city || ''),
                        r.state || '',
                        r.sector || '',
                        r.members || '',
                        r.f7_employer_count || '',
                        r.f7_total_workers || '',
                        r.latitude || '',
                        r.longitude || ''
                    ];
                    csv += row.join(',') + '\n';
                });
                
                filename = `unions_export_${new Date().toISOString().slice(0,10)}.csv`;
            }
            
            // Download
            downloadCSV(csv, filename);
        }
        
        function csvEscape(str) {
            if (str == null) return '';
            str = String(str);
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function printReport() {
            if (!selectedItem) {
                alert('No item selected');
                return;
            }
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            const name = currentMode === 'employers' 
                ? selectedItem.employer_name 
                : selectedItem.union_name;
            const location = `${selectedItem.city || ''}, ${selectedItem.state || ''}`;
            const date = new Date().toLocaleDateString();
            
            let content = '';
            
            if (currentMode === 'employers') {
                content = `
                    <h1 style="margin:0; font-size: 24px;">${escapeHtml(name)}</h1>
                    <p style="color: #666; margin: 5px 0 20px;">${escapeHtml(location)}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>Workers</strong><br>${formatNumber(selectedItem.latest_unit_size || 0)}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>Industry</strong><br>${escapeHtml(selectedItem.naics_sector_name || 'N/A')}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>NAICS</strong><br>${selectedItem.naics || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Union</strong><br>${escapeHtml(selectedItem.latest_union_name || 'N/A')}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Latest Notice</strong><br>${selectedItem.latest_notice_date || 'N/A'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>F-7 ID</strong><br>${selectedItem.employer_id || 'N/A'}</td>
                        </tr>
                    </table>
                `;
            } else {
                content = `
                    <h1 style="margin:0; font-size: 24px;">${escapeHtml(name)}</h1>
                    <p style="color: #666; margin: 5px 0;">${selectedItem.local_number ? 'Local ' + selectedItem.local_number : ''}</p>
                    <p style="color: #666; margin: 5px 0 20px;">${escapeHtml(location)}</p>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>Members</strong><br>${formatNumber(selectedItem.members || 0)}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>Affiliation</strong><br>${selectedItem.aff_abbr || 'Independent'}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; width: 33%;"><strong>Sector</strong><br>${formatSectorName(selectedItem.sector)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Employers</strong><br>${formatNumber(selectedItem.f7_employer_count || 0)}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>Workers Covered</strong><br>${formatNumber(selectedItem.f7_total_workers || 0)}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;"><strong>F-Number</strong><br>${selectedItem.f_num || 'N/A'}</td>
                        </tr>
                    </table>
                `;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${escapeHtml(name)} - Labor Relations Report</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #1a1a1a; }
                        table { font-size: 14px; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    ${content}
                    <div class="footer">
                        <p>Generated from Labor Relations Research Platform on ${date}</p>
                        <p>Data sources: DOL OLMS, OSHA, NLRB, BLS</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 250);
        }
        
        // ==========================================
        // DETAIL PANEL
        // ==========================================
        function selectItem(id) {
            const idStr = String(id);
            const item = currentResults.find(r => {
                const itemId = currentMode === 'employers' ? String(r.employer_id) : String(r.f_num);
                return itemId === idStr;
            });
            if (!item) return;
            
            selectedItem = item;
            
            // Update list selection
            document.querySelectorAll('.list-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === idStr);
            });
            
            // Show detail content
            document.getElementById('detailEmpty').classList.add('hidden');
            document.getElementById('detailContent').classList.remove('hidden');
            
            if (currentMode === 'employers') {
                renderEmployerDetail(item);
            } else {
                renderUnionDetail(item);
            }
        }
        
        function renderEmployerDetail(item) {
            // Populate detail fields for employer
            document.getElementById('detailName').textContent = item.employer_name || 'Unknown';
            document.getElementById('detailLocation').textContent = `${item.city || 'Unknown'}, ${item.state || ''} ${item.zip || ''}`.trim();
            
            // Badges - use union_sector from API
            const sectorClass = getSectorBadgeClass(item.union_sector);
            const badgesHtml = `
                <span class="badge ${sectorClass}">${formatSectorName(item.union_sector)}</span>
                ${item.naics_sector_name ? `<span class="badge badge-industry">${escapeHtml(item.naics_sector_name)}</span>` : ''}
            `;
            document.getElementById('detailBadges').innerHTML = badgesHtml;
            
            // Key metrics - Employer view
            const unionName = item.latest_union_name || item.union_display_name || 'Unknown';
            const unionFnum = item.latest_union_fnum;
            const affAbbr = item.aff_abbr;
            document.getElementById('detailMetrics').innerHTML = `
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Union</div>
                    <div class="font-semibold text-warmgray-900 ${unionFnum ? 'entity-link' : ''}"
                         ${unionFnum ? `onclick="loadUnionDetail('${escapeHtml(unionFnum)}')"` : ''}>${escapeHtml(unionName)}</div>
                    <div class="text-sm text-warmgray-500">
                        ${affAbbr ? `<span class="entity-link" onclick="openNationalDashboard('${escapeHtml(affAbbr)}')">${escapeHtml(affAbbr)} affiliate</span>` : ''}
                    </div>
                </div>
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Workers</div>
                    <div class="text-3xl font-bold text-accent-red">${formatNumber(item.latest_unit_size || 0)}</div>
                </div>
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">${item.source_type === 'PUBLIC' ? 'Type' : 'Industry'}</div>
                    <div class="font-semibold text-warmgray-900">${item.source_type === 'PUBLIC' ? escapeHtml(item.employer_type || 'Public Sector') : escapeHtml(item.naics_sector_name || 'Unknown')}</div>
                    <div class="text-sm text-warmgray-500">${item.source_type === 'PUBLIC' ? escapeHtml(item.employer_subtype || '') : (item.naics ? `NAICS ${escapeHtml(item.naics)}` : '')}</div>
                </div>
            `;
            
            // Filing history
            document.getElementById('detailFilingSection').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Filing Details</div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="flex justify-between">
                        <span class="text-warmgray-500">Latest F-7 Filing</span>
                        <span class="font-medium">${item.latest_notice_date || '—'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-warmgray-500">Union File #</span>
                        <span class="font-medium font-mono text-xs">${item.latest_union_fnum || '—'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-warmgray-500">Healthcare Related</span>
                        <span class="font-medium">${item.healthcare_related ? 'Yes' : 'No'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-warmgray-500">Status</span>
                        <span class="font-medium ${item.potentially_defunct ? 'text-orange-600' : 'text-green-600'}">${item.potentially_defunct ? 'Potentially Defunct' : 'Active'}</span>
                    </div>
                </div>
            `;
            
            // BLS Projections
            document.getElementById('detailProjections').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Industry Outlook</div>
                <div class="bg-warmgray-100 rounded-lg p-4 text-sm">
                    <div class="text-warmgray-600">
                        <span>${escapeHtml(item.naics_sector_name || 'This')}</span> sector 
                        ${item.naics ? `<span class="text-warmgray-400">(NAICS ${item.naics.substring(0,2)})</span>` : ''}
                    </div>
                </div>
            `;
            
            // Show employer-specific sections, hide union-specific
            document.getElementById('detailCorporateSection').classList.remove('hidden');
            document.getElementById('detailNewsSection').classList.remove('hidden');
            document.getElementById('detailOshaSection').classList.remove('hidden');
            document.getElementById('detailNlrbSection').classList.remove('hidden');
            document.getElementById('detailEmployersSection').classList.add('hidden');
            document.getElementById('detailFinancialsSection').classList.add('hidden');
            
            // Find Similar button
            const inComparison = isInComparison(item.employer_id);
            document.getElementById('detailActionSection').innerHTML = `
                <div class="flex gap-2 mb-2">
                    <button onclick="openFindSimilar(selectedItem)" 
                        class="flex-1 py-3 bg-warmgray-900 text-white font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                        Find Similar Employers →
                    </button>
                    <button onclick="addToComparison(selectedItem)" 
                        class="px-4 py-3 border-2 ${inComparison ? 'border-accent-red bg-accent-red/10 text-accent-red' : 'border-warmgray-300 text-warmgray-600 hover:border-warmgray-400'} font-semibold rounded-lg transition-colors"
                        title="${inComparison ? 'Already in comparison' : 'Add to comparison'}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </button>
                </div>
                <p class="text-xs text-warmgray-400 text-center">Discover non-union employers in the same industry and geography</p>
            `;
            
            // Update map
            updateDetailMap(item);

            // Load OSHA, NLRB, and corporate family data asynchronously
            loadEmployerOsha(item.employer_id);
            loadEmployerNlrb(item.employer_id);
            loadCorporateFamily(item.employer_id);
        }

        // Navigate to union detail from employer view
        async function loadUnionDetail(fNum) {
            setSearchMode('unions');
            document.getElementById('mainSearch').value = fNum;
            await executeSearch();
            // Try to select the union from results
            if (currentResults.length > 0) {
                const union = currentResults.find(u => u.f_num === fNum);
                if (union) {
                    selectItem(union.f_num);
                }
            }
        }

        async function loadEmployerOsha(employerId) {
            const contentEl = document.getElementById('oshaContent');
            const loadingEl = document.getElementById('oshaLoadingBadge');
            
            loadingEl.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/employers/${employerId}/osha`);
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                renderOshaContent(data);
            } catch (e) {
                console.log('OSHA load failed:', e);
                contentEl.innerHTML = `
                    <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                        No OSHA data available
                    </div>
                `;
            } finally {
                loadingEl.classList.add('hidden');
            }
        }
        
        function renderOshaContent(data) {
            const contentEl = document.getElementById('oshaContent');
            
            if (!data.summary || data.summary.total_establishments === 0) {
                contentEl.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center text-sm text-green-700">
                        <span class="font-medium">✓ No OSHA violations found</span>
                        <p class="text-green-600 text-xs mt-1">No matched OSHA inspection records</p>
                    </div>
                `;
                return;
            }
            
            const s = data.summary;
            const riskColors = {
                'HIGH': 'bg-red-100 text-red-800 border-red-200',
                'MEDIUM': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'LOW': 'bg-green-100 text-green-700 border-green-200',
                'NONE': 'bg-warmgray-100 text-warmgray-600 border-warmgray-200'
            };
            const riskClass = riskColors[s.risk_level] || riskColors['NONE'];
            
            let html = `
                <div class="space-y-3">
                    <!-- Summary -->
                    <div class="flex items-center justify-between">
                        <span class="px-2 py-1 text-xs font-semibold rounded border ${riskClass}">
                            ${s.risk_level} RISK
                        </span>
                        <span class="text-xs text-warmgray-500">${s.total_establishments} establishment${s.total_establishments !== 1 ? 's' : ''} matched</span>
                    </div>
                    
                    <!-- Violation stats -->
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-warmgray-100 rounded p-2">
                            <div class="text-lg font-bold text-warmgray-900">${formatNumber(s.total_violations)}</div>
                            <div class="text-xs text-warmgray-500">Total</div>
                        </div>
                        <div class="bg-orange-50 rounded p-2">
                            <div class="text-lg font-bold text-orange-700">${formatNumber(s.serious_violations)}</div>
                            <div class="text-xs text-orange-600">Serious</div>
                        </div>
                        <div class="bg-red-50 rounded p-2">
                            <div class="text-lg font-bold text-red-700">${formatNumber(s.willful_violations)}</div>
                            <div class="text-xs text-red-600">Willful</div>
                        </div>
                        <div class="bg-warmgray-100 rounded p-2">
                            <div class="text-lg font-bold text-warmgray-900">${formatNumber(s.repeat_violations)}</div>
                            <div class="text-xs text-warmgray-500">Repeat</div>
                        </div>
                    </div>
                    
                    <!-- Penalties -->
                    ${s.total_penalties > 0 ? `
                        <div class="bg-red-50 border border-red-100 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-red-700">$${formatNumber(s.total_penalties)}</div>
                            <div class="text-xs text-red-600">Total Penalties</div>
                        </div>
                    ` : ''}
            `;
            
            // Show recent establishments
            if (data.establishments && data.establishments.length > 0) {
                html += `
                    <div class="mt-3">
                        <div class="text-xs font-semibold text-warmgray-500 mb-2">Recent Inspections</div>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                `;
                data.establishments.slice(0, 5).forEach(est => {
                    html += `
                        <div class="text-sm p-2 bg-warmgray-50 rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium text-warmgray-900">${escapeHtml(est.estab_name || 'Unknown')}</div>
                                <div class="text-xs text-warmgray-500">${escapeHtml(est.site_city || '')}, ${est.site_state || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-medium ${est.total_violations > 0 ? 'text-red-600' : 'text-green-600'}">
                                    ${est.total_violations} violations
                                </div>
                                ${est.last_inspection ? `<div class="text-xs text-warmgray-400">${est.last_inspection}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            contentEl.innerHTML = html;
        }
        
        async function loadEmployerNlrb(employerId) {
            const contentEl = document.getElementById('nlrbContent');
            const loadingEl = document.getElementById('nlrbLoadingBadge');
            
            loadingEl.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/employers/${employerId}/nlrb`);
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                renderNlrbContent(data);
            } catch (e) {
                console.log('NLRB load failed:', e);
                contentEl.innerHTML = `
                    <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                        No NLRB data available
                    </div>
                `;
            } finally {
                loadingEl.classList.add('hidden');
            }
        }
        
        function renderNlrbContent(data) {
            const contentEl = document.getElementById('nlrbContent');
            
            const hasElections = data.elections && data.elections.length > 0;
            const hasUlp = data.ulp_cases && data.ulp_cases.length > 0;
            
            if (!hasElections && !hasUlp) {
                contentEl.innerHTML = `
                    <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                        No NLRB election or ULP records found for this employer
                    </div>
                `;
                return;
            }
            
            const s = data.summary;
            
            let html = '<div class="space-y-3">';
            
            // Summary stats
            if (s.total_elections > 0 || s.total_ulp_cases > 0) {
                html += `
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-warmgray-100 rounded p-2">
                            <div class="text-lg font-bold text-warmgray-900">${s.total_elections}</div>
                            <div class="text-xs text-warmgray-500">Elections</div>
                        </div>
                        <div class="bg-green-50 rounded p-2">
                            <div class="text-lg font-bold text-green-700">${s.election_wins}</div>
                            <div class="text-xs text-green-600">Union Wins</div>
                        </div>
                        <div class="bg-red-50 rounded p-2">
                            <div class="text-lg font-bold text-red-700">${s.election_losses}</div>
                            <div class="text-xs text-red-600">Losses</div>
                        </div>
                        <div class="bg-yellow-50 rounded p-2">
                            <div class="text-lg font-bold text-yellow-700">${s.total_ulp_cases}</div>
                            <div class="text-xs text-yellow-600">ULP Cases</div>
                        </div>
                    </div>
                `;
            }
            
            // Elections list
            if (hasElections) {
                html += `
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 mb-2">Election History</div>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                `;
                data.elections.slice(0, 8).forEach(el => {
                    const isWin = el.election_winner === 'Union';
                    const isLoss = el.election_winner === 'Employer';
                    const resultClass = isWin ? 'text-green-600' : (isLoss ? 'text-red-600' : 'text-warmgray-500');
                    const resultText = isWin ? 'Union Won' : (isLoss ? 'Employer Won' : (el.status || 'Pending'));
                    
                    html += `
                        <div class="text-sm p-2 bg-warmgray-50 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-warmgray-900">${escapeHtml(el.case_number)}</div>
                                    <div class="text-xs text-warmgray-500">${el.election_date || el.date_filed || '—'}</div>
                                </div>
                                <span class="text-xs font-medium ${resultClass}">${resultText}</span>
                            </div>
                            ${el.votes_for_union != null ? `
                                <div class="mt-1 text-xs text-warmgray-500">
                                    Vote: ${el.votes_for_union} for / ${el.votes_against} against
                                </div>
                            ` : ''}
                            ${el.union_to_certify ? `<div class="text-xs text-warmgray-400 mt-1">${escapeHtml(el.union_to_certify)}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // ULP cases
            if (hasUlp) {
                html += `
                    <div>
                        <div class="text-xs font-semibold text-warmgray-500 mb-2">Unfair Labor Practice Cases</div>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                `;
                data.ulp_cases.slice(0, 5).forEach(ulp => {
                    const caseTypes = {
                        'CA': 'Employer ULP',
                        'CB': 'Union ULP',
                        'CC': 'Union ULP',
                        'CD': 'Jurisdictional',
                        'CE': 'Employer ULP',
                        'CG': 'Employer ULP',
                        'CP': 'Picketing'
                    };
                    const typeLabel = caseTypes[ulp.case_type] || ulp.case_type;
                    
                    html += `
                        <div class="text-sm p-2 bg-yellow-50 rounded flex justify-between items-center">
                            <div>
                                <div class="font-medium text-warmgray-900">${escapeHtml(ulp.case_number)}</div>
                                <div class="text-xs text-warmgray-500">${ulp.date_filed || '—'} · ${typeLabel}</div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-1.5 py-0.5 rounded ${ulp.status === 'Closed' ? 'bg-warmgray-200 text-warmgray-600' : 'bg-yellow-200 text-yellow-800'}">
                                    ${escapeHtml(ulp.status || 'Unknown')}
                                </span>
                                ${ulp.allegation_count > 0 ? `<div class="text-xs text-warmgray-400 mt-1">${ulp.allegation_count} allegations</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            contentEl.innerHTML = html;
        }
        
        let trendsChart = null;
        
        async function renderUnionDetail(item) {
            // Populate detail fields for union
            document.getElementById('detailName').textContent = formatUnionName(item);
            document.getElementById('detailLocation').textContent = `${item.city || 'Unknown'}, ${item.state || ''}`;
            
            // Badges
            const sectorClass = getSectorBadgeClass(item.sector);
            const badgesHtml = `
                <span class="badge ${sectorClass}">${formatSectorName(item.sector)}</span>
                ${item.aff_abbr ? `<span class="badge badge-industry cursor-pointer hover:opacity-80" onclick="openNationalDashboard('${escapeHtml(item.aff_abbr)}')" title="View ${escapeHtml(item.aff_abbr)} National Dashboard">${escapeHtml(item.aff_abbr)}</span>` : ''}
            `;
            document.getElementById('detailBadges').innerHTML = badgesHtml;
            
            // Key metrics - Union view
            document.getElementById('detailMetrics').innerHTML = `
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Affiliation</div>
                    ${item.aff_abbr ? `
                        <div class="font-semibold text-warmgray-900 cursor-pointer hover:text-accent-red" onclick="openNationalDashboard('${escapeHtml(item.aff_abbr)}')">${escapeHtml(item.aff_abbr)}</div>
                        <div class="text-xs text-accent-red cursor-pointer hover:underline mt-1" onclick="openNationalDashboard('${escapeHtml(item.aff_abbr)}')">View national →</div>
                    ` : `
                        <div class="font-semibold text-warmgray-900">Independent</div>
                    `}
                </div>
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Members</div>
                    <div class="text-3xl font-bold text-accent-red">${formatNumber(item.members || 0)}</div>
                </div>
                <div class="bg-warmgray-100 rounded-lg p-4">
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-1">Employers</div>
                    <div class="text-2xl font-bold text-warmgray-900">${formatNumber(item.f7_employer_count || 0)}</div>
                    <div class="text-sm text-warmgray-500">${formatNumber(item.f7_total_workers || 0)} workers</div>
                </div>
            `;
            
            // Show loading states
            document.getElementById('detailFilingSection').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">LM Filing Summary</div>
                <div class="text-warmgray-400 text-sm">Loading financial data...</div>
            `;
            document.getElementById('detailProjections').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Top Industries</div>
                <div class="text-warmgray-400 text-sm">Loading...</div>
            `;
            
            // Show union-specific sections, hide employer-specific
            document.getElementById('detailCorporateSection').classList.add('hidden');
            document.getElementById('detailOshaSection').classList.add('hidden');
            document.getElementById('detailNlrbSection').classList.add('hidden');
            document.getElementById('detailNewsSection').classList.add('hidden');
            document.getElementById('detailEmployersSection').classList.remove('hidden');
            document.getElementById('detailFinancialsSection').classList.remove('hidden');
            document.getElementById('detailTrendsSection').classList.remove('hidden');
            document.getElementById('detailSisterLocalsSection').classList.remove('hidden');
            document.getElementById('detailGeoSection').classList.remove('hidden');
            
            // Employers covered section (placeholder while loading)
            document.getElementById('detailEmployersSection').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Top Employers</div>
                <div class="text-warmgray-400 text-sm">Loading...</div>
            `;
            
            // Sister locals placeholder
            document.getElementById('detailSisterLocalsSection').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Sister Locals</div>
                <div class="text-warmgray-400 text-sm">Loading...</div>
            `;
            
            // Geo distribution placeholder
            document.getElementById('detailGeoSection').innerHTML = `
                <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Geographic Coverage</div>
                <div class="text-warmgray-400 text-sm">Loading...</div>
            `;
            
            // Action button for unions
            const inComparison = isInComparison(item.f_num);
            document.getElementById('detailActionSection').innerHTML = `
                <div class="flex gap-2 mb-2">
                    ${item.f7_employer_count > 0 ? `
                        <button onclick="viewUnionEmployers('${item.f_num}')" 
                            class="flex-1 py-3 bg-warmgray-900 text-white font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                            View All ${formatNumber(item.f7_employer_count)} Employers →
                        </button>
                    ` : `
                        <div class="flex-1 text-center text-warmgray-400 text-sm py-3 border-2 border-warmgray-200 rounded-lg">
                            No F-7 employer filings
                        </div>
                    `}
                    <button onclick="addToComparison(selectedItem)" 
                        class="px-4 py-3 border-2 ${inComparison ? 'border-accent-red bg-accent-red/10 text-accent-red' : 'border-warmgray-300 text-warmgray-600 hover:border-warmgray-400'} font-semibold rounded-lg transition-colors"
                        title="${inComparison ? 'Already in comparison' : 'Add to comparison'}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </button>
                </div>
                ${item.f7_employer_count > 0 ? `<p class="text-xs text-warmgray-400 text-center">See complete employer list with bargaining agreements</p>` : ''}
            `;
            
            // Update map
            updateDetailMap(item);
            
            // Fetch detailed union info
            try {
                const response = await fetch(`${API_BASE}/unions/${item.f_num}`);
                if (response.ok) {
                    const detail = await response.json();
                    renderUnionDetailData(detail, item);
                }
            } catch (e) {
                console.error('Failed to load union detail:', e);
            }
        }
        
        function renderUnionDetailData(detail, item) {
            const financials = detail.financial_history || [];
            const latest = financials[0];
            
            // Financial summary
            if (latest) {
                const netAssets = (latest.ttl_assets || 0) - (latest.ttl_liabilities || 0);
                document.getElementById('detailFilingSection').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">LM Filing (${latest.yr_covered})</div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-warmgray-50 rounded p-3">
                            <div class="text-warmgray-500 text-xs mb-1">Total Receipts</div>
                            <div class="font-semibold text-warmgray-900">${formatCurrency(latest.ttl_receipts)}</div>
                        </div>
                        <div class="bg-warmgray-50 rounded p-3">
                            <div class="text-warmgray-500 text-xs mb-1">Disbursements</div>
                            <div class="font-semibold text-warmgray-900">${formatCurrency(latest.ttl_disbursements)}</div>
                        </div>
                        <div class="bg-warmgray-50 rounded p-3">
                            <div class="text-warmgray-500 text-xs mb-1">Total Assets</div>
                            <div class="font-semibold text-warmgray-900">${formatCurrency(latest.ttl_assets)}</div>
                        </div>
                        <div class="bg-warmgray-50 rounded p-3">
                            <div class="text-warmgray-500 text-xs mb-1">Net Assets</div>
                            <div class="font-semibold ${netAssets >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(netAssets)}</div>
                        </div>
                    </div>
                    ${detail.trends && detail.trends.member_change_pct !== undefined ? `
                        <div class="mt-3 flex gap-4 text-xs">
                            <span class="${detail.trends.member_change_pct >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${detail.trends.member_change_pct >= 0 ? '↑' : '↓'} ${Math.abs(detail.trends.member_change_pct)}% members (${detail.trends.years_of_data}yr)
                            </span>
                            ${detail.trends.asset_change_pct !== undefined ? `
                                <span class="${detail.trends.asset_change_pct >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${detail.trends.asset_change_pct >= 0 ? '↑' : '↓'} ${Math.abs(detail.trends.asset_change_pct)}% assets
                                </span>
                            ` : ''}
                        </div>
                    ` : ''}
                `;
            } else {
                document.getElementById('detailFilingSection').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">LM Filing Summary</div>
                    <div class="text-warmgray-400 text-sm">No LM filings found</div>
                `;
            }
            
            // Render trends chart
            renderTrendsChart(financials);
            
            // Render industries
            const industries = detail.industry_distribution || [];
            if (industries.length > 0) {
                document.getElementById('detailProjections').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Top Industries</div>
                    <div class="flex flex-wrap gap-2">
                        ${industries.slice(0, 5).map(ind => 
                            `<span class="px-3 py-1 bg-warmgray-100 text-warmgray-700 text-sm rounded-full">
                                ${escapeHtml(ind.sector_name || 'NAICS ' + ind.naics_2digit)} 
                                <span class="text-warmgray-400">(${formatNumber(ind.workers || 0)})</span>
                            </span>`
                        ).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detailProjections').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Top Industries</div>
                    <div class="text-warmgray-400 text-sm">No industry data available</div>
                `;
            }
            
            // Render top employers
            const employers = detail.top_employers || [];
            if (employers.length > 0) {
                document.getElementById('detailEmployersSection').innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide">Top Employers</div>
                        ${item.f7_employer_count > 10 ? `
                            <button onclick="viewUnionEmployers('${item.f_num}')" class="text-xs text-accent-red hover:underline">
                                View all ${formatNumber(item.f7_employer_count)} →
                            </button>
                        ` : ''}
                    </div>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${employers.map(emp => `
                            <div class="flex justify-between items-center p-2 bg-warmgray-50 rounded hover:bg-warmgray-100 cursor-pointer"
                                 onclick="switchToEmployerAndSelect('${emp.employer_id}')">
                                <div>
                                    <div class="font-medium text-sm text-warmgray-900 entity-link">${escapeHtml(emp.employer_name)}</div>
                                    <div class="text-xs text-warmgray-500">${escapeHtml(emp.city || '')}, ${emp.state || ''}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-warmgray-900">${formatNumber(emp.latest_unit_size || 0)}</div>
                                    <div class="text-xs text-warmgray-400">workers</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detailEmployersSection').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Top Employers</div>
                    <div class="text-warmgray-400 text-sm">No employer data available</div>
                `;
            }
            
            // Render sister locals
            const sisterLocals = detail.sister_locals || [];
            if (sisterLocals.length > 0) {
                document.getElementById('detailSisterLocalsSection').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">
                        Sister Locals (${item.aff_abbr})
                    </div>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        ${sisterLocals.map(local => `
                            <div class="flex justify-between items-center p-2 bg-warmgray-50 rounded hover:bg-warmgray-100 cursor-pointer"
                                 onclick="selectUnionByFnum('${local.f_num}')">
                                <div>
                                    <div class="font-medium text-sm text-warmgray-900">
                                        ${local.local_number ? `Local ${local.local_number}${local.desig_name || ''}` : escapeHtml(local.union_name || 'Unknown')}
                                    </div>
                                    <div class="text-xs text-warmgray-500">${escapeHtml(local.city || '')}, ${local.state || ''}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-warmgray-900">${formatNumber(local.members || 0)}</div>
                                    <div class="text-xs text-warmgray-400">${local.employer_count || 0} employers</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detailSisterLocalsSection').classList.add('hidden');
            }
            
            // Render geographic distribution
            const geoDist = detail.geo_distribution || [];
            if (geoDist.length > 0) {
                const totalWorkers = geoDist.reduce((sum, g) => sum + (g.workers || 0), 0);
                document.getElementById('detailGeoSection').innerHTML = `
                    <div class="text-xs font-semibold text-warmgray-500 uppercase tracking-wide mb-3">Geographic Coverage</div>
                    <div class="space-y-2">
                        ${geoDist.slice(0, 6).map(geo => {
                            const pct = totalWorkers > 0 ? Math.round((geo.workers || 0) / totalWorkers * 100) : 0;
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="w-8 text-xs font-medium text-warmgray-700">${geo.state}</div>
                                    <div class="flex-1 bg-warmgray-200 rounded-full h-2">
                                        <div class="bg-accent-red rounded-full h-2" style="width: ${pct}%"></div>
                                    </div>
                                    <div class="w-20 text-right text-xs text-warmgray-600">
                                        ${formatNumber(geo.workers || 0)} <span class="text-warmgray-400">(${pct}%)</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                document.getElementById('detailGeoSection').classList.add('hidden');
            }
        }
        
        function renderTrendsChart(financials) {
            // Destroy existing chart
            if (trendsChart) {
                trendsChart.destroy();
                trendsChart = null;
            }
            
            if (!financials || financials.length < 2) {
                document.getElementById('detailTrendsSection').classList.add('hidden');
                return;
            }
            
            // Reverse to show chronological order
            const sorted = [...financials].reverse();
            const labels = sorted.map(f => f.yr_covered);
            const memberData = sorted.map(f => f.members || 0);
            const assetData = sorted.map(f => (f.ttl_assets || 0) / 1000); // Convert to thousands
            
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Members',
                            data: memberData,
                            borderColor: '#8B4513',
                            backgroundColor: 'rgba(139, 69, 19, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Assets ($K)',
                            data: assetData,
                            borderColor: '#6B7280',
                            backgroundColor: 'rgba(107, 114, 128, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Members',
                                font: { size: 10 }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value >= 1000 ? (value/1000).toFixed(0) + 'K' : value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Assets ($K)',
                                font: { size: 10 }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        }
        
        async function switchToEmployerAndSelect(employerId) {
            // Switch to employer mode and fetch employer before selecting
            setSearchMode('employers');
            // Fetch the employer and add to results before selecting
            try {
                const response = await fetch(`${API_BASE}/employers/${employerId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.employer) {
                        currentResults = [data.employer];
                        selectItem(employerId);
                    }
                }
            } catch (e) {
                console.error('Failed to load employer:', e);
            }
        }
        
        async function selectUnionByFnum(fNum) {
            // Find the union in current results or fetch it
            const existing = currentResults.find(r => r.f_num === fNum);
            if (existing) {
                selectItem(fNum);
            } else {
                // Fetch and select
                try {
                    const response = await fetch(`${API_BASE}/unions/search?f_num=${fNum}&limit=1`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.results && data.results.length > 0) {
                            currentResults.push(data.results[0]);
                            selectItem(fNum);
                        }
                    }
                } catch (e) {
                    console.error('Failed to load union:', e);
                }
            }
        }
        
        function updateDetailMap(item) {
            if (item.latitude && item.longitude) {
                detailMap.setView([item.latitude, item.longitude], 12);
                if (detailMarker) {
                    detailMarker.setLatLng([item.latitude, item.longitude]);
                } else {
                    detailMarker = L.marker([item.latitude, item.longitude]).addTo(detailMap);
                }
                const popupContent = currentMode === 'employers' 
                    ? `<strong>${item.employer_name}</strong><br>${item.city}, ${item.state}`
                    : `<strong>${formatUnionName(item)}</strong><br>${item.city}, ${item.state}`;
                detailMarker.bindPopup(popupContent);
            }
            
            // Invalidate map size (fixes rendering issues)
            // Using 250ms delay for modal transitions
            setTimeout(() => detailMap.invalidateSize(), 250);
        }
        
        // Helper functions
        function getSectorBadgeClass(sector) {
            const sectorMap = {
                'PRIVATE': 'badge-private',
                'PRIVATE_MIXED': 'badge-private',
                'PUBLIC_SECTOR': 'badge-public',
                'PUBLIC_EDUCATION': 'badge-public',
                'FEDERAL': 'badge-federal',
                'RLA': 'badge-rla',
                'RAILROAD_AIRLINE_RLA': 'badge-rla'
            };
            return sectorMap[sector] || 'badge-private';
        }
        
        function formatSectorName(sector) {
            const sectorNames = {
                'PRIVATE': 'Private',
                'PRIVATE_MIXED': 'Private',
                'PUBLIC_SECTOR': 'Public',
                'PUBLIC_EDUCATION': 'Education',
                'FEDERAL': 'Federal',
                'RLA': 'RLA',
                'RAILROAD_AIRLINE_RLA': 'RLA'
            };
            return sectorNames[sector] || 'Private';
        }
        
        function formatCurrency(num) {
            if (!num) return '—';
            if (num >= 1000000000) {
                return '$' + (num / 1000000000).toFixed(1) + 'B';
            } else if (num >= 1000000) {
                return '$' + (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return '$' + (num / 1000).toFixed(0) + 'K';
            }
            return '$' + num.toLocaleString();
        }
        
        async function viewUnionEmployers(fNum) {
            // Switch to employer mode
            setSearchMode('employers');
            
            // Clear other filters and search for this union's employers
            document.getElementById('mainSearch').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('sectorFilter').value = '';
            clearIndustrySelection();
            
            // Search for employers by union f_num
            currentPage = 1;
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/unions/${fNum}/employers?limit=50`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Transform data to match expected format
                    const transformedData = {
                        total_count: data.total_count,
                        total_workers: data.employers.reduce((sum, e) => sum + (e.latest_unit_size || 0), 0),
                        total_locals: 1,
                        results: data.employers.map(e => ({
                            ...e,
                            union_sector: 'PRIVATE', // May need to lookup
                            latest_union_name: `F-${fNum}`
                        }))
                    };
                    
                    displayResults(transformedData);
                } else {
                    showError('Failed to load employers for this union');
                }
            } catch (e) {
                console.error('Failed to load union employers:', e);
                showError('Failed to load employers. Check API connection.');
            } finally {
                showLoading(false);
            }
        }
        
        // ==========================================
        // STATS TOGGLE
        // ==========================================
        function toggleStats() {
            const expanded = document.getElementById('statsExpanded');
            const toggleText = document.getElementById('statsToggleText');
            const toggleIcon = document.getElementById('statsToggleIcon');
            
            expanded.classList.toggle('open');
            
            if (expanded.classList.contains('open')) {
                toggleText.textContent = 'Hide breakdown';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                toggleText.textContent = 'Show breakdown';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Close modal on backdrop click
        document.getElementById('findSimilarModal').addEventListener('click', (e) => {
            if (e.target.id === 'findSimilarModal') closeFindSimilar();
        });
        
        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            // Escape closes modals
            if (e.key === 'Escape') {
                closeFindSimilar();
                closeNationalDashboard();
                closeNationalBrowser();
                closeOrganizingScorecard();
                closeComparison();
                closeAnalyticsDashboard();
                closeCorporateFamily();
                return;
            }
            
            // Don't handle if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // Arrow keys for list navigation
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                navigateList(e.key === 'ArrowDown' ? 1 : -1);
            }
            
            // Enter to select focused item
            if (e.key === 'Enter' && currentResults.length > 0) {
                const focused = document.querySelector('.list-item.keyboard-focus');
                if (focused) {
                    focused.click();
                }
            }
            
            // Slash to focus search
            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                document.getElementById('mainSearch').focus();
            }
        });
        
        let keyboardFocusIndex = -1;
        
        function navigateList(direction) {
            if (currentResults.length === 0) return;
            
            // Remove previous focus
            document.querySelectorAll('.list-item.keyboard-focus').forEach(el => {
                el.classList.remove('keyboard-focus');
            });
            
            // Calculate new index
            keyboardFocusIndex += direction;
            if (keyboardFocusIndex < 0) keyboardFocusIndex = 0;
            if (keyboardFocusIndex >= currentResults.length) keyboardFocusIndex = currentResults.length - 1;
            
            // Apply focus
            const items = document.querySelectorAll('.list-item');
            if (items[keyboardFocusIndex]) {
                items[keyboardFocusIndex].classList.add('keyboard-focus');
                items[keyboardFocusIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
        
        // Reset keyboard focus when results change
        function resetKeyboardFocus() {
            keyboardFocusIndex = -1;
            document.querySelectorAll('.list-item.keyboard-focus').forEach(el => {
                el.classList.remove('keyboard-focus');
            });
        }
        
        // ==========================================
        // CORPORATE FAMILY
        // ==========================================
        let corporateFamilyMap = null;
        let corporateFamilyMarkers = null;
        
        async function loadCorporateFamily(employerId) {
            // Show loading in the detail section
            document.getElementById('corporateLoadingBadge').classList.remove('hidden');
            document.getElementById('corporateContent').innerHTML = `
                <div class="bg-warmgray-50 border border-dashed border-warmgray-300 rounded-lg p-4 text-center text-sm text-warmgray-400">
                    Searching for related employers...
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/corporate/family/${employerId}`);
                const data = await response.json();
                
                document.getElementById('corporateLoadingBadge').classList.add('hidden');
                
                if (data.total_locations <= 1) {
                    document.getElementById('corporateContent').innerHTML = `
                        <div class="bg-warmgray-50 border border-warmgray-200 rounded-lg p-4 text-sm text-warmgray-500">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-warmgray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>No related employers found in our database.</span>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Show summary in detail panel
                const maxWorkers = Math.max(...data.state_summary.map(s => s.workers));
                document.getElementById('corporateContent').innerHTML = `
                    <div class="bg-gradient-to-r from-warmgray-100 to-warmgray-50 rounded-lg p-4 border border-warmgray-200">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="text-xs text-warmgray-500 uppercase font-semibold">Corporate Family</div>
                                <div class="text-lg font-bold text-warmgray-900">${escapeHtml(data.root_name)}</div>
                            </div>
                            <button onclick="openCorporateFamily(${employerId})" 
                                class="px-4 py-2 bg-warmgray-900 text-white text-sm font-semibold rounded-lg hover:bg-warmgray-800 transition-colors">
                                View All →
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-warmgray-900">${data.total_locations}</div>
                                <div class="text-xs text-warmgray-500">Locations</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-accent-red">${formatNumber(data.total_workers)}</div>
                                <div class="text-xs text-warmgray-500">Workers</div>
                            </div>
                            <div class="bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-warmgray-900">${data.states.length}</div>
                                <div class="text-xs text-warmgray-500">States</div>
                            </div>
                        </div>
                        ${data.state_summary.slice(0, 3).map(s => `
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-xs font-medium w-8">${s.state}</span>
                                <div class="flex-1 h-2 bg-warmgray-200 rounded-full">
                                    <div class="h-full bg-warmgray-600 rounded-full" style="width: ${(s.workers / maxWorkers) * 100}%"></div>
                                </div>
                                <span class="text-xs text-warmgray-500">${formatNumber(s.workers)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                console.error('Corporate family load error:', e);
                document.getElementById('corporateLoadingBadge').classList.add('hidden');
                document.getElementById('corporateContent').innerHTML = `
                    <div class="bg-warmgray-50 border border-warmgray-200 rounded-lg p-4 text-sm text-warmgray-500">
                        Unable to load corporate family data.
                    </div>
                `;
            }
        }
        
        async function openCorporateFamily(employerId) {
            document.getElementById('corporateFamilyModal').classList.remove('hidden');
            document.getElementById('corporateFamilyModal').classList.add('flex');
            document.getElementById('corporateFamilyLoading').classList.remove('hidden');
            document.getElementById('corporateFamilyContent').classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/corporate/family/${employerId}`);
                const data = await response.json();
                
                renderCorporateFamilyModal(data);
            } catch (e) {
                console.error('Corporate family modal error:', e);
                document.getElementById('corporateFamilyLoading').innerHTML = `
                    <div class="text-red-600">Failed to load corporate family data.</div>
                `;
            }
        }
        
        function closeCorporateFamily() {
            document.getElementById('corporateFamilyModal').classList.add('hidden');
            document.getElementById('corporateFamilyModal').classList.remove('flex');
            
            // Clean up map
            if (corporateFamilyMap) {
                corporateFamilyMap.remove();
                corporateFamilyMap = null;
            }
        }
        
        function renderCorporateFamilyModal(data) {
            document.getElementById('corporateFamilyLoading').classList.add('hidden');
            document.getElementById('corporateFamilyContent').classList.remove('hidden');
            
            // Header
            document.getElementById('corporateFamilyTitle').textContent = data.root_name || 'Corporate Family';
            document.getElementById('corporateFamilySubtitle').textContent = `Based on "${data.source.employer_name}"`;
            
            // Summary cards
            document.getElementById('cfLocations').textContent = formatNumber(data.total_locations);
            document.getElementById('cfWorkers').textContent = formatNumber(data.total_workers);
            document.getElementById('cfStates').textContent = data.states.length;
            document.getElementById('cfUnions').textContent = data.unique_unions || 0;
            
            // Root name
            document.getElementById('cfRootName').textContent = data.root_name;
            
            // Location count
            document.getElementById('cfLocationCount').textContent = `${data.family_members.length} employers`;
            
            // Location list
            document.getElementById('cfLocationList').innerHTML = data.family_members.slice(0, 100).map(m => `
                <div class="px-4 py-3 hover:bg-warmgray-50 cursor-pointer" onclick="selectCorporateLocation('${m.employer_id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-warmgray-900">${escapeHtml(m.employer_name)}</div>
                            <div class="text-sm text-warmgray-500">${m.city || '—'}, ${m.state || '—'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-warmgray-900">${formatNumber(m.latest_unit_size || 0)}</div>
                            <div class="text-xs text-warmgray-400">workers</div>
                        </div>
                    </div>
                    ${m.aff_abbr ? `<div class="mt-1"><span class="badge badge-private">${escapeHtml(m.aff_abbr)}</span></div>` : ''}
                </div>
            `).join('');
            
            // By State breakdown
            if (data.state_summary && data.state_summary.length > 0) {
                const maxWorkers = Math.max(...data.state_summary.map(s => s.workers));
                document.getElementById('cfByState').innerHTML = data.state_summary.map(s => `
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-semibold w-6">${s.state}</span>
                        <div class="flex-1 h-2 bg-warmgray-200 rounded-full">
                            <div class="h-full bg-accent-red rounded-full" style="width: ${(s.workers / maxWorkers) * 100}%"></div>
                        </div>
                        <span class="text-xs text-warmgray-500 w-16 text-right">${formatNumber(s.workers)}</span>
                        <span class="text-xs text-warmgray-400 w-8">(${s.count})</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('cfByState').innerHTML = '<div class="text-sm text-warmgray-400">No state data</div>';
            }
            
            // By Union breakdown
            if (data.union_summary && data.union_summary.length > 0) {
                const maxWorkers = Math.max(...data.union_summary.map(u => u.workers));
                document.getElementById('cfByUnion').innerHTML = data.union_summary.map(u => `
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-semibold flex-1 truncate">${escapeHtml(u.union)}</span>
                        <div class="w-20 h-2 bg-warmgray-200 rounded-full">
                            <div class="h-full bg-blue-500 rounded-full" style="width: ${(u.workers / maxWorkers) * 100}%"></div>
                        </div>
                        <span class="text-xs text-warmgray-500 w-16 text-right">${formatNumber(u.workers)}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('cfByUnion').innerHTML = '<div class="text-sm text-warmgray-400">No union data</div>';
            }
            
            // Initialize map
            setTimeout(() => initCorporateFamilyMap(data.family_members), 100);
        }
        
        function initCorporateFamilyMap(locations) {
            // Clean up existing map
            if (corporateFamilyMap) {
                corporateFamilyMap.remove();
            }
            
            // Create map
            corporateFamilyMap = L.map('corporateFamilyMap').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(corporateFamilyMap);
            
            // Add markers
            corporateFamilyMarkers = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class="corporate-cluster">${count}</div>`,
                        className: 'corporate-cluster-icon',
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            const validLocations = locations.filter(loc => loc.latitude && loc.longitude);
            
            validLocations.forEach(loc => {
                const marker = L.marker([loc.latitude, loc.longitude]);
                marker.bindPopup(`
                    <div class="text-sm">
                        <div class="font-semibold">${escapeHtml(loc.employer_name)}</div>
                        <div class="text-warmgray-500">${loc.city}, ${loc.state}</div>
                        <div class="mt-1">${formatNumber(loc.latest_unit_size || 0)} workers</div>
                        ${loc.aff_abbr ? `<div class="text-xs text-blue-600">${escapeHtml(loc.aff_abbr)}</div>` : ''}
                    </div>
                `);
                corporateFamilyMarkers.addLayer(marker);
            });
            
            corporateFamilyMap.addLayer(corporateFamilyMarkers);
            
            // Fit bounds if we have valid locations
            if (validLocations.length > 0) {
                const bounds = L.latLngBounds(validLocations.map(l => [l.latitude, l.longitude]));
                corporateFamilyMap.fitBounds(bounds, { padding: [30, 30] });
            }
        }
        
        function selectCorporateLocation(employerId) {
            // Close modal and load employer in main view
            closeCorporateFamily();
            
            // Search for this employer
            document.getElementById('searchInput').value = '';
            currentMode = 'employers';
            loadSearchResults({ employer_id: employerId });
        }
        
        // ==========================================
        // ANALYTICS DASHBOARD
        // ==========================================
        let dashboardCharts = {};
        
        async function openAnalyticsDashboard() {
            document.getElementById('analyticsDashboardModal').classList.remove('hidden');
            document.getElementById('analyticsDashboardModal').classList.add('flex');
            document.body.classList.add('modal-open');
            document.getElementById('dashboardLoading').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');

            try {
                // Load data using existing endpoints
                const [summaryData, nationalTrends, electionTrends, recentElections] = await Promise.all([
                    fetch(`${API_BASE}/summary`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/national?start_year=2010&end_year=2024`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/elections`).then(r => r.json()),
                    fetch(`${API_BASE}/nlrb/elections/search?limit=10`).then(r => r.json())
                ]);

                // Transform data to expected format
                const summary = {
                    total_unions: summaryData.unions?.total_unions || 0,
                    total_members: summaryData.unions?.total_members || 0,
                    total_employers: summaryData.employers?.total_employers || 0,
                    covered_workers: summaryData.employers?.covered_workers || 0,
                    osha_establishments: 0,
                    nlrb_cases_1yr: summaryData.nlrb?.elections?.total_elections || 0,
                    nlrb_wins_1yr: summaryData.nlrb?.elections?.union_wins || 0,
                    nlrb_losses_1yr: (summaryData.nlrb?.elections?.total_elections || 0) - (summaryData.nlrb?.elections?.union_wins || 0),
                    top_affiliations: [],
                    top_industries: []
                };

                const trends = {
                    membership_by_year: (nationalTrends.trends || []).map(t => ({
                        year: t.year,
                        total_members: t.total_members_raw || t.total_members
                    })),
                    nlrb_by_year: (electionTrends.election_trends || []).map(e => ({
                        year: e.year,
                        wins: e.union_wins,
                        losses: e.union_losses
                    })),
                    f7_filings_by_year: [],
                    osha_by_year: []
                };

                const nlrbRecent = {
                    recent_elections: (recentElections.elections || []).slice(0, 10)
                };

                const growth = {};
                const geographic = { unions_by_state: [] };

                renderDashboard(summary, trends, nlrbRecent, growth, geographic);
            } catch (e) {
                console.error('Dashboard load failed:', e);
                document.getElementById('dashboardLoading').innerHTML = `
                    <div class="text-red-600">Failed to load dashboard. Check that the API is running.</div>
                `;
            }
        }
        
        function closeAnalyticsDashboard() {
            document.getElementById('analyticsDashboardModal').classList.add('hidden');
            document.getElementById('analyticsDashboardModal').classList.remove('flex');
            document.body.classList.remove('modal-open');

            // Destroy charts to prevent memory leaks
            Object.values(dashboardCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            dashboardCharts = {};
        }
        
        function renderDashboard(summary, trends, nlrbRecent, growth, geographic) {
            // Hide loading, show content
            document.getElementById('dashboardLoading').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            
            // Summary cards
            document.getElementById('dashUnions').textContent = formatNumber(summary.total_unions || 0);
            document.getElementById('dashMembers').textContent = formatNumber(summary.total_members || 0);
            document.getElementById('dashEmployers').textContent = formatNumber(summary.total_employers || 0);
            document.getElementById('dashWorkers').textContent = formatNumber(summary.covered_workers || 0);
            document.getElementById('dashOsha').textContent = formatNumber(summary.osha_establishments || 0);
            document.getElementById('dashNlrb').textContent = formatNumber(summary.nlrb_cases_1yr || 0);
            
            const wins = summary.nlrb_wins_1yr || 0;
            const losses = summary.nlrb_losses_1yr || 0;
            if (wins || losses) {
                document.getElementById('dashNlrbWins').textContent = `${wins} wins / ${losses} losses`;
            }
            
            // Render charts
            renderMembershipChart(trends.membership_by_year || []);
            renderNlrbChart(trends.nlrb_by_year || []);
            renderF7Chart(trends.f7_filings_by_year || []);
            renderOshaChart(trends.osha_by_year || []);
            
            // Render tables
            renderRecentNlrb(nlrbRecent.recent_elections || []);
            renderGrowthTables(growth);
            renderTopStates(geographic.unions_by_state || []);
            renderTopAffiliations(summary.top_affiliations || []);
            renderTopIndustries(summary.top_industries || []);
        }
        
        function renderMembershipChart(data) {
            const ctx = document.getElementById('membershipChart').getContext('2d');
            if (dashboardCharts.membership) dashboardCharts.membership.destroy();
            
            dashboardCharts.membership = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: 'Total Members',
                        data: data.map(d => (d.total_members || 0) / 1000000),
                        borderColor: '#c73e1d',
                        backgroundColor: 'rgba(199, 62, 29, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.parsed.y.toFixed(1)}M members`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Members (millions)' }
                        }
                    }
                }
            });
        }
        
        function renderNlrbChart(data) {
            const ctx = document.getElementById('nlrbChart').getContext('2d');
            if (dashboardCharts.nlrb) dashboardCharts.nlrb.destroy();
            
            dashboardCharts.nlrb = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: 'Union Wins',
                        data: data.map(d => d.union_wins || 0),
                        backgroundColor: '#22c55e'
                    }, {
                        label: 'Union Losses',
                        data: data.map(d => d.union_losses || 0),
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }
        
        function renderF7Chart(data) {
            const ctx = document.getElementById('f7Chart').getContext('2d');
            if (dashboardCharts.f7) dashboardCharts.f7.destroy();
            
            dashboardCharts.f7 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: 'Filings',
                        data: data.map(d => d.filings || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    }, {
                        label: 'Workers Covered',
                        data: data.map(d => (d.workers_covered || 0) / 1000),
                        borderColor: '#8b5cf6',
                        borderDash: [5, 5],
                        tension: 0.3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Filings' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Workers (thousands)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function renderOshaChart(data) {
            const ctx = document.getElementById('oshaChart').getContext('2d');
            if (dashboardCharts.osha) dashboardCharts.osha.destroy();
            
            dashboardCharts.osha = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: 'Total Violations',
                        data: data.map(d => d.violations || 0),
                        backgroundColor: '#f59e0b'
                    }, {
                        label: 'Serious',
                        data: data.map(d => d.serious_violations || 0),
                        backgroundColor: '#dc2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function renderRecentNlrb(elections) {
            const el = document.getElementById('recentNlrb');
            if (!elections.length) {
                el.innerHTML = '<div class="text-warmgray-400 text-sm">No recent elections</div>';
                return;
            }
            
            el.innerHTML = elections.slice(0, 15).map(e => {
                const statusClass = (e.status || '').toLowerCase().includes('certif') || (e.status || '').toLowerCase().includes('won')
                    ? 'text-green-600' 
                    : (e.status || '').toLowerCase().includes('dismiss') || (e.status || '').toLowerCase().includes('withdraw')
                        ? 'text-red-600'
                        : 'text-warmgray-500';
                return `
                    <div class="text-sm border-l-2 border-warmgray-200 pl-2 py-1">
                        <div class="font-medium text-warmgray-900 truncate">${escapeHtml(e.case_name || 'Unknown')}</div>
                        <div class="text-xs text-warmgray-500">${e.city || ''}, ${e.state || ''} · ${e.date_filed || ''}</div>
                        <div class="text-xs ${statusClass}">${escapeHtml(e.status || 'Unknown')}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderGrowthTables(growth) {
            const growingEl = document.getElementById('growingUnions');
            const decliningEl = document.getElementById('decliningUnions');
            
            if (growth.growing && growth.growing.length > 0) {
                growingEl.innerHTML = growth.growing.map(u => `
                    <div class="flex justify-between items-center text-sm py-1 border-b border-warmgray-100">
                        <span class="font-medium">${escapeHtml(u.affiliation)}</span>
                        <span class="text-green-600 font-semibold">+${u.pct_change}%</span>
                    </div>
                `).join('');
            } else {
                growingEl.innerHTML = '<div class="text-warmgray-400 text-sm">No growth data available</div>';
            }
            
            if (growth.declining && growth.declining.length > 0) {
                decliningEl.innerHTML = growth.declining.map(u => `
                    <div class="flex justify-between items-center text-sm py-1 border-b border-warmgray-100">
                        <span class="font-medium">${escapeHtml(u.affiliation)}</span>
                        <span class="text-red-600 font-semibold">${u.pct_change}%</span>
                    </div>
                `).join('');
            } else {
                decliningEl.innerHTML = '<div class="text-warmgray-400 text-sm">No decline data available</div>';
            }
        }
        
        function renderTopStates(states) {
            const el = document.getElementById('topStates');
            const maxMembers = Math.max(...states.map(s => s.total_members || 0));
            
            el.innerHTML = states.slice(0, 15).map(s => {
                const pct = maxMembers > 0 ? ((s.total_members || 0) / maxMembers) * 100 : 0;
                return `
                    <div class="text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="font-medium">${s.state}</span>
                            <span class="text-warmgray-500">${formatNumber(s.total_members || 0)}</span>
                        </div>
                        <div class="h-1.5 bg-warmgray-200 rounded-full">
                            <div class="h-full bg-accent-red rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTopAffiliations(affiliations) {
            const el = document.getElementById('topAffiliations');
            
            el.innerHTML = affiliations.map(a => `
                <div class="flex justify-between items-center text-sm py-1 border-b border-warmgray-100 cursor-pointer hover:bg-warmgray-50"
                     onclick="closeAnalyticsDashboard(); openNationalDashboard('${escapeHtml(a.aff_abbr)}')">
                    <div>
                        <span class="font-semibold text-warmgray-900">${escapeHtml(a.aff_abbr)}</span>
                        <span class="text-warmgray-400 ml-2">${formatNumber(a.locals)} locals</span>
                    </div>
                    <span class="text-accent-red font-medium">${formatNumber(a.members || 0)}</span>
                </div>
            `).join('');
        }
        
        function renderTopIndustries(industries) {
            const el = document.getElementById('topIndustries');
            
            el.innerHTML = industries.map(i => `
                <div class="flex justify-between items-center text-sm py-1 border-b border-warmgray-100">
                    <span class="truncate flex-1 mr-2">${escapeHtml(i.sector_name || 'Unknown')}</span>
                    <span class="text-warmgray-500 whitespace-nowrap">${formatNumber(i.workers || 0)} workers</span>
                </div>
            `).join('');
        }
        
        // ==========================================
        // ORGANIZING SCORECARD
        // ==========================================
        let scorecardResults = [];
        let selectedScorecardItem = null;
        
        async function openOrganizingScorecard() {
            document.getElementById('scorecardModal').classList.remove('hidden');
            document.getElementById('scorecardModal').classList.add('flex');
            document.body.classList.add('modal-open');

            // Populate state dropdown with same states as main filter
            const stateSelect = document.getElementById('scorecardState');
            if (stateSelect.options.length <= 1) {
                const mainStateSelect = document.getElementById('stateFilter');
                for (let i = 1; i < mainStateSelect.options.length; i++) {
                    const opt = mainStateSelect.options[i];
                    stateSelect.add(new Option(opt.text, opt.value));
                }
            }
        }
        
        function closeOrganizingScorecard() {
            document.getElementById('scorecardModal').classList.add('hidden');
            document.getElementById('scorecardModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        function loadAFSCME_NY_Preset() {
            // Set filters for AFSCME NY case study
            // Healthcare (62), Education (61), Other Services (81)
            document.getElementById('scorecardState').value = 'NY';
            document.getElementById('scorecardIndustry').value = '62';  // Healthcare - largest AFSCME sector
            document.getElementById('scorecardMinEmp').value = '25';
            document.getElementById('scorecardMaxEmp').value = '5000';
            document.getElementById('scorecardMinScore').value = '20';
            document.getElementById('scorecardContracts').value = '';  // All

            // Load results
            loadScorecardResults();
        }
        
        async function loadScorecardResults() {
            const state = document.getElementById('scorecardState').value;
            const industry = document.getElementById('scorecardIndustry').value;
            const minEmp = document.getElementById('scorecardMinEmp').value || 50;
            const maxEmp = document.getElementById('scorecardMaxEmp').value || 5000;
            const minScore = document.getElementById('scorecardMinScore').value || 0;
            const hasContracts = document.getElementById('scorecardContracts').value;

            // Show loading
            document.getElementById('scorecardLoading').classList.remove('hidden');
            document.getElementById('scorecardContent').classList.add('hidden');

            const params = new URLSearchParams({
                min_employees: minEmp,
                max_employees: maxEmp,
                min_score: minScore,
                limit: 100
            });

            if (state) params.append('state', state);
            if (industry) params.append('naics_2digit', industry);
            if (hasContracts) params.append('has_contracts', hasContracts);
            
            try {
                const response = await fetch(`${API_BASE}/organizing/scorecard?${params}`);
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                scorecardResults = data.results || [];
                
                renderScorecardResults(data);
            } catch (e) {
                console.error('Scorecard failed:', e);
                document.getElementById('scorecardResultsInfo').textContent = 'Error loading results. Check that the API is running.';
            } finally {
                document.getElementById('scorecardLoading').classList.add('hidden');
                document.getElementById('scorecardContent').classList.remove('hidden');
            }
        }
        
        function renderScorecardResults(data) {
            const infoEl = document.getElementById('scorecardResultsInfo');
            const resultsEl = document.getElementById('scorecardResults');
            
            infoEl.textContent = `${formatNumber(data.scored_count || data.results?.length || 0)} establishments scored (showing top ${data.results?.length || 0})`;
            
            if (!data.results || data.results.length === 0) {
                resultsEl.innerHTML = '<div class="p-8 text-center text-warmgray-400">No results found. Try adjusting filters.</div>';
                return;
            }
            
            resultsEl.innerHTML = data.results.map((item, idx) => `
                <div class="p-4 cursor-pointer hover:bg-warmgray-50 transition-colors ${selectedScorecardItem?.establishment_id === item.establishment_id ? 'bg-green-50 border-l-4 border-green-500' : ''}"
                     onclick="selectScorecardItem('${item.establishment_id}')">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-warmgray-400">#${idx + 1}</span>
                                <div class="font-semibold text-warmgray-900 truncate">${escapeHtml(item.estab_name || 'Unknown')}</div>
                                ${item.contract_info?.contract_count > 0 ? '<span class="badge bg-orange-100 text-orange-700">Has Contracts</span>' : ''}
                            </div>
                            <div class="text-sm text-warmgray-500 truncate">
                                ${escapeHtml(item.site_city || '')}, ${item.site_state || ''} · NAICS ${item.naics_code || 'N/A'}
                            </div>
                        </div>
                        <div class="text-right ml-3">
                            <div class="text-2xl font-bold ${getScoreColor(item.organizing_score)}">${item.organizing_score}</div>
                            <div class="text-xs text-warmgray-400">score</div>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        ${renderMiniScoreBar(item.score_breakdown)}
                    </div>
                    <div class="flex justify-between text-xs text-warmgray-400 mt-2">
                        <span>${formatNumber(item.employee_count || 0)} employees</span>
                        <span>${item.total_violations || 0} violations</span>
                        ${item.contract_info?.total_funding > 0 ? `<span class="text-orange-600">$${formatNumber(item.contract_info.total_funding)} funding</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function getScoreColor(score) {
            if (score >= 70) return 'text-green-600';
            if (score >= 50) return 'text-yellow-600';
            if (score >= 30) return 'text-orange-500';
            return 'text-warmgray-400';
        }
        
        function renderMiniScoreBar(breakdown) {
            if (!breakdown) return '';
            // New 8-factor scoring system (0-100 points total)
            const segments = [
                { value: breakdown.company_unions || 0, max: 20, color: 'bg-indigo-500', label: 'Union Shops' },
                { value: breakdown.industry_density || 0, max: 10, color: 'bg-blue-500', label: 'Industry' },
                { value: breakdown.state_density || 0, max: 10, color: 'bg-purple-500', label: 'State' },
                { value: breakdown.size || 0, max: 10, color: 'bg-yellow-500', label: 'Size' },
                { value: breakdown.osha || 0, max: 10, color: 'bg-red-500', label: 'OSHA' },
                { value: breakdown.nlrb || 0, max: 10, color: 'bg-green-500', label: 'NLRB' },
                { value: breakdown.contracts || 0, max: 10, color: 'bg-orange-500', label: 'Contracts' },
                { value: breakdown.projections || 0, max: 10, color: 'bg-teal-500', label: 'Growth' }
            ];

            return `<div class="flex-1 h-2 bg-warmgray-200 rounded-full overflow-hidden flex">
                ${segments.map(s => `<div class="${s.color}" style="width: ${s.value}%" title="${s.label}: ${s.value}/${s.max}"></div>`).join('')}
            </div>`;
        }
        
        async function selectScorecardItem(estabId) {
            const item = scorecardResults.find(r => r.establishment_id === estabId);
            if (!item) return;
            
            selectedScorecardItem = item;
            
            // Re-render list to show selection
            renderScorecardResults({ results: scorecardResults, scored_count: scorecardResults.length });
            
            // Show detail panel
            document.getElementById('scorecardDetailEmpty').classList.add('hidden');
            document.getElementById('scorecardDetail').classList.remove('hidden');
            
            // Load detailed scorecard
            try {
                const response = await fetch(`${API_BASE}/organizing/scorecard/${estabId}`);
                if (!response.ok) throw new Error('API error');
                
                const detail = await response.json();
                renderScorecardDetail(detail);
            } catch (e) {
                console.error('Scorecard detail failed:', e);
                renderScorecardDetail({ establishment: item, organizing_score: item.organizing_score, score_breakdown: item.score_breakdown });
            }
        }
        
        function renderScorecardDetail(detail) {
            const el = document.getElementById('scorecardDetail');
            const estab = detail.establishment || {};
            const breakdown = detail.score_breakdown || {};
            const violations = detail.violations || {};
            const contracts = detail.contracts || {};
            const context = detail.context || {};

            el.innerHTML = `
                <!-- Header -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-warmgray-900">${escapeHtml(estab.estab_name || 'Unknown')}</h3>
                    <p class="text-warmgray-500">${escapeHtml(estab.site_city || '')}, ${estab.site_state || ''} ${estab.site_zip || ''}</p>
                    <div class="flex gap-2 mt-2 flex-wrap">
                        <span class="badge badge-industry">NAICS ${estab.naics_code || 'N/A'}</span>
                        <span class="badge badge-private">${formatNumber(estab.employee_count || 0)} employees</span>
                        ${contracts.contract_count > 0 ? '<span class="badge bg-orange-100 text-orange-700">Has Govt Contracts</span>' : ''}
                    </div>
                </div>

                <!-- Score breakdown -->
                <div class="bg-gradient-to-r from-green-50 to-warmgray-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-semibold text-warmgray-700">Organizing Potential Score</span>
                        <span class="text-4xl font-bold ${getScoreColor(detail.organizing_score)}">${detail.organizing_score}</span>
                    </div>

                    <div class="space-y-3">
                        ${renderScoreRow('Company Union Shops', breakdown.company_unions, 20, 'bg-indigo-500', 'Related company locations with union presence')}
                        ${renderScoreRow('Industry Density', breakdown.industry_density, 10, 'bg-blue-500', 'Union membership rate in NAICS sector')}
                        ${renderScoreRow('State Density', breakdown.state_density, 10, 'bg-purple-500', 'State union membership vs national average')}
                        ${renderScoreRow('Establishment Size', breakdown.size, 10, 'bg-yellow-500', 'Sweet spot 100-500 employees')}
                        ${renderScoreRow('OSHA Violations', breakdown.osha, 10, 'bg-red-500', 'Workplace safety violations on record')}
                        ${renderScoreRow('NLRB History', breakdown.nlrb, 10, 'bg-green-500', 'Past election activity for this employer')}
                        ${renderScoreRow('Govt Contracts', breakdown.contracts, 10, 'bg-orange-500', 'NY State & NYC contract funding')}
                        ${renderScoreRow('Industry Growth', breakdown.projections, 10, 'bg-teal-500', 'BLS industry employment projections')}
                    </div>
                </div>

                <!-- Government Contracts -->
                ${contracts.contract_count > 0 ? `
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Government Contracts</h4>
                    <div class="bg-orange-50 rounded-lg p-3 mb-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-orange-700">${contracts.contract_count} contract(s)</span>
                            <span class="text-sm font-semibold text-orange-700">$${formatNumber(contracts.total_funding || 0)} total</span>
                        </div>
                    </div>
                    ${contracts.records && contracts.records.length > 0 ? `
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${contracts.records.slice(0, 5).map(c => `
                                <div class="text-sm border-l-2 border-orange-300 pl-2">
                                    <div class="font-medium text-warmgray-700">${escapeHtml(c.title || 'Contract')}</div>
                                    <div class="text-xs text-warmgray-500">${c.source || ''} · ${c.agency_name || ''} · $${formatNumber(c.amount || 0)}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- Violations detail -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Safety Violations</h4>
                    ${violations.count > 0 ? `
                        <div class="bg-red-50 rounded-lg p-3 mb-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-red-700">${violations.count} total violations</span>
                                <span class="text-sm text-red-700">Severity: ${violations.severity_score || 0}</span>
                            </div>
                        </div>
                        ${violations.recent && violations.recent.length > 0 ? `
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${violations.recent.slice(0, 5).map(v => `
                                    <div class="text-sm border-l-2 border-red-300 pl-2">
                                        <div class="font-medium text-warmgray-700">${escapeHtml(v.standard || 'Unknown standard')}</div>
                                        <div class="text-xs text-warmgray-500">${v.violation_type || ''} · ${v.issuance_date || ''} · $${formatNumber(v.current_penalty || 0)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    ` : '<div class="text-warmgray-400 text-sm">No OSHA violations on record</div>'}
                </div>

                <!-- Context -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Organizing Context</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-warmgray-100 rounded p-3">
                            <div class="text-warmgray-500">Unions in ${estab.site_state || 'state'}</div>
                            <div class="font-semibold text-warmgray-900">${formatNumber(context.state_union_presence?.union_count || 0)} locals</div>
                        </div>
                        <div class="bg-warmgray-100 rounded p-3">
                            <div class="text-warmgray-500">Industry union employers</div>
                            <div class="font-semibold text-warmgray-900">${formatNumber(context.industry_union_presence?.union_employers || 0)}</div>
                        </div>
                        <div class="bg-warmgray-100 rounded p-3">
                            <div class="text-warmgray-500">Recent NLRB cases</div>
                            <div class="font-semibold text-warmgray-900">${formatNumber(context.nlrb_activity?.case_count || 0)} (3 yr)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Nearby unions -->
                ${detail.nearby_unions && detail.nearby_unions.length > 0 ? `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Active Unions in ${estab.site_state || 'State'}</h4>
                        <div class="flex flex-wrap gap-2">
                            ${detail.nearby_unions.map(u => `
                                <span class="px-2 py-1 bg-warmgray-100 rounded text-sm">
                                    ${escapeHtml(u.aff_abbr)} <span class="text-warmgray-400">(${u.local_count})</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Similar union employers -->
                ${detail.similar_union_employers && detail.similar_union_employers.length > 0 ? `
                    <div>
                        <h4 class="text-sm font-semibold text-warmgray-700 uppercase tracking-wide mb-3">Similar Unionized Employers</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${detail.similar_union_employers.map(e => `
                                <div class="text-sm border-l-2 border-green-300 pl-2">
                                    <div class="font-medium text-warmgray-700">${escapeHtml(e.employer_name)}</div>
                                    <div class="text-xs text-warmgray-500">
                                        ${escapeHtml(e.city || '')}, ${e.state || ''} · 
                                        ${formatNumber(e.latest_unit_size || 0)} workers · 
                                        <span class="text-green-600">${escapeHtml(e.aff_abbr || e.union_name || 'Union')}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function renderScoreRow(label, score, max, colorClass, description) {
            const pct = Math.round((score / max) * 100);
            return `
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-warmgray-600" title="${description}">${label}</span>
                        <span class="font-semibold">${score || 0}/${max}</span>
                    </div>
                    <div class="h-2 bg-warmgray-200 rounded-full overflow-hidden">
                        <div class="${colorClass} h-full rounded-full transition-all" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // COMPARISON VIEW
        // ==========================================
        function openComparison() {
            document.getElementById('comparisonModal').classList.remove('hidden');
            document.getElementById('comparisonModal').classList.add('flex');
            renderComparison();
        }
        
        function closeComparison() {
            document.getElementById('comparisonModal').classList.add('hidden');
            document.getElementById('comparisonModal').classList.remove('flex');
        }
        
        function addToComparison(item) {
            // Find first empty slot
            if (!comparisonItems[0]) {
                comparisonItems[0] = item;
            } else if (!comparisonItems[1]) {
                comparisonItems[1] = item;
            } else {
                // Both full - replace second
                comparisonItems[1] = item;
            }
            
            updateComparisonBadge();
            renderComparison();
            
            // Auto-open if we have 2 items
            if (comparisonItems[0] && comparisonItems[1]) {
                openComparison();
            }
        }
        
        function removeFromComparison(index) {
            comparisonItems[index] = null;
            updateComparisonBadge();
            renderComparison();
        }
        
        function clearComparison() {
            comparisonItems = [null, null];
            updateComparisonBadge();
            renderComparison();
        }
        
        function updateComparisonBadge() {
            const count = comparisonItems.filter(Boolean).length;
            const badge = document.getElementById('comparisonBadge');
            if (badge) {
                badge.textContent = count;
                badge.classList.toggle('hidden', count === 0);
            }
        }
        
        function renderComparison() {
            const subtitle = currentMode === 'employers' ? 'Employer comparison' : 'Union comparison';
            document.getElementById('comparisonSubtitle').textContent = subtitle;
            
            // Render left
            document.getElementById('compareLeft').innerHTML = comparisonItems[0] 
                ? renderComparisonCard(comparisonItems[0], 0)
                : '<div class="text-center text-warmgray-400 py-8"><p>Select first item to compare</p></div>';
            
            // Render right
            document.getElementById('compareRight').innerHTML = comparisonItems[1]
                ? renderComparisonCard(comparisonItems[1], 1)
                : '<div class="text-center text-warmgray-400 py-8"><p>Select second item to compare</p></div>';
        }
        
        function renderComparisonCard(item, index) {
            if (currentMode === 'employers') {
                return `
                    <div class="relative">
                        <button onclick="removeFromComparison(${index})" 
                            class="absolute top-0 right-0 p-1 text-warmgray-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <h3 class="font-bold text-lg text-warmgray-900 pr-6">${escapeHtml(item.employer_name)}</h3>
                        <p class="text-sm text-warmgray-500 mb-4">${escapeHtml(item.city || '')}, ${item.state || ''}</p>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Workers</span>
                                <span class="font-semibold">${formatNumber(item.latest_unit_size || 0)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Industry</span>
                                <span class="font-medium text-sm">${escapeHtml(item.naics_sector_name || 'N/A')}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">NAICS</span>
                                <span class="font-medium">${item.naics || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Union</span>
                                <span class="font-medium text-sm">${escapeHtml(item.latest_union_name || 'N/A')}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-warmgray-500">Latest Notice</span>
                                <span class="font-medium">${item.latest_notice_date || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="relative">
                        <button onclick="removeFromComparison(${index})" 
                            class="absolute top-0 right-0 p-1 text-warmgray-400 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <h3 class="font-bold text-lg text-warmgray-900 pr-6">${escapeHtml(item.union_name)}</h3>
                        <p class="text-sm text-warmgray-500 mb-1">${item.local_number ? `Local ${item.local_number}` : ''}</p>
                        <p class="text-sm text-warmgray-500 mb-4">${escapeHtml(item.city || '')}, ${item.state || ''}</p>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Members</span>
                                <span class="font-semibold text-accent-red">${formatNumber(item.members || 0)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Affiliation</span>
                                <span class="font-medium">${item.aff_abbr || 'Independent'}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Sector</span>
                                <span class="font-medium">${formatSectorName(item.sector)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-warmgray-100">
                                <span class="text-warmgray-500">Employers</span>
                                <span class="font-medium">${formatNumber(item.f7_employer_count || 0)}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-warmgray-500">Workers Covered</span>
                                <span class="font-medium">${formatNumber(item.f7_total_workers || 0)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function isInComparison(itemId) {
            return comparisonItems.some(item => {
                if (!item) return false;
                const id = currentMode === 'employers' ? item.employer_id : item.f_num;
                return String(id) === String(itemId);
            });
        }
        
        // ==========================================
        // SAVED SEARCHES
        // ==========================================
        const SAVED_SEARCHES_KEY = 'laborPlatform_savedSearches';
        
        function toggleSavedSearches() {
            const dropdown = document.getElementById('savedSearchesDropdown');
            const isHidden = dropdown.classList.contains('hidden');
            
            // Close dropdown when clicking outside
            if (isHidden) {
                dropdown.classList.remove('hidden');
                renderSavedSearches();
                setTimeout(() => {
                    document.addEventListener('click', closeSavedSearchesOnClickOutside);
                }, 0);
            } else {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeSavedSearchesOnClickOutside);
            }
        }
        
        function closeSavedSearchesOnClickOutside(e) {
            const dropdown = document.getElementById('savedSearchesDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('[onclick*="toggleSavedSearches"]')) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeSavedSearchesOnClickOutside);
            }
        }
        
        function getSavedSearches() {
            try {
                return JSON.parse(localStorage.getItem(SAVED_SEARCHES_KEY)) || [];
            } catch {
                return [];
            }
        }
        
        function saveSavedSearches(searches) {
            localStorage.setItem(SAVED_SEARCHES_KEY, JSON.stringify(searches));
        }
        
        function saveCurrentSearch() {
            const name = prompt('Name this search:');
            if (!name || !name.trim()) return;
            
            const search = {
                id: Date.now(),
                name: name.trim(),
                mode: currentMode,
                query: document.getElementById('mainSearch').value,
                industry: document.getElementById('industrySearch').value,
                state: document.getElementById('stateFilter').value,
                metro: document.getElementById('metroFilter')?.value || '',
                city: document.getElementById('cityFilter')?.value || '',
                sector: document.getElementById('sectorFilter')?.value || '',
                createdAt: new Date().toISOString()
            };
            
            const searches = getSavedSearches();
            searches.unshift(search);
            
            // Keep only last 20 searches
            if (searches.length > 20) searches.pop();
            
            saveSavedSearches(searches);
            renderSavedSearches();
        }
        
        function renderSavedSearches() {
            const searches = getSavedSearches();
            const container = document.getElementById('savedSearchesList');
            
            if (searches.length === 0) {
                container.innerHTML = '<div class="p-3 text-sm text-warmgray-400 text-center">No saved searches</div>';
                return;
            }
            
            container.innerHTML = searches.map(s => `
                <div class="flex items-center justify-between px-3 py-2 hover:bg-warmgray-50 group">
                    <button onclick="loadSavedSearch(${s.id})" class="flex-1 text-left">
                        <div class="text-sm font-medium text-warmgray-900">${escapeHtml(s.name)}</div>
                        <div class="text-xs text-warmgray-400">
                            ${s.mode === 'employers' ? 'Employers' : 'Unions'}
                            ${s.state ? ` · ${s.state}` : ''}
                            ${s.query ? ` · "${escapeHtml(s.query)}"` : ''}
                        </div>
                    </button>
                    <button onclick="deleteSavedSearch(${s.id})" 
                        class="opacity-0 group-hover:opacity-100 p-1 text-warmgray-400 hover:text-red-500 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        function loadSavedSearch(id) {
            const searches = getSavedSearches();
            const search = searches.find(s => s.id === id);
            if (!search) return;
            
            // Set mode
            setSearchMode(search.mode);
            
            // Set filters
            document.getElementById('mainSearch').value = search.query || '';
            document.getElementById('industrySearch').value = search.industry || '';
            
            // Load state and dependent filters
            if (search.state) {
                document.getElementById('stateFilter').value = search.state;
                onStateChange().then(() => {
                    if (search.metro) document.getElementById('metroFilter').value = search.metro;
                    if (search.city) document.getElementById('cityFilter').value = search.city;
                });
            }
            
            if (search.sector && document.getElementById('sectorFilter')) {
                document.getElementById('sectorFilter').value = search.sector;
            }
            
            // Close dropdown and execute search
            document.getElementById('savedSearchesDropdown').classList.add('hidden');
            
            // Small delay to let filters settle
            setTimeout(() => executeSearch(), 100);
        }
        
        function deleteSavedSearch(id) {
            if (!confirm('Delete this saved search?')) return;
            
            const searches = getSavedSearches().filter(s => s.id !== id);
            saveSavedSearches(searches);
            renderSavedSearches();
        }
        
        // ==========================================
        // URL DEEP LINKING
        // ==========================================
        function updateUrl() {
            const params = new URLSearchParams();
            
            // Mode
            params.set('mode', currentMode);
            
            // Search query
            const q = document.getElementById('mainSearch').value.trim();
            if (q) params.set('q', q);
            
            // Industry
            const industry = document.getElementById('industrySearch').value.trim();
            if (industry) params.set('industry', industry);
            
            // Geography
            const state = document.getElementById('stateFilter').value;
            if (state) params.set('state', state);
            
            const metro = document.getElementById('metroFilter')?.value;
            if (metro) params.set('cbsa', metro);

            const city = document.getElementById('cityFilter')?.value;
            if (city) params.set('city', city);
            
            // Sector filter (for unions)
            const sector = document.getElementById('sectorFilter')?.value;
            if (sector) params.set('sector', sector);
            
            // Affiliation filter (for unions)
            const aff = document.getElementById('affiliationFilter')?.value;
            if (aff) params.set('aff', aff);
            
            // Update URL without reload
            const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
            history.replaceState(null, '', newUrl);
        }
        
        function parseUrlAndSearch() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.size === 0) return false;
            
            // Mode
            const mode = params.get('mode');
            if (mode === 'unions' || mode === 'employers') {
                setSearchMode(mode);
            }
            
            // Search query
            const q = params.get('q');
            if (q) document.getElementById('mainSearch').value = q;
            
            // Industry
            const industry = params.get('industry');
            if (industry) document.getElementById('industrySearch').value = industry;
            
            // State - need to wait for states to load
            const state = params.get('state');
            const cbsa = params.get('cbsa');
            const city = params.get('city');
            const sector = params.get('sector');
            const aff = params.get('aff');

            // Store for later application after data loads
            window.pendingUrlParams = { state, cbsa, city, sector, aff };
            
            return true;
        }
        
        async function applyPendingUrlParams() {
            const p = window.pendingUrlParams;
            if (!p) return;
            
            if (p.state) {
                document.getElementById('stateFilter').value = p.state;
                await onStateChange();  // This loads metros and cities for the state
            }

            if (p.cbsa) document.getElementById('metroFilter').value = p.cbsa;
            if (p.city) document.getElementById('cityFilter').value = p.city;
            if (p.sector && document.getElementById('sectorFilter')) {
                document.getElementById('sectorFilter').value = p.sector;
            }
            if (p.aff && document.getElementById('affiliationFilter')) {
                document.getElementById('affiliationFilter').value = p.aff;
            }
            
            window.pendingUrlParams = null;
            
            // Execute search if we have any filters
            if (document.getElementById('mainSearch').value || 
                document.getElementById('industrySearch').value ||
                p.state) {
                executeSearch();
            }
        }
        
        function getShareableUrl() {
            updateUrl();
            return window.location.href;
        }
        
        // ==========================================
        // UTILITIES
        // ==========================================
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return num.toLocaleString();
        }

        // ==========================================
        // UNIFIED EMPLOYERS MODAL
        // ==========================================
        let unifiedEmployersResults = [];
        let selectedUnifiedItem = null;

        function openUnifiedEmployersModal() {
            console.log('Opening Unified Employers modal...');
            document.getElementById('unifiedEmployersModal').classList.remove('hidden');
            document.getElementById('unifiedEmployersModal').classList.add('flex');
            document.body.classList.add('modal-open');

            // Populate state dropdown
            const stateSelect = document.getElementById('unifiedState');
            if (stateSelect.options.length <= 1) {
                const mainStateSelect = document.getElementById('stateFilter');
                console.log('Main state options:', mainStateSelect.options.length);
                for (let i = 1; i < mainStateSelect.options.length; i++) {
                    const opt = mainStateSelect.options[i];
                    stateSelect.add(new Option(opt.text, opt.value));
                }
            }

            // Auto-load results on open
            loadUnifiedEmployers();
        }

        function closeUnifiedEmployersModal() {
            document.getElementById('unifiedEmployersModal').classList.add('hidden');
            document.getElementById('unifiedEmployersModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function loadUnifiedEmployers() {
            console.log('loadUnifiedEmployers called');
            const name = document.getElementById('unifiedNameSearch').value;
            const state = document.getElementById('unifiedState').value;
            const source = document.getElementById('unifiedSource').value;
            const hasUnion = document.getElementById('unifiedHasUnion').value;
            const hasOsha = document.getElementById('unifiedHasOsha').value;

            document.getElementById('unifiedLoading').classList.remove('hidden');
            document.getElementById('unifiedContent').classList.add('hidden');

            const params = new URLSearchParams({ limit: 100 });
            if (name) params.append('name', name);
            if (state) params.append('state', state);
            if (source) params.append('source_type', source);
            if (hasUnion) params.append('has_union', hasUnion);
            if (hasOsha) params.append('has_osha', hasOsha);

            const url = `${API_BASE}/employers/unified/search?${params}`;
            console.log('Fetching:', url);

            try {
                const response = await fetch(url);
                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('API error: ' + response.status);

                const data = await response.json();
                console.log('Data received:', data.total, 'employers');
                unifiedEmployersResults = data.employers || [];
                renderUnifiedResults(data);
            } catch (e) {
                console.error('Unified employers failed:', e);
                document.getElementById('unifiedResultsInfo').textContent = 'Error: ' + e.message;
            } finally {
                document.getElementById('unifiedLoading').classList.add('hidden');
                document.getElementById('unifiedContent').classList.remove('hidden');
            }
        }

        function renderUnifiedResults(data) {
            const infoEl = document.getElementById('unifiedResultsInfo');
            const resultsEl = document.getElementById('unifiedResults');
            const employers = data.employers || [];

            infoEl.textContent = `${formatNumber(data.total || employers.length)} employers found`;

            if (employers.length === 0) {
                resultsEl.innerHTML = '<div class="p-8 text-center text-warmgray-400">No results found. Try adjusting filters.</div>';
                return;
            }

            resultsEl.innerHTML = employers.map(item => `
                <div class="p-4 cursor-pointer hover:bg-warmgray-50 transition-colors ${selectedUnifiedItem?.unified_id === item.unified_id ? 'bg-purple-50 border-l-4 border-purple-500' : ''}"
                     onclick="selectUnifiedItem('${item.unified_id}')">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-semibold text-warmgray-900 truncate flex-1">${escapeHtml(item.employer_name || 'Unknown')}</div>
                        ${getSourceBadge(item.source_type)}
                    </div>
                    <div class="text-sm text-warmgray-500">
                        ${escapeHtml(item.city || '')}, ${item.state || ''}
                    </div>
                    <div class="flex gap-2 mt-2 flex-wrap">
                        ${item.osha_match_count ? `<span class="text-xs px-2 py-0.5 rounded bg-red-50 text-red-600">${item.osha_match_count} OSHA matches</span>` : ''}
                        ${item.union_name ? `<span class="text-xs px-2 py-0.5 rounded bg-green-50 text-green-600">${escapeHtml(item.union_name)}</span>` : ''}
                        ${item.employee_count ? `<span class="text-xs text-warmgray-400">${formatNumber(item.employee_count)} employees</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getSourceBadge(source) {
            const colors = {
                'F7': 'bg-blue-100 text-blue-700',
                'NLRB': 'bg-purple-100 text-purple-700',
                'VR': 'bg-green-100 text-green-700',
                'PUBLIC': 'bg-orange-100 text-orange-700'
            };
            return `<span class="px-2 py-0.5 rounded text-xs font-semibold ${colors[source] || 'bg-gray-100 text-gray-700'}">${source}</span>`;
        }

        async function selectUnifiedItem(unifiedId) {
            selectedUnifiedItem = unifiedEmployersResults.find(r => r.unified_id == unifiedId);
            renderUnifiedResults({ employers: unifiedEmployersResults, total: unifiedEmployersResults.length });

            document.getElementById('unifiedDetailEmpty').classList.add('hidden');
            document.getElementById('unifiedDetail').classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/employers/unified/${unifiedId}`);
                if (!response.ok) throw new Error('API error');

                const detail = await response.json();
                renderUnifiedDetail(detail);
            } catch (e) {
                console.error('Unified detail failed:', e);
                renderUnifiedDetail(selectedUnifiedItem);
            }
        }

        function renderUnifiedDetail(detail) {
            const el = document.getElementById('unifiedDetail');
            const oshaMatches = detail.osha_matches || [];

            el.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-warmgray-900">${escapeHtml(detail.employer_name || 'Unknown')}</h3>
                    <p class="text-warmgray-500">${escapeHtml(detail.city || '')}, ${detail.state || ''}</p>
                    <div class="flex gap-2 mt-2 flex-wrap">
                        ${getSourceBadge(detail.source_type)}
                        ${detail.employee_count ? `<span class="badge badge-industry">${formatNumber(detail.employee_count)} employees</span>` : ''}
                        ${detail.union_name ? `<span class="badge badge-public">${escapeHtml(detail.union_name)}</span>` : ''}
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-warmgray-50 rounded-lg p-4">
                        <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-2">Source Information</h4>
                        <div class="text-sm space-y-1">
                            <div><span class="text-warmgray-500">Source:</span> ${detail.source_type || 'N/A'}</div>
                            <div><span class="text-warmgray-500">Source ID:</span> ${detail.source_id || 'N/A'}</div>
                            ${detail.naics_code ? `<div><span class="text-warmgray-500">NAICS:</span> ${detail.naics_code}</div>` : ''}
                        </div>
                    </div>

                    ${oshaMatches.length > 0 ? `
                        <div class="bg-red-50 rounded-lg p-4">
                            <h4 class="text-xs font-semibold text-red-700 uppercase mb-2">OSHA Matches (${oshaMatches.length})</h4>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${oshaMatches.slice(0, 10).map(m => `
                                    <div class="text-sm border-l-2 border-red-300 pl-2">
                                        <div class="font-medium text-warmgray-700">${escapeHtml(m.estab_name || m.establishment_name || 'Establishment')}</div>
                                        <div class="text-xs text-warmgray-500">
                                            ${escapeHtml(m.site_city || m.city || '')}, ${m.site_state || m.state || ''} ·
                                            ${m.total_violations || 0} violations ·
                                            $${formatNumber(m.total_penalties || 0)} penalties
                                        </div>
                                    </div>
                                `).join('')}
                                ${oshaMatches.length > 10 ? `<div class="text-xs text-warmgray-400">... and ${oshaMatches.length - 10} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${detail.union_fnum ? `
                        <div class="bg-green-50 rounded-lg p-4">
                            <h4 class="text-xs font-semibold text-green-700 uppercase mb-2">Union Connection</h4>
                            <div class="text-sm">
                                <div>${escapeHtml(detail.union_name || 'Unknown Union')}</div>
                                <div class="text-xs text-warmgray-500">F-Num: ${detail.union_fnum}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ==========================================
        // NLRB ELECTIONS MODAL
        // ==========================================
        let electionsResults = [];
        let selectedElectionItem = null;

        function openElectionsModal() {
            console.log('Opening Elections modal...');
            document.getElementById('electionsModal').classList.remove('hidden');
            document.getElementById('electionsModal').classList.add('flex');
            document.body.classList.add('modal-open');

            const stateSelect = document.getElementById('electionsState');
            if (stateSelect.options.length <= 1) {
                const mainStateSelect = document.getElementById('stateFilter');
                for (let i = 1; i < mainStateSelect.options.length; i++) {
                    const opt = mainStateSelect.options[i];
                    stateSelect.add(new Option(opt.text, opt.value));
                }
            }

            // Auto-load results on open
            loadElections();
        }

        function closeElectionsModal() {
            document.getElementById('electionsModal').classList.add('hidden');
            document.getElementById('electionsModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function loadElections() {
            console.log('loadElections called');
            const employer = document.getElementById('electionsEmployerSearch').value;
            const state = document.getElementById('electionsState').value;
            const year = document.getElementById('electionsYear').value;
            const result = document.getElementById('electionsResult').value;
            const minVoters = document.getElementById('electionsMinVoters').value;

            document.getElementById('electionsLoading').classList.remove('hidden');
            document.getElementById('electionsContent').classList.add('hidden');

            const params = new URLSearchParams({ limit: 100 });
            if (employer) params.append('employer_name', employer);
            if (state) params.append('state', state);
            if (year) {
                params.append('year_from', year);
                params.append('year_to', year);
            }
            if (result === 'won') params.append('union_won', 'true');
            if (result === 'lost') params.append('union_won', 'false');
            if (minVoters) params.append('min_voters', minVoters);

            const url = `${API_BASE}/nlrb/elections/search?${params}`;
            console.log('Fetching:', url);

            try {
                const response = await fetch(url);
                console.log('Response status:', response.status);
                if (!response.ok) throw new Error('API error: ' + response.status);

                const data = await response.json();
                console.log('Data received:', data.total, 'elections');
                electionsResults = data.elections || [];

                // Filter out law firms if checkbox is checked
                const excludeLawFirms = document.getElementById('electionsExcludeLawFirms').checked;
                if (excludeLawFirms) {
                    electionsResults = electionsResults.filter(e => !e.is_law_firm);
                }
                renderElectionsResults({ ...data, elections: electionsResults, total: electionsResults.length });
            } catch (e) {
                console.error('Elections failed:', e);
                document.getElementById('electionsResultsInfo').textContent = 'Error: ' + e.message;
            } finally {
                document.getElementById('electionsLoading').classList.add('hidden');
                document.getElementById('electionsContent').classList.remove('hidden');
            }
        }

        function renderElectionsResults(data) {
            const infoEl = document.getElementById('electionsResultsInfo');
            const resultsEl = document.getElementById('electionsResults');

            const results = data.results || data.elections || [];
            infoEl.textContent = `${formatNumber(data.total || results.length)} elections found`;

            if (results.length === 0) {
                resultsEl.innerHTML = '<div class="p-8 text-center text-warmgray-400">No elections found. Try adjusting filters.</div>';
                return;
            }

            resultsEl.innerHTML = results.map(item => {
                const isWon = item.union_won || item.result === 'won' || item.votes_for > item.votes_against;
                const isLost = item.result === 'lost' || (!item.union_won && item.votes_against > item.votes_for);
                const resultBadge = isWon
                    ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-700">WON</span>'
                    : isLost
                        ? '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700">LOST</span>'
                        : '<span class="px-2 py-0.5 rounded text-xs font-semibold bg-yellow-100 text-yellow-700">PENDING</span>';
                const lawFirmBadge = item.is_law_firm
                    ? '<span class="badge badge-law-firm ml-1" title="Employer name pattern suggests a law firm - verify employer">Verify</span>'
                    : '';

                return `
                    <div class="p-4 cursor-pointer hover:bg-warmgray-50 transition-colors ${selectedElectionItem?.case_number === item.case_number ? 'bg-blue-50 border-l-4 border-blue-500' : ''}"
                         onclick="selectElectionItem('${item.case_number}')">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-xs text-warmgray-400">${item.case_number || 'N/A'}</div>
                            <div class="flex items-center gap-1">${resultBadge}${lawFirmBadge}</div>
                        </div>
                        <div class="font-semibold text-warmgray-900 truncate">${escapeHtml(item.employer_name || item.employer || 'Unknown')}</div>
                        <div class="text-sm text-warmgray-500 truncate">
                            ${escapeHtml(item.union_name || item.labor_org || 'Unknown Union')}
                        </div>
                        <div class="text-sm text-warmgray-500">
                            ${escapeHtml(item.employer_city || item.city || '')}, ${item.employer_state || item.state || ''}
                        </div>
                        <div class="flex justify-between text-xs text-warmgray-400 mt-2">
                            <span>${item.eligible_voters || 0} eligible</span>
                            <span class="text-green-600">${item.vote_margin > 0 ? '+' + item.vote_margin : ''}</span>
                            <span>${item.election_date || ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectElectionItem(caseNumber) {
            selectedElectionItem = electionsResults.find(r => r.case_number === caseNumber);
            renderElectionsResults({ elections: electionsResults, total: electionsResults.length });

            document.getElementById('electionsDetailEmpty').classList.add('hidden');
            document.getElementById('electionsDetail').classList.remove('hidden');
            renderElectionDetail(selectedElectionItem);
        }

        function renderElectionDetail(item) {
            if (!item) return;
            const el = document.getElementById('electionsDetail');
            const isWon = item.union_won === true;
            const isLost = item.union_won === false;
            const isPending = item.union_won === null;

            el.innerHTML = `
                <div class="mb-6">
                    <div class="text-xs text-warmgray-400 mb-1">${item.case_number || 'N/A'}</div>
                    <h3 class="text-xl font-bold text-warmgray-900">${escapeHtml(item.employer_name || 'Unknown')}</h3>
                    <p class="text-warmgray-500">${escapeHtml(item.employer_city || '')}, ${item.employer_state || ''}</p>
                    <div class="mt-2">
                        <span class="badge ${isWon ? 'bg-green-100 text-green-700' : isPending ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                            ${isWon ? 'UNION WON' : isPending ? 'PENDING' : 'UNION LOST'}
                        </span>
                    </div>
                </div>

                <div class="bg-warmgray-50 rounded-lg p-4 mb-4">
                    <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-3">Election Results</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-warmgray-500">Eligible Voters:</span>
                            <span class="font-semibold">${item.eligible_voters || 0}</span>
                        </div>
                        <div>
                            <span class="text-warmgray-500">Vote Margin:</span>
                            <span class="font-semibold ${item.vote_margin > 0 ? 'text-green-600' : item.vote_margin < 0 ? 'text-red-600' : ''}">${item.vote_margin > 0 ? '+' : ''}${item.vote_margin || 0}</span>
                        </div>
                        <div>
                            <span class="text-warmgray-500">Election Type:</span>
                            <span class="font-semibold">${item.election_type || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-warmgray-500">Election Date:</span>
                            <span class="font-semibold">${item.election_date || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="text-xs font-semibold text-blue-700 uppercase mb-2">Union</h4>
                        <div class="text-sm font-medium">${escapeHtml(item.union_name || item.labor_org || 'Unknown')}</div>
                        ${item.aff_abbr ? `<div class="text-xs text-warmgray-500">${item.aff_abbr}</div>` : ''}
                    </div>

                    <div class="bg-warmgray-50 rounded-lg p-4">
                        <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-2">Case Details</h4>
                        <div class="text-sm space-y-1">
                            <div><span class="text-warmgray-500">Filed:</span> ${item.date_filed || 'N/A'}</div>
                            <div><span class="text-warmgray-500">Closed:</span> ${item.date_closed || item.tally_date || 'N/A'}</div>
                            <div><span class="text-warmgray-500">Unit Type:</span> ${item.unit_type || 'N/A'}</div>
                            ${item.naics_code ? `<div><span class="text-warmgray-500">NAICS:</span> ${item.naics_code}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // PUBLIC SECTOR MODAL
        // ==========================================
        let publicSectorResults = [];
        let selectedPublicSectorItem = null;
        let publicSectorView = 'locals';

        function openPublicSectorModal() {
            console.log('Opening Public Sector modal...');
            document.getElementById('publicSectorModal').classList.remove('hidden');
            document.getElementById('publicSectorModal').classList.add('flex');
            document.body.classList.add('modal-open');
            initPublicSectorDropdowns();

            // Auto-load results on open
            if (publicSectorView === 'locals') {
                loadPublicSectorLocals();
            } else {
                loadPublicSectorEmployers();
            }
        }

        function closePublicSectorModal() {
            document.getElementById('publicSectorModal').classList.add('hidden');
            document.getElementById('publicSectorModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function initPublicSectorDropdowns() {
            // Populate state dropdowns
            const mainStateSelect = document.getElementById('stateFilter');
            ['psLocalsState', 'psEmployersState'].forEach(id => {
                const select = document.getElementById(id);
                if (select.options.length <= 1) {
                    for (let i = 1; i < mainStateSelect.options.length; i++) {
                        const opt = mainStateSelect.options[i];
                        select.add(new Option(opt.text, opt.value));
                    }
                }
            });

            // Load parent unions
            const parentSelect = document.getElementById('psLocalsParent');
            if (parentSelect.options.length <= 1) {
                try {
                    const response = await fetch(`${API_BASE}/public-sector/parent-unions`);
                    const data = await response.json();
                    (data.parent_unions || []).forEach(u => {
                        parentSelect.add(new Option(u.full_name || u.abbrev, u.abbrev));
                    });
                } catch (e) { console.error('Failed to load parent unions:', e); }
            }

            // Load employer types
            const typeSelect = document.getElementById('psEmployersType');
            if (typeSelect.options.length <= 1) {
                try {
                    const response = await fetch(`${API_BASE}/public-sector/employer-types`);
                    const data = await response.json();
                    (data.employer_types || []).forEach(t => {
                        const label = (t.employer_type || '').replace(/_/g, ' ');
                        typeSelect.add(new Option(`${label} (${t.count})`, t.employer_type));
                    });
                } catch (e) { console.error('Failed to load employer types:', e); }
            }
        }

        function setPublicSectorView(view) {
            publicSectorView = view;

            document.getElementById('psLocalsTab').className = view === 'locals'
                ? 'px-4 py-1.5 text-sm font-semibold rounded-full transition-all bg-warmgray-900 text-white'
                : 'px-4 py-1.5 text-sm font-semibold rounded-full transition-all text-warmgray-600 hover:text-warmgray-800';
            document.getElementById('psEmployersTab').className = view === 'employers'
                ? 'px-4 py-1.5 text-sm font-semibold rounded-full transition-all bg-warmgray-900 text-white'
                : 'px-4 py-1.5 text-sm font-semibold rounded-full transition-all text-warmgray-600 hover:text-warmgray-800';

            document.getElementById('psLocalsFilters').classList.toggle('hidden', view !== 'locals');
            document.getElementById('psEmployersFilters').classList.toggle('hidden', view !== 'employers');

            // Clear results
            publicSectorResults = [];
            document.getElementById('publicSectorResultsInfo').textContent = 'Click "Search" to browse public sector data';
            document.getElementById('publicSectorResults').innerHTML = '';
            document.getElementById('publicSectorDetailEmpty').classList.remove('hidden');
            document.getElementById('publicSectorDetail').classList.add('hidden');
        }

        async function loadPublicSectorLocals() {
            console.log('loadPublicSectorLocals called');
            const name = document.getElementById('psLocalsNameSearch').value;
            const state = document.getElementById('psLocalsState').value;
            const parent = document.getElementById('psLocalsParent').value;

            document.getElementById('publicSectorLoading').classList.remove('hidden');
            document.getElementById('publicSectorContent').classList.add('hidden');

            const params = new URLSearchParams({ limit: 100 });
            if (name) params.append('name', name);
            if (state) params.append('state', state);
            if (parent) params.append('parent_union', parent);

            const url = `${API_BASE}/public-sector/locals?${params}`;
            console.log('Fetching:', url);

            try {
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Data received:', data.total, 'locals');
                publicSectorResults = data.locals || [];
                renderPublicSectorResults();
            } catch (e) {
                console.error('Public sector locals failed:', e);
                document.getElementById('publicSectorResultsInfo').textContent = 'Error: ' + e.message;
            } finally {
                document.getElementById('publicSectorLoading').classList.add('hidden');
                document.getElementById('publicSectorContent').classList.remove('hidden');
            }
        }

        async function loadPublicSectorEmployers() {
            const name = document.getElementById('psEmployersNameSearch').value;
            const state = document.getElementById('psEmployersState').value;
            const type = document.getElementById('psEmployersType').value;

            document.getElementById('publicSectorLoading').classList.remove('hidden');
            document.getElementById('publicSectorContent').classList.add('hidden');

            const params = new URLSearchParams({ limit: 100 });
            if (name) params.append('name', name);
            if (state) params.append('state', state);
            if (type) params.append('employer_type', type);

            try {
                const response = await fetch(`${API_BASE}/public-sector/employers?${params}`);
                const data = await response.json();
                publicSectorResults = data.employers || data.results || [];
                renderPublicSectorResults();
            } catch (e) {
                console.error('Public sector employers failed:', e);
                document.getElementById('publicSectorResultsInfo').textContent = 'Error loading results.';
            } finally {
                document.getElementById('publicSectorLoading').classList.add('hidden');
                document.getElementById('publicSectorContent').classList.remove('hidden');
            }
        }

        function renderPublicSectorResults() {
            const infoEl = document.getElementById('publicSectorResultsInfo');
            const resultsEl = document.getElementById('publicSectorResults');

            infoEl.textContent = `${formatNumber(publicSectorResults.length)} ${publicSectorView} found`;

            if (publicSectorResults.length === 0) {
                resultsEl.innerHTML = '<div class="p-8 text-center text-warmgray-400">No results found.</div>';
                return;
            }

            if (publicSectorView === 'locals') {
                resultsEl.innerHTML = publicSectorResults.map(item => `
                    <div class="p-4 cursor-pointer hover:bg-warmgray-50 transition-colors ${selectedPublicSectorItem?.id === item.id ? 'bg-orange-50 border-l-4 border-orange-500' : ''}"
                         onclick="selectPublicSectorItem('${item.id}', 'local')">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-semibold text-warmgray-900 truncate flex-1">${escapeHtml(item.local_name || 'Unknown')}</div>
                            ${item.parent_abbrev ? `<span class="px-2 py-0.5 rounded text-xs font-semibold bg-orange-100 text-orange-700">${item.parent_abbrev}</span>` : ''}
                        </div>
                        ${item.local_designation ? `<div class="text-xs text-warmgray-400">${item.local_designation}</div>` : ''}
                        <div class="text-sm text-warmgray-500">${escapeHtml(item.city || '')}, ${item.state || ''}</div>
                        ${item.members ? `<div class="text-xs text-warmgray-400 mt-1">${formatNumber(item.members)} members</div>` : ''}
                    </div>
                `).join('');
            } else {
                resultsEl.innerHTML = publicSectorResults.map(item => `
                    <div class="p-4 cursor-pointer hover:bg-warmgray-50 transition-colors ${selectedPublicSectorItem?.id === item.id ? 'bg-orange-50 border-l-4 border-orange-500' : ''}"
                         onclick="selectPublicSectorItem('${item.id}', 'employer')">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-semibold text-warmgray-900 truncate flex-1">${escapeHtml(item.employer_name || 'Unknown')}</div>
                            ${getEmployerTypeBadge(item.employer_type)}
                        </div>
                        <div class="text-sm text-warmgray-500">${item.state || ''} ${item.county ? `· ${item.county} County` : ''}</div>
                        ${item.total_employees ? `<div class="text-xs text-warmgray-400 mt-1">${formatNumber(item.total_employees)} employees</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function getEmployerTypeBadge(type) {
            const colors = {
                'FEDERAL': 'bg-blue-100 text-blue-700',
                'STATE': 'bg-purple-100 text-purple-700',
                'STATE_AGENCY': 'bg-purple-100 text-purple-700',
                'COUNTY': 'bg-orange-100 text-orange-700',
                'CITY': 'bg-green-100 text-green-700',
                'SCHOOL_DISTRICT': 'bg-yellow-100 text-yellow-700',
                'UNIVERSITY': 'bg-indigo-100 text-indigo-700',
                'TRANSIT_AUTHORITY': 'bg-cyan-100 text-cyan-700',
                'UTILITY': 'bg-teal-100 text-teal-700',
                'SPECIAL_DISTRICT': 'bg-pink-100 text-pink-700'
            };
            const label = (type || '').replace(/_/g, ' ');
            return `<span class="px-2 py-0.5 rounded text-xs font-semibold ${colors[type] || 'bg-gray-100 text-gray-700'}">${label}</span>`;
        }

        function selectPublicSectorItem(id, type) {
            selectedPublicSectorItem = publicSectorResults.find(r => r.id == id);
            renderPublicSectorResults();

            document.getElementById('publicSectorDetailEmpty').classList.add('hidden');
            document.getElementById('publicSectorDetail').classList.remove('hidden');
            renderPublicSectorDetail(selectedPublicSectorItem, type);
        }

        function renderPublicSectorDetail(item, type) {
            if (!item) return;
            const el = document.getElementById('publicSectorDetail');

            if (type === 'local') {
                el.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-warmgray-900">${escapeHtml(item.local_name || 'Unknown')}</h3>
                        ${item.local_designation ? `<p class="text-warmgray-500">${item.local_designation}</p>` : ''}
                        <p class="text-warmgray-500">${escapeHtml(item.city || '')}, ${item.state || ''}</p>
                        <div class="flex gap-2 mt-2 flex-wrap">
                            ${item.parent_abbrev ? `<span class="badge bg-orange-100 text-orange-700">${item.parent_abbrev}</span>` : ''}
                            ${item.parent_name ? `<span class="text-xs text-warmgray-500">${item.parent_name}</span>` : ''}
                        </div>
                        ${item.members ? `<div class="text-sm text-warmgray-600 mt-2">${formatNumber(item.members)} members</div>` : ''}
                    </div>

                    <div class="space-y-4">
                        ${item.contact_info ? `
                            <div class="bg-warmgray-50 rounded-lg p-4">
                                <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-2">Contact</h4>
                                <div class="text-sm">${escapeHtml(item.contact_info)}</div>
                            </div>
                        ` : ''}
                        ${item.website ? `
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="text-xs font-semibold text-blue-700 uppercase mb-2">Website</h4>
                                <a href="${item.website}" target="_blank" class="text-sm text-blue-600 hover:underline">${item.website}</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                el.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-warmgray-900">${escapeHtml(item.employer_name || 'Unknown')}</h3>
                        <p class="text-warmgray-500">${item.city ? item.city + ', ' : ''}${item.state || ''}</p>
                        <div class="flex gap-2 mt-2 flex-wrap">
                            ${getEmployerTypeBadge(item.employer_type)}
                            ${item.total_employees ? `<span class="badge badge-industry">${formatNumber(item.total_employees)} employees</span>` : ''}
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-warmgray-50 rounded-lg p-4">
                            <h4 class="text-xs font-semibold text-warmgray-500 uppercase mb-2">Details</h4>
                            <div class="text-sm space-y-1">
                                <div><span class="text-warmgray-500">Type:</span> ${(item.employer_type || 'N/A').replace(/_/g, ' ')}</div>
                                <div><span class="text-warmgray-500">State:</span> ${item.state || 'N/A'}</div>
                                ${item.county ? `<div><span class="text-warmgray-500">County:</span> ${item.county}</div>` : ''}
                                ${item.naics_code ? `<div><span class="text-warmgray-500">NAICS:</span> ${item.naics_code}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ==========================================
        // TRENDS MODAL
        // ==========================================
        let trendsData = {};
        let trendsCharts = {};
        let currentTrendsTab = 'overview';

        function openTrendsModal() {
            document.getElementById('trendsModal').classList.remove('hidden');
            document.getElementById('trendsModal').classList.add('flex');
            document.body.classList.add('modal-open');
            loadTrendsData();
        }

        function closeTrendsModal() {
            document.getElementById('trendsModal').classList.add('hidden');
            document.getElementById('trendsModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function loadTrendsData() {
            document.getElementById('trendsLoading').classList.remove('hidden');
            document.getElementById('trendsContent').classList.add('hidden');

            try {
                const [national, elections, affiliations, states, sectors] = await Promise.all([
                    fetch(`${API_BASE}/trends/national?start_year=2010&end_year=2024`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/elections`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/affiliations/summary`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/states/summary`).then(r => r.json()),
                    fetch(`${API_BASE}/trends/sectors`).then(r => r.json())
                ]);

                trendsData = { national, elections, affiliations, states, sectors };
                renderTrendsOverview();

                // Populate dropdowns
                populateTrendsDropdowns();

            } catch (e) {
                console.error('Trends data failed:', e);
            } finally {
                document.getElementById('trendsLoading').classList.add('hidden');
                document.getElementById('trendsContent').classList.remove('hidden');
            }
        }

        function populateTrendsDropdowns() {
            // State dropdown
            const stateSelect = document.getElementById('trendsStateSelect');
            if (stateSelect.options.length <= 1) {
                const mainStateSelect = document.getElementById('stateFilter');
                for (let i = 1; i < mainStateSelect.options.length; i++) {
                    const opt = mainStateSelect.options[i];
                    stateSelect.add(new Option(opt.text, opt.value));
                }
            }

            // Affiliation dropdown
            const affSelect = document.getElementById('trendsAffiliationSelect');
            if (affSelect.options.length <= 1 && trendsData.affiliations?.affiliations) {
                trendsData.affiliations.affiliations.slice(0, 30).forEach(a => {
                    affSelect.add(new Option(a.aff_abbr || a.abbreviation, a.aff_abbr || a.abbreviation));
                });
            }
        }

        function setTrendsTab(tab) {
            currentTrendsTab = tab;

            ['overview', 'membership', 'elections', 'byState', 'byAffiliation'].forEach(t => {
                const btn = document.getElementById(`trendsTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const panel = document.getElementById(`trendsPanel${t.charAt(0).toUpperCase() + t.slice(1)}`);

                if (t === tab) {
                    btn.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-emerald-100 text-emerald-700';
                    panel.classList.remove('hidden');
                } else {
                    btn.className = 'px-4 py-2 text-sm font-semibold rounded-lg text-warmgray-600 hover:bg-warmgray-100';
                    panel.classList.add('hidden');
                }
            });

            // Render the selected tab
            switch (tab) {
                case 'overview': renderTrendsOverview(); break;
                case 'membership': renderTrendsMembership(); break;
                case 'elections': renderTrendsElections(); break;
            }
        }

        function renderTrendsOverview() {
            const data = trendsData.national?.trends || [];
            const elections = trendsData.elections?.election_trends || [];

            // Find latest year data
            const latest = data[data.length - 1];
            const first = data[0];

            if (latest) {
                // Use deduplicated data if available, otherwise fall back to raw
                const latestMembers = latest.total_members_dedup || latest.total_members_raw || 0;
                const firstMembers = first?.total_members_dedup || first?.total_members_raw || 0;
                document.getElementById('trendsMembers2024').textContent = formatNumber(latestMembers);
                if (first && latestMembers && firstMembers) {
                    const change = ((latestMembers - firstMembers) / firstMembers * 100).toFixed(1);
                    document.getElementById('trendsMembersChange').textContent = `${change > 0 ? '+' : ''}${change}% since ${first.year}`;
                }
            }

            // Calculate averages using deduplicated data
            if (data.length > 1) {
                let totalChange = 0;
                for (let i = 1; i < data.length; i++) {
                    const curr = data[i].total_members_dedup || data[i].total_members_raw;
                    const prev = data[i-1].total_members_dedup || data[i-1].total_members_raw;
                    if (curr && prev) {
                        totalChange += (curr - prev) / prev * 100;
                    }
                }
                document.getElementById('trendsAvgChange').textContent = `${(totalChange / (data.length - 1)).toFixed(2)}%`;
            }

            // Elections stats
            if (elections.length > 0) {
                const latestElection = elections[elections.length - 1];
                const totalWins = elections.reduce((sum, y) => sum + (y.union_wins || 0), 0);
                const totalElections = elections.reduce((sum, y) => sum + (y.total_elections || 0), 0);
                document.getElementById('trendsWinRate').textContent = totalElections > 0
                    ? `${Math.round(totalWins / totalElections * 100)}%` : '—';
                document.getElementById('trendsElections2024').textContent = formatNumber(latestElection?.total_elections || 0);
            }

            // Overview charts
            renderOverviewCharts();
        }

        function renderOverviewCharts() {
            const data = trendsData.national?.trends || [];
            const elections = trendsData.elections?.election_trends || [];

            // Membership chart
            const ctx1 = document.getElementById('trendsOverviewChart');
            if (ctx1 && data.length > 0) {
                if (trendsCharts.overview) trendsCharts.overview.destroy();
                trendsCharts.overview = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.year),
                        datasets: [{
                            label: 'Total Members (Deduplicated)',
                            data: data.map(d => d.total_members_dedup || d.total_members_raw),
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: false, ticks: { callback: v => (v/1000000).toFixed(1) + 'M' } }
                        }
                    }
                });
            }

            // Elections chart
            const ctx2 = document.getElementById('trendsElectionsChart');
            if (ctx2 && elections.length > 0) {
                if (trendsCharts.electionsOverview) trendsCharts.electionsOverview.destroy();
                trendsCharts.electionsOverview = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: elections.map(d => d.year),
                        datasets: [
                            {
                                label: 'Won',
                                data: elections.map(d => d.union_wins || 0),
                                backgroundColor: '#22c55e'
                            },
                            {
                                label: 'Lost',
                                data: elections.map(d => d.union_losses || 0),
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { x: { stacked: true }, y: { stacked: true } }
                    }
                });
            }
        }

        function renderTrendsMembership() {
            const data = trendsData.national?.trends || [];
            const affiliations = trendsData.affiliations?.affiliations || [];
            const sectors = trendsData.sectors?.sectors || [];

            // Main membership chart
            const ctx = document.getElementById('trendsMembershipChart');
            if (ctx && data.length > 0) {
                if (trendsCharts.membership) trendsCharts.membership.destroy();
                trendsCharts.membership = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.year),
                        datasets: [{
                            label: 'Total Members (Deduplicated)',
                            data: data.map(d => d.total_members_dedup || d.total_members_raw),
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: false, ticks: { callback: v => (v/1000000).toFixed(1) + 'M' } }
                        }
                    }
                });
            }

            // Top growing/declining (sort by pct_change)
            const sortedAffs = [...affiliations].sort((a, b) => (b.pct_change || 0) - (a.pct_change || 0));
            const growing = sortedAffs.filter(a => (a.pct_change || 0) > 0).slice(0, 5);
            const declining = sortedAffs.filter(a => (a.pct_change || 0) < 0).slice(-5).reverse();

            document.getElementById('trendsTopGrowing').innerHTML = growing.map(a => `
                <div class="flex justify-between">
                    <span>${a.aff_abbr}</span>
                    <span class="text-green-600">+${(a.pct_change || 0).toFixed(1)}%</span>
                </div>
            `).join('') || '<div class="text-warmgray-400">No data</div>';

            document.getElementById('trendsDeclining').innerHTML = declining.map(a => `
                <div class="flex justify-between">
                    <span>${a.aff_abbr}</span>
                    <span class="text-red-600">${(a.pct_change || 0).toFixed(1)}%</span>
                </div>
            `).join('') || '<div class="text-warmgray-400">No data</div>';

            // Sectors
            document.getElementById('trendsSectors').innerHTML = sectors.slice(0, 5).map(s => `
                <div class="flex justify-between">
                    <span>${s.sector || s.name}</span>
                    <span class="font-semibold">${formatNumber(s.members || s.total_members || 0)}</span>
                </div>
            `).join('') || '<div class="text-warmgray-400">No data</div>';
        }

        function renderTrendsElections() {
            const elections = trendsData.elections?.election_trends || [];
            const byState = trendsData.elections?.by_state || [];

            // Elections by year chart
            const ctx = document.getElementById('trendsElectionsByYearChart');
            if (ctx && elections.length > 0) {
                if (trendsCharts.electionsByYear) trendsCharts.electionsByYear.destroy();
                trendsCharts.electionsByYear = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: elections.map(d => d.year),
                        datasets: [
                            {
                                label: 'Won',
                                data: elections.map(d => d.union_wins || 0),
                                backgroundColor: '#22c55e'
                            },
                            {
                                label: 'Lost',
                                data: elections.map(d => d.union_losses || 0),
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            // Win rate by year
            document.getElementById('trendsWinRateByYear').innerHTML = elections.slice().reverse().map(y => {
                const rate = y.win_rate || 0;
                return `
                    <div class="flex justify-between">
                        <span>${y.year}</span>
                        <span class="font-semibold ${rate >= 50 ? 'text-green-600' : 'text-red-600'}">${rate.toFixed(1)}%</span>
                    </div>
                `;
            }).join('') || '<div class="text-warmgray-400">No data</div>';

            // By state - Note: API may not return by_state, show message if empty
            document.getElementById('trendsElectionsByState').innerHTML = byState.length > 0
                ? byState.slice(0, 10).map(s => `
                    <div class="flex justify-between">
                        <span>${s.state}</span>
                        <span class="font-semibold">${formatNumber(s.total_elections || s.total || 0)}</span>
                    </div>
                `).join('')
                : '<div class="text-warmgray-400">State breakdown not available</div>';
        }

        async function loadStateTrends() {
            const state = document.getElementById('trendsStateSelect').value;
            if (!state) return;

            try {
                const response = await fetch(`${API_BASE}/trends/by-state/${state}`);
                const data = await response.json();

                const trends = data.trends || [];
                const ctx = document.getElementById('trendsStateChart');

                if (ctx && trends.length > 0) {
                    if (trendsCharts.state) trendsCharts.state.destroy();
                    trendsCharts.state = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trends.map(d => d.year),
                            datasets: [{
                                label: `${state} Members`,
                                data: trends.map(d => d.total_members || d.members),
                                borderColor: '#059669',
                                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: false } }
                        }
                    });
                }

                // State info cards
                const latest = trends[trends.length - 1];
                const first = trends[0];
                document.getElementById('trendsStateInfo').innerHTML = `
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Latest Members</div>
                        <div class="text-2xl font-bold text-warmgray-900 mt-1">${formatNumber(latest?.total_members || latest?.members || 0)}</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Change</div>
                        <div class="text-2xl font-bold ${first && latest && latest.total_members > first.total_members ? 'text-green-600' : 'text-red-600'} mt-1">
                            ${first && latest ? ((latest.total_members - first.total_members) / first.total_members * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Years of Data</div>
                        <div class="text-2xl font-bold text-warmgray-900 mt-1">${trends.length}</div>
                    </div>
                `;
            } catch (e) {
                console.error('State trends failed:', e);
            }
        }

        async function loadAffiliationTrends() {
            const aff = document.getElementById('trendsAffiliationSelect').value;
            if (!aff) return;

            try {
                const response = await fetch(`${API_BASE}/trends/by-affiliation/${encodeURIComponent(aff)}`);
                const data = await response.json();

                const trends = data.trends || [];
                const ctx = document.getElementById('trendsAffiliationChart');

                if (ctx && trends.length > 0) {
                    if (trendsCharts.affiliation) trendsCharts.affiliation.destroy();
                    trendsCharts.affiliation = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trends.map(d => d.year),
                            datasets: [{
                                label: `${aff} Members`,
                                data: trends.map(d => d.total_members || d.members),
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: false } }
                        }
                    });
                }

                // Affiliation info cards
                const latest = trends[trends.length - 1];
                const first = trends[0];
                document.getElementById('trendsAffiliationInfo').innerHTML = `
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Latest Members</div>
                        <div class="text-2xl font-bold text-warmgray-900 mt-1">${formatNumber(latest?.total_members || latest?.members || 0)}</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Change</div>
                        <div class="text-2xl font-bold ${first && latest && latest.total_members > first.total_members ? 'text-green-600' : 'text-red-600'} mt-1">
                            ${first && latest ? ((latest.total_members - first.total_members) / first.total_members * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-warmgray-200">
                        <div class="text-xs font-semibold text-warmgray-500 uppercase">Years of Data</div>
                        <div class="text-2xl font-bold text-warmgray-900 mt-1">${trends.length}</div>
                    </div>
                `;
            } catch (e) {
                console.error('Affiliation trends failed:', e);
            }
        }
    </script>
</body>
</html>
