<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labor Platform v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        #map { height: 350px; }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <h1 class="text-xl font-bold">Labor Relations Platform v4.1</h1>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">National Union</label>
                    <select id="affiliationSelect" onchange="loadLocals()" class="w-full border rounded p-2 text-sm">
                        <option value="">All Unions</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Local Union</label>
                    <select id="localSelect" class="w-full border rounded p-2 text-sm">
                        <option value="">Select national first</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Industry</label>
                    <select id="naicsSelect" onchange="loadIndustryInfo()" class="w-full border rounded p-2 text-sm">
                        <option value="">All Industries</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">State</label>
                    <select id="stateSelect" class="w-full border rounded p-2 text-sm">
                        <option value="">All States</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Employer Name</label>
                    <input type="text" id="nameSearch" class="w-full border rounded p-2 text-sm" placeholder="Search...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">City</label>
                    <input type="text" id="citySearch" class="w-full border rounded p-2 text-sm" placeholder="City...">
                </div>
                <div class="flex items-end">
                    <label class="flex items-center"><input type="checkbox" id="activeOnly" checked class="mr-2"> Active only</label>
                </div>
                <div class="flex items-end">
                    <button onclick="search()" class="w-full bg-blue-600 text-white px-4 py-2 rounded font-medium">Search</button>
                </div>
            </div>
        </div>

        <!-- Industry Panel -->
        <div id="industryPanel" class="bg-white rounded-lg shadow mb-6 p-4 hidden">
            <h3 class="font-semibold" id="industryTitle">Industry Info</h3>
            <div class="grid grid-cols-3 gap-4 mt-3">
                <div class="bg-amber-50 p-3 rounded"><div class="text-sm">Union Density</div><div class="text-xl font-bold" id="density">--</div></div>
                <div class="bg-blue-50 p-3 rounded"><div class="text-sm">Employment 2024</div><div class="text-xl font-bold" id="emp2024">--</div></div>
                <div class="bg-green-50 p-3 rounded"><div class="text-sm">Growth 2024-34</div><div class="text-xl font-bold" id="growth">--</div></div>
            </div>
        </div>

        <!-- Results -->
        <div class="grid grid-cols-3 gap-6">
            <div class="col-span-2 bg-white rounded-lg shadow">
                <div class="p-4 border-b font-semibold">Results <span id="count" class="font-normal text-gray-500">(0)</span></div>
                <div id="results" class="divide-y max-h-[500px] overflow-y-auto">
                    <div class="p-8 text-center text-gray-500">Click Search to find employers</div>
                </div>
                <div class="p-3 border-t flex justify-between">
                    <button onclick="prevPage()" id="prevBtn" disabled class="px-3 py-1 bg-gray-100 rounded disabled:opacity-50">← Prev</button>
                    <span id="pageInfo">Page 1</span>
                    <button onclick="nextPage()" id="nextBtn" disabled class="px-3 py-1 bg-gray-100 rounded disabled:opacity-50">Next →</button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b font-semibold">Map</div>
                <div id="map"></div>
            </div>
        </div>
    </main>

    <script>
        const API = 'http://localhost:8001/api';
        let offset = 0, total = 0, map, markers = [];

        document.addEventListener('DOMContentLoaded', () => {
            map = L.map('map').setView([39.8, -98.5], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            loadDropdowns();
        });

        async function loadDropdowns() {
            // Affiliations
            const aff = await fetch(`${API}/lookups/affiliations`).then(r => r.json());
            const affSel = document.getElementById('affiliationSelect');
            (aff.affiliations || []).forEach(a => {
                affSel.innerHTML += `<option value="${a.aff_abbr}">${a.aff_abbr} (${a.local_count} locals)</option>`;
            });

            // NAICS
            const naics = await fetch(`${API}/lookups/naics-sectors`).then(r => r.json());
            const naicsSel = document.getElementById('naicsSelect');
            (naics.naics_sectors || []).forEach(n => {
                const d = n.union_density_pct ? ` [${n.union_density_pct.toFixed(1)}%]` : '';
                naicsSel.innerHTML += `<option value="${n.naics_2digit}">${n.naics_2digit} - ${n.sector_name}${d}</option>`;
            });

            // States
            const st = await fetch(`${API}/lookups/states`).then(r => r.json());
            const stSel = document.getElementById('stateSelect');
            (st.states || []).forEach(s => {
                stSel.innerHTML += `<option value="${s.state}">${s.state} (${s.employer_count})</option>`;
            });
        }

        async function loadLocals() {
            const aff = document.getElementById('affiliationSelect').value;
            const sel = document.getElementById('localSelect');
            if (!aff) { sel.innerHTML = '<option value="">Select national first</option>'; return; }
            
            sel.innerHTML = '<option value="">Loading...</option>';
            const data = await fetch(`${API}/unions/locals/${aff}?has_employers=true`).then(r => r.json());
            sel.innerHTML = `<option value="">All ${aff} locals (${data.count || 0})</option>`;
            (data.locals || []).forEach(l => {
                sel.innerHTML += `<option value="${l.f_num}">${l.union_name} - ${l.city || ''}, ${l.state || ''}</option>`;
            });
        }

        async function loadIndustryInfo() {
            const naics = document.getElementById('naicsSelect').value;
            const panel = document.getElementById('industryPanel');
            if (!naics) { panel.classList.add('hidden'); return; }
            
            panel.classList.remove('hidden');
            document.getElementById('industryTitle').textContent = `NAICS ${naics}`;

            const dens = await fetch(`${API}/density/naics/${naics}`).then(r => r.json());
            document.getElementById('density').textContent = dens.current?.union_density_pct?.toFixed(1) + '%' || 'N/A';

            const proj = await fetch(`${API}/projections/naics/${naics}`).then(r => r.json());
            if (proj.summary) {
                document.getElementById('emp2024').textContent = proj.summary.total_2024 ? (proj.summary.total_2024/1000).toFixed(0) + 'K' : '--';
                document.getElementById('growth').textContent = proj.summary.avg_employment_change_pct?.toFixed(1) + '%' || '--';
            }
        }

        async function search() {
            const p = new URLSearchParams();
            const aff = document.getElementById('affiliationSelect').value;
            const loc = document.getElementById('localSelect').value;
            const naics = document.getElementById('naicsSelect').value;
            const st = document.getElementById('stateSelect').value;
            const name = document.getElementById('nameSearch').value;
            const city = document.getElementById('citySearch').value;
            
            if (aff) p.append('affiliation', aff);
            if (loc) p.append('f_num', loc);
            if (naics) p.append('naics_2digit', naics);
            if (st) p.append('state', st);
            if (name) p.append('name', name);
            if (city) p.append('city', city);
            p.append('active_only', document.getElementById('activeOnly').checked);
            p.append('limit', 50);
            p.append('offset', offset);

            document.getElementById('results').innerHTML = '<div class="p-8 text-center">Searching...</div>';
            
            const data = await fetch(`${API}/employers/search?${p}`).then(r => r.json());
            total = data.total || 0;
            document.getElementById('count').textContent = `(${total.toLocaleString()})`;
            
            const emps = data.employers || [];
            if (emps.length === 0) {
                document.getElementById('results').innerHTML = '<div class="p-8 text-center text-gray-500">No results</div>';
            } else {
                document.getElementById('results').innerHTML = emps.map(e => `
                    <div class="p-3 hover:bg-gray-50">
                        <div class="flex justify-between">
                            <div>
                                <div class="font-medium">${e.employer_name || 'Unknown'}</div>
                                <div class="text-sm text-gray-600">${[e.city, e.state].filter(Boolean).join(', ')}</div>
                                <div class="text-xs text-gray-500">${e.latest_union_name || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600">${e.latest_unit_size?.toLocaleString() || '?'}</div>
                                <div class="text-xs text-gray-500">${e.naics_sector_name || ''}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Map
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            emps.filter(e => e.latitude && e.longitude).forEach(e => {
                const m = L.marker([e.latitude, e.longitude]).addTo(map);
                m.bindPopup(`<b>${e.employer_name}</b><br>${e.city}, ${e.state}`);
                markers.push(m);
            });

            updatePagination();
        }

        function updatePagination() {
            const page = Math.floor(offset / 50) + 1;
            const pages = Math.ceil(total / 50) || 1;
            document.getElementById('pageInfo').textContent = `Page ${page} of ${pages}`;
            document.getElementById('prevBtn').disabled = offset === 0;
            document.getElementById('nextBtn').disabled = offset + 50 >= total;
        }

        function prevPage() { if (offset > 0) { offset -= 50; search(); } }
        function nextPage() { if (offset + 50 < total) { offset += 50; search(); } }
    </script>
</body>
</html>
