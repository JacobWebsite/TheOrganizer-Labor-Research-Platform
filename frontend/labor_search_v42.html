<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labor Relations Research Platform v4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; }
        #map { height: 400px; }
        .sector-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .sector-PRIVATE { background: #dbeafe; color: #1e40af; }
        .sector-FEDERAL { background: #fef3c7; color: #92400e; }
        .naics-badge { background: #f3f4f6; color: #374151; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .match-score { background: #d1fae5; color: #065f46; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .match-score-high { background: #bbf7d0; }
        .match-score-med { background: #fef08a; color: #854d0e; }
        .match-score-low { background: #fecaca; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">Labor Relations Research Platform</h1>
            <p class="text-sm text-gray-500 mt-1">Advanced fuzzy search with name normalization ‚Ä¢ v4.2</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Search Type Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b">
                <nav class="flex" id="searchTypeTabs">
                    <button onclick="setSearchType('employers')" data-type="employers" class="px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent tab-active">üè¢ Employer Search</button>
                    <button onclick="setSearchType('unions')" data-type="unions" class="px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent">üèõÔ∏è Union Search</button>
                </nav>
            </div>
        </div>

        <!-- EMPLOYER SEARCH PANEL -->
        <div id="employerPanel">
            <div class="bg-white rounded-lg shadow mb-6 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Type</label>
                        <select id="employerSearchType" onchange="updateSearchOptions()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="basic">Basic (exact match)</option>
                            <option value="fuzzy">Fuzzy (typo-tolerant)</option>
                            <option value="normalized" selected>Normalized (strips Inc/LLC)</option>
                            <option value="rapidfuzz">RapidFuzz (advanced)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Employer Name</label>
                        <input type="text" id="employerSearch" placeholder="e.g., Kroger, Kaiser..." class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                    </div>
                    <div id="thresholdContainer">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Match Threshold: <span id="thresholdValue">0.35</span></label>
                        <input type="range" id="threshold" min="0.1" max="1" step="0.05" value="0.35" onchange="updateThresholdDisplay()" class="w-full">
                    </div>
                    <div id="algorithmContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Algorithm</label>
                        <select id="algorithm" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="token_set">Token Set (extra words)</option>
                            <option value="jaro_winkler">Jaro-Winkler (typos)</option>
                            <option value="combined">Combined (balanced)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">National Union</label>
                        <select id="affiliationSelect" onchange="loadLocals()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="">All Unions</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <select id="stateSelect" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Industry (NAICS)</label>
                        <select id="naicsSelect" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="">All Industries</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="searchEmployers()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium text-sm">
                            üîç Search Employers
                        </button>
                    </div>
                </div>
                <div id="searchInfo" class="mt-3 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                    <strong>Normalized search:</strong> Strips "Inc", "LLC", "Corp", "Company" and expands abbreviations. "Kroger" matches "The Kroger Company, Inc."
                </div>
            </div>

            <!-- Employer Results -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="font-semibold text-gray-900">Employers <span id="resultCount" class="text-gray-500 font-normal">(0)</span></h2>
                            <span id="searchMethod" class="text-xs text-gray-400"></span>
                        </div>
                        <div id="resultsContainer" class="divide-y max-h-[600px] overflow-y-auto">
                            <div class="p-8 text-center text-gray-500">Enter an employer name and click Search</div>
                        </div>
                        <div class="p-4 border-t flex justify-between items-center">
                            <button onclick="prevPage()" id="prevBtn" disabled class="px-3 py-1 bg-gray-100 rounded text-sm disabled:opacity-50">‚Üê Prev</button>
                            <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
                            <button onclick="nextPage()" id="nextBtn" disabled class="px-3 py-1 bg-gray-100 rounded text-sm disabled:opacity-50">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-4 border-b"><h2 class="font-semibold text-gray-900">Map</h2></div>
                        <div id="map"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow mt-6 p-4">
                        <h3 class="font-semibold text-gray-900 mb-3">Database Stats</h3>
                        <div id="statsContainer" class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Total Unions:</span><span id="statUnions">--</span></div>
                            <div class="flex justify-between"><span>Total Employers:</span><span id="statEmployers">--</span></div>
                            <div class="flex justify-between"><span>Covered Workers:</span><span id="statWorkers">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- UNION SEARCH PANEL -->
        <div id="unionPanel" class="hidden">
            <div class="bg-white rounded-lg shadow mb-6 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Type</label>
                        <select id="unionSearchType" onchange="updateUnionSearchOptions()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                            <option value="smart" selected>Smart (expands acronyms)</option>
                            <option value="fuzzy">Fuzzy (name matching)</option>
                            <option value="canonical">Canonical Lookup</option>
                        </select>
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Union Name or Acronym</label>
                        <input type="text" id="unionSearch" placeholder="e.g., SEIU, Teamsters, UAW..." class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                    </div>
                    <div class="flex items-end">
                        <button onclick="searchUnions()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-medium text-sm">
                            üîç Search Unions
                        </button>
                    </div>
                </div>
                <div id="unionSearchInfo" class="mt-3 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                    <strong>Smart search:</strong> Type "SEIU" or "Teamsters" to find all locals. Expands acronyms automatically.
                </div>
            </div>

            <!-- Union Results -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="font-semibold text-gray-900">Unions <span id="unionResultCount" class="text-gray-500 font-normal">(0)</span></h2>
                    <span id="unionExpanded" class="text-xs text-green-600"></span>
                </div>
                <div id="unionResultsContainer" class="divide-y max-h-[600px] overflow-y-auto">
                    <div class="p-8 text-center text-gray-500">Enter a union name or acronym and click Search</div>
                </div>
            </div>

            <!-- Canonical Lookup Result -->
            <div id="canonicalResult" class="bg-white rounded-lg shadow mt-6 p-6 hidden">
                <h3 class="font-semibold text-gray-900 mb-3">Canonical Name Lookup</h3>
                <div id="canonicalContent"></div>
            </div>
        </div>
    </main>

    <script>
        const API = 'http://localhost:8001/api';
        let currentSearchType = 'employers';
        let currentOffset = 0;
        let currentTotal = 0;
        const PAGE_SIZE = 50;
        let map, markerCluster;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadLookups();
            loadStats();
            updateSearchOptions();
        });

        function initMap() {
            map = L.map('map').setView([39.8, -98.5], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);
        }

        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('#searchTypeTabs button').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.type === type) btn.classList.add('tab-active');
            });
            document.getElementById('employerPanel').classList.toggle('hidden', type !== 'employers');
            document.getElementById('unionPanel').classList.toggle('hidden', type !== 'unions');
        }

        function updateSearchOptions() {
            const searchType = document.getElementById('employerSearchType').value;
            const thresholdContainer = document.getElementById('thresholdContainer');
            const algorithmContainer = document.getElementById('algorithmContainer');
            const searchInfo = document.getElementById('searchInfo');
            const thresholdInput = document.getElementById('threshold');

            // Show/hide options based on search type
            if (searchType === 'basic') {
                thresholdContainer.classList.add('hidden');
                algorithmContainer.classList.add('hidden');
                searchInfo.innerHTML = '<strong>Basic search:</strong> Exact substring match. Fast but requires precise spelling.';
            } else if (searchType === 'fuzzy') {
                thresholdContainer.classList.remove('hidden');
                algorithmContainer.classList.add('hidden');
                thresholdInput.min = 0.1;
                thresholdInput.max = 1;
                thresholdInput.step = 0.05;
                thresholdInput.value = 0.3;
                updateThresholdDisplay();
                searchInfo.innerHTML = '<strong>Fuzzy search:</strong> Tolerates typos. "Kaizer" finds "Kaiser Permanente".';
            } else if (searchType === 'normalized') {
                thresholdContainer.classList.remove('hidden');
                algorithmContainer.classList.add('hidden');
                thresholdInput.min = 0.1;
                thresholdInput.max = 1;
                thresholdInput.step = 0.05;
                thresholdInput.value = 0.35;
                updateThresholdDisplay();
                searchInfo.innerHTML = '<strong>Normalized search:</strong> Strips "Inc", "LLC", "Corp", "Company". "Kroger" matches "The Kroger Company, Inc."';
            } else if (searchType === 'rapidfuzz') {
                thresholdContainer.classList.remove('hidden');
                algorithmContainer.classList.remove('hidden');
                thresholdInput.min = 50;
                thresholdInput.max = 100;
                thresholdInput.step = 5;
                thresholdInput.value = 70;
                updateThresholdDisplay();
                searchInfo.innerHTML = '<strong>RapidFuzz:</strong> Advanced matching. Token Set handles extra words, Jaro-Winkler handles typos.';
            }
        }

        function updateThresholdDisplay() {
            const val = document.getElementById('threshold').value;
            document.getElementById('thresholdValue').textContent = val;
        }

        function updateUnionSearchOptions() {
            const searchType = document.getElementById('unionSearchType').value;
            const searchInfo = document.getElementById('unionSearchInfo');

            if (searchType === 'smart') {
                searchInfo.innerHTML = '<strong>Smart search:</strong> Type "SEIU" or "Teamsters" to find all locals. Expands acronyms automatically.';
            } else if (searchType === 'fuzzy') {
                searchInfo.innerHTML = '<strong>Fuzzy search:</strong> Matches similar union names with typo tolerance.';
            } else if (searchType === 'canonical') {
                searchInfo.innerHTML = '<strong>Canonical lookup:</strong> Finds the official name and all known variants for an acronym.';
            }
        }

        async function loadLookups() {
            try {
                // Affiliations
                const affResp = await fetch(`${API}/lookups/affiliations`);
                const affData = await affResp.json();
                const affSelect = document.getElementById('affiliationSelect');
                if (affData.affiliations) {
                    affData.affiliations.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.aff_abbr;
                        opt.textContent = `${a.aff_abbr} (${a.local_count} locals)`;
                        affSelect.appendChild(opt);
                    });
                }

                // NAICS
                const naicsResp = await fetch(`${API}/lookups/naics-sectors`);
                const naicsData = await naicsResp.json();
                const naicsSelect = document.getElementById('naicsSelect');
                if (naicsData.naics_sectors) {
                    naicsData.naics_sectors.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n.naics_2digit;
                        opt.textContent = `${n.naics_2digit} - ${n.sector_name}`;
                        naicsSelect.appendChild(opt);
                    });
                }

                // States
                const stateResp = await fetch(`${API}/lookups/states`);
                const stateData = await stateResp.json();
                const stateSelect = document.getElementById('stateSelect');
                if (stateData.states) {
                    stateData.states.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.state;
                        opt.textContent = `${s.state} (${s.employer_count})`;
                        stateSelect.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading lookups:', err);
            }
        }

        async function loadStats() {
            try {
                const resp = await fetch(`${API}/stats/overview`);
                const stats = await resp.json();
                document.getElementById('statUnions').textContent = stats.total_unions?.toLocaleString() || '--';
                document.getElementById('statEmployers').textContent = stats.total_employers?.toLocaleString() || '--';
                document.getElementById('statWorkers').textContent = stats.covered_workers ? (stats.covered_workers/1000000).toFixed(1) + 'M' : '--';
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        async function loadLocals() {
            const aff = document.getElementById('affiliationSelect').value;
            // Just filter, no cascading select needed
        }

        async function searchEmployers() {
            const searchType = document.getElementById('employerSearchType').value;
            const name = document.getElementById('employerSearch').value;
            const state = document.getElementById('stateSelect').value;
            const aff = document.getElementById('affiliationSelect').value;
            const naics = document.getElementById('naicsSelect').value;
            const threshold = document.getElementById('threshold').value;
            const algorithm = document.getElementById('algorithm').value;

            if (!name && searchType !== 'basic') {
                alert('Please enter an employer name to search');
                return;
            }

            const container = document.getElementById('resultsContainer');
            container.innerHTML = '<div class="p-8 text-center text-gray-500">Searching...</div>';

            let url, method;
            const params = new URLSearchParams();

            if (searchType === 'basic') {
                url = `${API}/employers/search`;
                if (name) params.append('name', name);
                if (state) params.append('state', state);
                if (aff) params.append('affiliation', aff);
                if (naics) params.append('naics_2digit', naics);
                params.append('limit', PAGE_SIZE);
                params.append('offset', currentOffset);
                method = 'Basic';
            } else if (searchType === 'fuzzy') {
                url = `${API}/employers/fuzzy-search`;
                params.append('name', name);
                params.append('threshold', threshold);
                if (state) params.append('state', state);
                params.append('limit', PAGE_SIZE);
                params.append('offset', currentOffset);
                method = `Fuzzy (threshold: ${threshold})`;
            } else if (searchType === 'normalized') {
                url = `${API}/employers/normalized-search`;
                params.append('name', name);
                params.append('threshold', threshold);
                if (state) params.append('state', state);
                params.append('limit', PAGE_SIZE);
                params.append('offset', currentOffset);
                method = `Normalized (threshold: ${threshold})`;
            } else if (searchType === 'rapidfuzz') {
                url = `${API}/employers/rapidfuzz-search`;
                params.append('name', name);
                params.append('threshold', threshold);
                params.append('algorithm', algorithm);
                if (state) params.append('state', state);
                params.append('limit', PAGE_SIZE);
                method = `RapidFuzz ${algorithm} (threshold: ${threshold})`;
            }

            try {
                const resp = await fetch(`${url}?${params}`);
                const data = await resp.json();

                // Handle different response formats
                let employers, total;
                if (searchType === 'rapidfuzz') {
                    employers = data.matches || [];
                    total = employers.length;
                } else {
                    employers = data.employers || [];
                    total = data.total || employers.length;
                }

                currentTotal = total;
                document.getElementById('resultCount').textContent = `(${total.toLocaleString()})`;
                document.getElementById('searchMethod').textContent = method;

                if (data.normalized_search) {
                    document.getElementById('searchMethod').textContent += ` | Normalized: "${data.normalized_search}"`;
                }

                renderResults(employers, searchType);
                updateMap(employers);
                updatePagination();
            } catch (err) {
                console.error('Search error:', err);
                container.innerHTML = '<div class="p-8 text-center text-red-500">Search failed. Is API running on port 8001?</div>';
            }
        }

        function renderResults(employers, searchType) {
            const container = document.getElementById('resultsContainer');

            if (!employers || employers.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">No results found</div>';
                return;
            }

            container.innerHTML = employers.map(emp => {
                const score = emp.match_score;
                let scoreClass = 'match-score-high';
                if (searchType === 'rapidfuzz') {
                    if (score < 80) scoreClass = 'match-score-med';
                    if (score < 70) scoreClass = 'match-score-low';
                } else {
                    if (score < 0.5) scoreClass = 'match-score-med';
                    if (score < 0.3) scoreClass = 'match-score-low';
                }

                const scoreDisplay = score ? (searchType === 'rapidfuzz' ? score.toFixed(1) : (score * 100).toFixed(1) + '%') : '';

                return `
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-900">${emp.employer_name || 'Unknown'}</div>
                                <div class="text-sm text-gray-600">${[emp.city, emp.state].filter(Boolean).join(', ') || 'Location unknown'}</div>
                                <div class="text-xs text-gray-500 mt-1">${emp.latest_union_name || emp.union || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600">${(emp.latest_unit_size || emp.workers)?.toLocaleString() || '?'} workers</div>
                                ${scoreDisplay ? `<span class="match-score ${scoreClass}">${scoreDisplay}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function searchUnions() {
            const searchType = document.getElementById('unionSearchType').value;
            const name = document.getElementById('unionSearch').value;

            if (!name) {
                alert('Please enter a union name or acronym');
                return;
            }

            const container = document.getElementById('unionResultsContainer');
            container.innerHTML = '<div class="p-8 text-center text-gray-500">Searching...</div>';

            document.getElementById('canonicalResult').classList.add('hidden');

            let url;
            const params = new URLSearchParams();

            if (searchType === 'smart') {
                url = `${API}/unions/smart-search`;
                params.append('name', name);
                params.append('limit', 100);
            } else if (searchType === 'fuzzy') {
                url = `${API}/search/unions`;
                params.append('name', name);
                params.append('threshold', '0.3');
                params.append('limit', 100);
            } else if (searchType === 'canonical') {
                url = `${API}/unions/canonical-lookup`;
                params.append('name', name);
            }

            try {
                const resp = await fetch(`${url}?${params}`);
                const data = await resp.json();

                if (searchType === 'canonical') {
                    // Show canonical lookup result
                    container.innerHTML = '<div class="p-8 text-center text-gray-500">See canonical lookup below</div>';
                    document.getElementById('canonicalResult').classList.remove('hidden');

                    if (data.canonical_name) {
                        document.getElementById('canonicalContent').innerHTML = `
                            <div class="mb-4">
                                <div class="text-sm text-gray-600">Input: <strong>${data.input}</strong></div>
                                <div class="text-lg font-semibold text-green-700 mt-2">‚Üí ${data.canonical_name}</div>
                                <div class="text-xs text-gray-500">Matched: ${data.matched_variant} (${data.variant_type})</div>
                            </div>
                            <div class="mt-4">
                                <div class="text-sm font-medium text-gray-700 mb-2">All Known Variants:</div>
                                <div class="flex flex-wrap gap-2">
                                    ${data.all_variants.map(v => `<span class="px-2 py-1 bg-gray-100 rounded text-xs">${v.variant_name} <span class="text-gray-400">(${v.variant_type})</span></span>`).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('canonicalContent').innerHTML = `
                            <div class="text-gray-500">No canonical name found for "${data.input}"</div>
                        `;
                    }
                    document.getElementById('unionResultCount').textContent = '(0)';
                    document.getElementById('unionExpanded').textContent = '';
                } else {
                    // Show union list
                    const unions = data.unions || [];
                    document.getElementById('unionResultCount').textContent = `(${unions.length})`;

                    if (data.expanded_to) {
                        document.getElementById('unionExpanded').textContent = `Expanded: ${data.search_term} ‚Üí ${data.expanded_to}`;
                    } else {
                        document.getElementById('unionExpanded').textContent = '';
                    }

                    if (unions.length === 0) {
                        container.innerHTML = '<div class="p-8 text-center text-gray-500">No unions found</div>';
                        return;
                    }

                    container.innerHTML = unions.map(u => `
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-gray-900">${u.union_name}</div>
                                    <div class="text-sm text-gray-600">${[u.city, u.state].filter(Boolean).join(', ')}</div>
                                    <div class="text-xs text-gray-500 mt-1">F-Num: ${u.f_num} | ${u.aff_abbr || 'Independent'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-green-600">${u.members?.toLocaleString() || '?'} members</div>
                                    <div class="text-xs text-gray-500">${u.f7_employer_count || 0} employers</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Union search error:', err);
                container.innerHTML = '<div class="p-8 text-center text-red-500">Search failed</div>';
            }
        }

        function updateMap(employers) {
            markerCluster.clearLayers();
            const withCoords = (employers || []).filter(e => e.latitude && e.longitude);

            withCoords.forEach(emp => {
                const marker = L.marker([emp.latitude, emp.longitude]);
                marker.bindPopup(`<b>${emp.employer_name}</b><br>${emp.city}, ${emp.state}<br>${(emp.latest_unit_size || emp.workers)?.toLocaleString() || '?'} workers`);
                markerCluster.addLayer(marker);
            });

            if (withCoords.length > 0) {
                const bounds = L.latLngBounds(withCoords.map(e => [e.latitude, e.longitude]));
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        function updatePagination() {
            const page = Math.floor(currentOffset / PAGE_SIZE) + 1;
            const totalPages = Math.ceil(currentTotal / PAGE_SIZE) || 1;
            document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentOffset === 0;
            document.getElementById('nextBtn').disabled = currentOffset + PAGE_SIZE >= currentTotal;
        }

        function prevPage() {
            if (currentOffset > 0) {
                currentOffset -= PAGE_SIZE;
                searchEmployers();
            }
        }

        function nextPage() {
            if (currentOffset + PAGE_SIZE < currentTotal) {
                currentOffset += PAGE_SIZE;
                searchEmployers();
            }
        }

        // Allow Enter key to trigger search
        document.getElementById('employerSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchEmployers();
        });
        document.getElementById('unionSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUnions();
        });
    </script>
</body>
</html>
