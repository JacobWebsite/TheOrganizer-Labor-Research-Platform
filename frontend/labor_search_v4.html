<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labor Relations Research Platform v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; }
        #map { height: 400px; }
        .sector-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .sector-PRIVATE { background: #dbeafe; color: #1e40af; }
        .sector-FEDERAL { background: #fef3c7; color: #92400e; }
        .naics-badge { background: #f3f4f6; color: #374151; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .density-badge { background: #fef3c7; color: #92400e; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .match-score { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .match-high { background: #d1fae5; color: #065f46; }
        .match-med { background: #fef08a; color: #854d0e; }
        .match-low { background: #fecaca; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">Labor Relations Research Platform</h1>
            <p class="text-sm text-gray-500 mt-1">Search employers by union, industry, and location • v4.1</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Sector Tabs -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b">
                <nav class="flex" id="sectorTabs">
                    <button onclick="setSector('ALL')" data-sector="ALL" class="px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent tab-active">All Sectors</button>
                    <button onclick="setSector('PRIVATE')" data-sector="PRIVATE" class="px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent">Private</button>
                    <button onclick="setSector('FEDERAL')" data-sector="FEDERAL" class="px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent">Federal</button>
                </nav>
            </div>
            <div class="p-3 bg-gray-50 text-sm text-gray-600" id="sectorInfo">Showing all sectors</div>
        </div>

        <!-- Search Filters -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">National Union</label>
                    <select id="affiliationSelect" onchange="loadLocals()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                        <option value="">All Unions</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Local Union</label>
                    <select id="localSelect" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                        <option value="">Select national first</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Industry (NAICS)</label>
                    <select id="naicsSelect" onchange="loadIndustryInfo()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                        <option value="">All Industries</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <select id="stateSelect" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                        <option value="">All States</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Employer Name</label>
                    <input type="text" id="employerSearch" placeholder="Search..." class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Type</label>
                    <select id="searchType" onchange="updateSearchType()" class="w-full rounded-md border-gray-300 shadow-sm text-sm p-2 border">
                        <option value="basic">Basic (exact)</option>
                        <option value="fuzzy">Fuzzy (typos)</option>
                        <option value="normalized" selected>Normalized (strips Inc/LLC)</option>
                        <option value="rapidfuzz">RapidFuzz (advanced)</option>
                    </select>
                </div>
                <div id="thresholdDiv">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Threshold: <span id="thresholdVal">0.35</span></label>
                    <input type="range" id="threshold" min="0.1" max="1" step="0.05" value="0.35" oninput="document.getElementById('thresholdVal').textContent=this.value" class="w-full">
                </div>
                <div class="flex items-end gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="activeOnly" checked class="rounded border-gray-300">
                        <span class="ml-2 text-sm">Active only</span>
                    </label>
                </div>
                <div class="flex items-end">
                    <button onclick="searchEmployers()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium text-sm">
                        Search Employers
                    </button>
                </div>
            </div>
        </div>

        <!-- Industry Info Panel -->
        <div id="industryPanel" class="bg-white rounded-lg shadow mb-6 p-6 hidden">
            <h3 class="font-semibold text-gray-900" id="industryPanelTitle">Industry Info</h3>
            <div class="grid grid-cols-3 gap-4 mt-4">
                <div class="bg-amber-50 rounded-lg p-4">
                    <div class="text-sm text-amber-800">Union Density</div>
                    <div class="text-2xl font-bold text-amber-900" id="densityValue">--</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-blue-800">Employment 2024</div>
                    <div class="text-2xl font-bold text-blue-900" id="employment2024">--</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-green-800">Growth 2024-2034</div>
                    <div class="text-2xl font-bold text-green-900" id="employmentGrowth">--</div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b">
                        <h2 class="font-semibold text-gray-900">Employers <span id="resultCount" class="text-gray-500 font-normal">(0)</span></h2>
                    </div>
                    <div id="resultsContainer" class="divide-y max-h-[600px] overflow-y-auto">
                        <div class="p-8 text-center text-gray-500">Click "Search Employers" to see results</div>
                    </div>
                    <div class="p-4 border-t flex justify-between items-center">
                        <button onclick="prevPage()" id="prevBtn" disabled class="px-3 py-1 bg-gray-100 rounded text-sm disabled:opacity-50">← Prev</button>
                        <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
                        <button onclick="nextPage()" id="nextBtn" disabled class="px-3 py-1 bg-gray-100 rounded text-sm disabled:opacity-50">Next →</button>
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b"><h2 class="font-semibold text-gray-900">Map</h2></div>
                    <div id="map"></div>
                </div>
                <div class="bg-white rounded-lg shadow mt-6 p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">Stats</h3>
                    <div id="statsContainer" class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Unions:</span><span id="statUnions">--</span></div>
                        <div class="flex justify-between"><span>Employers:</span><span id="statEmployers">--</span></div>
                        <div class="flex justify-between"><span>Workers:</span><span id="statWorkers">--</span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API = 'http://localhost:8001/api';
        let currentSector = 'ALL';
        let currentOffset = 0;
        let currentTotal = 0;
        const PAGE_SIZE = 50;
        let map, markerCluster;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadLookups();
            loadStats();
        });

        function initMap() {
            map = L.map('map').setView([39.8, -98.5], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);
        }

        async function loadLookups() {
            try {
                // Affiliations
                const affResp = await fetch(`${API}/lookups/affiliations`);
                const affData = await affResp.json();
                const affSelect = document.getElementById('affiliationSelect');
                if (affData.affiliations) {
                    affData.affiliations.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.aff_abbr;
                        opt.textContent = `${a.aff_abbr} (${a.local_count} locals)`;
                        affSelect.appendChild(opt);
                    });
                }

                // NAICS
                const naicsResp = await fetch(`${API}/lookups/naics-sectors`);
                const naicsData = await naicsResp.json();
                const naicsSelect = document.getElementById('naicsSelect');
                if (naicsData.naics_sectors) {
                    naicsData.naics_sectors.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n.naics_2digit;
                        const density = n.union_density_pct ? ` [${n.union_density_pct.toFixed(1)}%]` : '';
                        opt.textContent = `${n.naics_2digit} - ${n.sector_name}${density}`;
                        naicsSelect.appendChild(opt);
                    });
                }

                // States
                const stateResp = await fetch(`${API}/lookups/states`);
                const stateData = await stateResp.json();
                const stateSelect = document.getElementById('stateSelect');
                if (stateData.states) {
                    stateData.states.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.state;
                        opt.textContent = `${s.state} (${s.employer_count})`;
                        stateSelect.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading lookups:', err);
            }
        }

        async function loadStats() {
            try {
                const resp = await fetch(`${API}/stats/overview`);
                const stats = await resp.json();
                document.getElementById('statUnions').textContent = stats.total_unions?.toLocaleString() || '--';
                document.getElementById('statEmployers').textContent = stats.total_employers?.toLocaleString() || '--';
                document.getElementById('statWorkers').textContent = stats.covered_workers ? (stats.covered_workers/1000000).toFixed(1) + 'M' : '--';
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        // Feature C: Load locals when affiliation changes
        async function loadLocals() {
            const aff = document.getElementById('affiliationSelect').value;
            const localSelect = document.getElementById('localSelect');
            localSelect.innerHTML = '<option value="">Loading...</option>';

            if (!aff) {
                localSelect.innerHTML = '<option value="">Select national first</option>';
                return;
            }

            try {
                const resp = await fetch(`${API}/unions/locals/${aff}?has_employers=true&limit=200`);
                const data = await resp.json();
                localSelect.innerHTML = `<option value="">All ${aff} locals (${data.count || 0})</option>`;
                if (data.locals) {
                    data.locals.forEach(loc => {
                        const opt = document.createElement('option');
                        opt.value = loc.f_num;
                        // Format: "Local 123 - Chicago, IL" or "SEIU 775 - Seattle, WA"
                        const localNum = loc.local_number && loc.local_number !== '0' ? `Local ${loc.local_number}` : loc.union_name;
                        const location = [loc.city, loc.state].filter(Boolean).join(', ');
                        opt.textContent = `${localNum}${location ? ' - ' + location : ''}`;
                        localSelect.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading locals:', err);
                localSelect.innerHTML = '<option value="">Error loading</option>';
            }
        }

        // Feature A & B: Load industry density and projections
        async function loadIndustryInfo() {
            const naics = document.getElementById('naicsSelect').value;
            const panel = document.getElementById('industryPanel');

            if (!naics) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');
            document.getElementById('industryPanelTitle').textContent = `Industry: NAICS ${naics}`;
            
            // Reset values while loading
            document.getElementById('densityValue').textContent = '...';
            document.getElementById('employment2024').textContent = '...';
            document.getElementById('employmentGrowth').textContent = '...';

            try {
                // Density
                const densityResp = await fetch(`${API}/density/naics/${naics}`);
                if (densityResp.ok) {
                    const densityData = await densityResp.json();
                    if (densityData.current && densityData.current.union_density_pct) {
                        document.getElementById('densityValue').textContent = densityData.current.union_density_pct.toFixed(1) + '%';
                    } else {
                        document.getElementById('densityValue').textContent = 'N/A';
                    }
                } else {
                    document.getElementById('densityValue').textContent = 'N/A';
                }

                // Projections
                const projResp = await fetch(`${API}/projections/naics/${naics}`);
                if (projResp.ok) {
                    const projData = await projResp.json();
                    // employment_2024 is in thousands
                    const emp = projData.employment_2024;
                    if (emp) {
                        document.getElementById('employment2024').textContent = emp >= 1000 ? (emp/1000).toFixed(1) + 'M' : emp.toFixed(0) + 'K';
                    } else {
                        document.getElementById('employment2024').textContent = 'N/A';
                    }
                    // percent_change is the 10-year growth rate
                    const growth = projData.percent_change;
                    if (growth !== null && growth !== undefined) {
                        const sign = growth >= 0 ? '+' : '';
                        document.getElementById('employmentGrowth').textContent = sign + growth.toFixed(1) + '%';
                    } else {
                        document.getElementById('employmentGrowth').textContent = 'N/A';
                    }
                } else {
                    document.getElementById('employment2024').textContent = 'N/A';
                    document.getElementById('employmentGrowth').textContent = 'N/A';
                }
            } catch (err) {
                console.error('Error loading industry info:', err);
                document.getElementById('densityValue').textContent = 'Error';
                document.getElementById('employment2024').textContent = 'Error';
                document.getElementById('employmentGrowth').textContent = 'Error';
            }
        }

        function setSector(sector) {
            currentSector = sector;
            document.querySelectorAll('#sectorTabs button').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.sector === sector) btn.classList.add('tab-active');
            });
            document.getElementById('sectorInfo').textContent = sector === 'ALL' ? 'Showing all sectors' : `Showing ${sector} sector`;
        }

        function updateSearchType() {
            const type = document.getElementById('searchType').value;
            const thresholdDiv = document.getElementById('thresholdDiv');
            const thresholdInput = document.getElementById('threshold');
            
            if (type === 'basic') {
                thresholdDiv.style.display = 'none';
            } else if (type === 'rapidfuzz') {
                thresholdDiv.style.display = 'block';
                thresholdInput.min = 50;
                thresholdInput.max = 100;
                thresholdInput.step = 5;
                thresholdInput.value = 70;
                document.getElementById('thresholdVal').textContent = '70';
            } else {
                thresholdDiv.style.display = 'block';
                thresholdInput.min = 0.1;
                thresholdInput.max = 1;
                thresholdInput.step = 0.05;
                thresholdInput.value = type === 'fuzzy' ? 0.3 : 0.35;
                document.getElementById('thresholdVal').textContent = thresholdInput.value;
            }
        }

        async function searchEmployers() {
    const searchType = document.getElementById('searchType').value;
    const aff = document.getElementById('affiliationSelect').value;
    const local = document.getElementById('localSelect').value;
    const naics = document.getElementById('naicsSelect').value;
    const state = document.getElementById('stateSelect').value;
    const name = document.getElementById('employerSearch').value;
    const activeOnly = document.getElementById('activeOnly').checked;
    const threshold = document.getElementById('threshold').value;

    const container = document.getElementById('resultsContainer');
    container.innerHTML = '<div class="p-8 text-center text-gray-500">Searching...</div>';

    let url, params = new URLSearchParams();

    function addFilters() {
        if (aff) params.append('affiliation', aff);
        if (local) params.append('f_num', local);
        if (naics) params.append('naics_2digit', naics);
        if (state) params.append('state', state);
        if (currentSector !== 'ALL') params.append('union_sector', currentSector);
        params.append('active_only', activeOnly);
    }

    if (searchType === 'basic' || !name) {
        url = `${API}/employers/search`;
        if (name) params.append('name', name);
        addFilters();
        params.append('limit', PAGE_SIZE);
        params.append('offset', currentOffset);
    } else if (searchType === 'fuzzy') {
        url = `${API}/employers/fuzzy-search`;
        params.append('name', name);
        params.append('threshold', threshold);
        addFilters();
        params.append('limit', PAGE_SIZE);
        params.append('offset', currentOffset);
    } else if (searchType === 'normalized') {
        url = `${API}/employers/normalized-search`;
        params.append('name', name);
        params.append('threshold', threshold);
        addFilters();
        params.append('limit', PAGE_SIZE);
        params.append('offset', currentOffset);
    } else if (searchType === 'rapidfuzz') {
        url = `${API}/employers/rapidfuzz-search`;
        params.append('name', name);
        params.append('threshold', threshold);
        params.append('algorithm', 'token_set');
        addFilters();
        params.append('limit', PAGE_SIZE);
    }

    try {
        const resp = await fetch(`${url}?${params}`);
        const data = await resp.json();
        
        let employers, total;
        if (searchType === 'rapidfuzz') {
            employers = data.matches || [];
            total = employers.length;
        } else {
            employers = data.employers || [];
            total = data.total || employers.length;
        }
        
        currentTotal = total;
        document.getElementById('resultCount').textContent = `(${total.toLocaleString()})`;
        
        renderResults(employers, searchType);
        updateMap(employers);
        updatePagination();
    } catch (err) {
        console.error('Search error:', err);
        container.innerHTML = '<div class="p-8 text-center text-red-500">Search failed. Is API running on port 8001?</div>';
    }
}
        function renderResults(employers) {
            const container = document.getElementById('resultsContainer');
            
            if (!employers || employers.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">No results found</div>';
                return;
            }

            container.innerHTML = employers.map(emp => `
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900">${emp.employer_name || 'Unknown'}</div>
                            <div class="text-sm text-gray-600">${[emp.city, emp.state].filter(Boolean).join(', ') || 'Location unknown'}</div>
                            <div class="text-xs text-gray-500 mt-1">${emp.latest_union_name || ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${emp.latest_unit_size?.toLocaleString() || '?'} workers</div>
                            ${emp.naics_sector_name ? `<span class="naics-badge">${emp.naics_sector_name}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateMap(employers) {
            markerCluster.clearLayers();
            const withCoords = (employers || []).filter(e => e.latitude && e.longitude);
            
            withCoords.forEach(emp => {
                const marker = L.marker([emp.latitude, emp.longitude]);
                marker.bindPopup(`<b>${emp.employer_name}</b><br>${emp.city}, ${emp.state}<br>${emp.latest_unit_size?.toLocaleString() || '?'} workers`);
                markerCluster.addLayer(marker);
            });

            if (withCoords.length > 0) {
                const bounds = L.latLngBounds(withCoords.map(e => [e.latitude, e.longitude]));
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        function updatePagination() {
            const page = Math.floor(currentOffset / PAGE_SIZE) + 1;
            const totalPages = Math.ceil(currentTotal / PAGE_SIZE) || 1;
            document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentOffset === 0;
            document.getElementById('nextBtn').disabled = currentOffset + PAGE_SIZE >= currentTotal;
        }

        function prevPage() {
            if (currentOffset > 0) {
                currentOffset -= PAGE_SIZE;
                searchEmployers();
            }
        }

        function nextPage() {
            if (currentOffset + PAGE_SIZE < currentTotal) {
                currentOffset += PAGE_SIZE;
                searchEmployers();
            }
        }
    </script>
</body>
</html>
