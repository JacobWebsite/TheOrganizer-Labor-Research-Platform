# PROJECT_STATE.md — Labor Relations Research Platform

> **Document Purpose:** Session handoffs and live status — what just happened, latest numbers, active bugs. For technical details, see `CLAUDE.md`. For the plan, see `UNIFIED_ROADMAP_2026_02_19.md`. For redesign decisions (scoring, React, UX), see `UNIFIED_PLATFORM_REDESIGN_SPEC.md`. For file locations, see `PROJECT_DIRECTORY.md`.

**Purpose:** Shared context document for all AI tools (Claude Code, Codex, Gemini) and human developers. Read this first before any work session.

**Last manually updated:** 2026-02-20c (Claude Code: NY export v2 deduplicated CSV)

---

## Latest Update (2026-02-20c)

- **NY employer CSV export v2 (`export_ny_deduped.py` rewrite).**
  - Collapsed canonical groups: 3,642 employers -> 1,641 rows (SUM workers, dedup union names, collect locations)
  - Flagged 78 multi-employer agreements (SAG-AFTRA, Joint Policy, RAB, etc.) via regex pattern detection
  - Public sector (20 entries: NYSUT 467K, CSEA 250K, DC37 150K) placed at top of CSV
  - Fuzzy dedup for 10K+ ungrouped employers (no additional collapses found)
  - Total rows: 18,482 -> 15,509 (16% reduction)
  - New columns: `employer_type`, `union_names`, `union_count`, `location_count`, `locations`
  - Methodology document: `docs/NY_EXPORT_METHODOLOGY.md`

### Previous: 2026-02-20b

- **PHASE B COMPLETE. All B4 source re-runs done (9h 15m total).**
  - OSHA 4/4: 1,007,217 records, 97,142 active (9.6%)
  - SEC 5/5: 517,403 records, 5,339 active (1.0%)
  - 990 5/5: 586,767 records, 20,215 active (3.4%)
  - WHD: 363,365 records, 19,462 active (5.4%)
  - SAM 5/5: 826,042 records, 28,816 active (3.5%)
  - BMF: 25 records, 9 active
- **Legacy match tables rebuilt from UML:** osha(97,142), sam(28,816), 990(20,005), whd(19,462), nlrb_xref(13,031)
- **All 3 MVs refreshed:**
  - `mv_organizing_scorecard`: 212,441 rows
  - `mv_employer_data_sources`: 146,863 rows
  - `mv_unified_scorecard`: 146,863 rows (avg=3.28, WHD coverage 8.2%, score_whd avg=1.18)
- **Fixed 3 frontend bugs:** cross-nav (`loadUnionDetail`, `selectUnionByFnum`), pagination (PAGE_SIZE=15 not 50).
- **Marked 4 dead API endpoints as DEPRECATED** in `employers.py`.
- **Misclassification audit:** 2,776 employer records are likely labor orgs. Only 3 flagged. Remediation deferred.
- **990 adapter bug fixed:** dual unique constraints, changed to `ON CONFLICT DO NOTHING`.
- **Tests:** 456 pass / 1 fail (pre-existing hospital abbreviation only).
- **UML:** 1,738,115 rows.

### Previous: 2026-02-19g

- Fixed `test_union_detail` 503 failure introduced by Codex 2026-02-19f session.
  - Root cause: `ns.naics_sector_name` used in SQL queries but actual column is `ns.sector_name`.
  - Fixed in `api/routers/unions.py` and `api/routers/profile.py`.

### Previous: 2026-02-19f

- Added canonical profile endpoints (`/api/profile/employers/{employer_id}`, `/api/profile/unions/{f_num}`).
- Frontend scorecard UX unified-only. Deep-dive routing collapsed into unified Search detail flow.
- `GET /api/employers/unified-search` now handles `sector`, `naics`, `aff_abbr` filters; rejects unsupported `metro` with 422.

---

## Section 1: Quick Start

### Database Connection
- **Engine:** PostgreSQL 17
- **Database:** `olms_multiyear`
- **Host:** localhost:5432
- **User:** `postgres`
- **Credentials:** Stored in `.env` at project root (never commit this file)
- **Shared module:** `from db_config import get_connection` — used by all scripts and the API

### Start the API Server
```bash
py -m uvicorn api.main:app --reload --port 8001
```
Or use `start-claude.bat` which runs the same command.

The API serves at `http://localhost:8001`. API docs at `http://localhost:8001/docs`.

### Run Tests
```bash
py -m pytest tests/ -q
```
457 tests. All should pass except `test_expands_hospital_abbreviation` (pre-existing name normalization edge case).

### Key Files
| File | Purpose |
|------|---------|
| `db_config.py` | Shared database connection — imported by 500+ files |
| `.env` | Database credentials and JWT secret |
| `api/main.py` | FastAPI application entry point |
| `CLAUDE.md` | Detailed project instructions for AI tools |
| `UNIFIED_ROADMAP_2026_02_19.md` | Single source of truth for status, problems, and plan |
| `UNIFIED_PLATFORM_REDESIGN_SPEC.md` | Platform redesign spec — 8-factor weighted scoring, React frontend, UX, page designs |
| `PIPELINE_MANIFEST.md` | Every active script — what it does, when to run it |

---

## Section 2: Database Inventory

*Auto-generated by `scripts/maintenance/generate_db_inventory.py` on 2026-02-16. Numbers below manually corrected 2026-02-21 to reflect B4 re-runs, MV refreshes, and orphan view cleanup.*

| Metric | Value |
|--------|-------|
| Database size | 20 GB |
| Tables | 174 |
| Views | 123 |
| Materialized views | 6 |
| Indexes | ~223 (total size: ~1,700 MB) -- 336 unused dropped 2026-02-18 |
| Estimated total rows | ~27,000,000 |

**Materialized Views:**

| View | Rows |
|------|------|
| `mv_whd_employer_agg` | 330,419 |
| `mv_organizing_scorecard` | 212,441 |
| `mv_employer_search` | 170,775 |
| `mv_employer_data_sources` | 146,863 |
| `mv_unified_scorecard` | 146,863 |
| `mv_employer_features` | 54,968 |

**Top 30 Tables by Row Count:**

| Table | Rows |
|-------|------|
| `ar_disbursements_emp_off` | 2,813,076 |
| `osha_violations_detail` | 2,245,012 |
| `nlrb_docket` | 2,046,151 |
| `qcew_annual` | 1,943,426 |
| `nlrb_participants` | 1,905,912 |
| `unified_match_log` | 1,738,115 |
| `epi_union_membership` | 1,420,064 |
| `employers_990_deduped` | 1,046,167 |
| `osha_establishments` | 1,008,397 |
| `osha_violation_summary` | 872,163 |
| `sam_entities` | 826,042 |
| `nlrb_allegations` | 715,805 |
| `national_990_filers` | 586,767 |
| `sec_companies` | 517,403 |
| `gleif_ownership_links` | 498,963 |
| `nlrb_filings` | 498,749 |
| `nlrb_cases` | 477,688 |
| `gleif_us_entities` | 379,192 |
| `whd_cases` | 362,634 |
| `lm_data` | 331,238 |
| `mv_whd_employer_agg` | 330,419 |
| `ar_assets_investments` | 304,816 |
| `employer_comparables` | 269,785 |
| `ar_membership` | 216,508 |
| `ar_disbursements_total` | 216,372 |
| `mv_organizing_scorecard` | 212,441 |
| `nlrb_employer_xref` | 179,275 |
| `union_names_crosswalk` | 171,481 |
| `mv_employer_search` | 170,775 |
| `f7_employers_deduped` | 146,863 |

*174 tables total.*

---

## Section 3: Active Pipeline

See **`PIPELINE_MANIFEST.md`** for the complete script inventory.

**Summary:** 69 active pipeline scripts across 5 stages:
- **Stage 1 — ETL:** 24 scripts loading data from OSHA, WHD, SAM, SEC, NLRB, BLS, GLEIF, IRS, and more
- **Stage 2 — Matching:** 29 scripts (core pipeline + adapters + matchers) linking records across databases
- **Stage 3 — Scoring:** 8 scripts (4 scoring + 4 ML) computing the organizing scorecard and propensity model
- **Stage 4 — Maintenance:** 2 scripts for periodic refresh (scorecard, data freshness)
- **Stage 5 — Web Scraping:** 7 scripts for union website data extraction

**Typical full pipeline run order:**
```
1.  ETL: Load/refresh source data
2.  Matching: py scripts/matching/run_deterministic.py all
3.  Matching: py scripts/matching/splink_pipeline.py (optional fuzzy)
4.  Matching: py scripts/matching/build_employer_groups.py
4.5 Scoring: py scripts/scoring/build_employer_data_sources.py --refresh
4.6 Scoring: py scripts/scoring/build_unified_scorecard.py --refresh
5.  Scoring: py scripts/scoring/compute_nlrb_patterns.py
6.  Scoring: py scripts/scoring/create_scorecard_mv.py --refresh
7.  Scoring: py scripts/scoring/compute_gower_similarity.py --refresh-view
8.  ML: py scripts/ml/train_propensity_model.py --score-only
9.  Maintenance: py scripts/maintenance/create_data_freshness.py --refresh
```

---

## Section 4: Current Status and Known Issues

### CRITICAL (fix before anything else)

1. ~~**Scorecard uses 10-year-old OSHA data.**~~ **FIXED (Phase A2).** Root cause: OSHA changed `union_status` codes from N/Y to A/B after 2015. View filter changed from `= 'N'` to `!= 'Y'`. MV expanded from 22,389 to 212,441 rows (after Phase A2 + B4 re-runs).

2. ~~**Security is turned off by default.**~~ **HARDENED (Phase D1).** Auth is now enforced by default -- API refuses to start without `LABOR_JWT_SECRET` unless `DISABLE_AUTH=true` is explicitly set. Admin endpoints require admin role. Write endpoints require authentication. Local dev still uses `DISABLE_AUTH=true` in `.env`.

3. ~~**Half of union-employer relationships are invisible.**~~ **FIXED.** Zero orphaned employer relationships (confirmed 2026-02-19 by all three independent audits). Fix applied during deduplication: 3,531 records repointed, 52,760 historical employers added.

### HIGH (fix before letting others use it)

4. ~~**Scorecard coverage improved but still OSHA-centric.**~~ **FIXED (Phase E3).** Unified scorecard (`mv_unified_scorecard`) scores ALL 146,863 F7 employers using signal-strength approach: 7 factors (each 0-10), missing factors excluded, score = average of available factors. Coverage percentage shows data completeness.

5. ~~**Two separate scorecards with different logic.**~~ **FIXED (Phase E3).** One unified scorecard pipeline replaces both OSHA-based and Mergent-based scoring. Old scorecard (`mv_organizing_scorecard`) kept for backward compatibility.

6. ~~**Matching pipeline has two bugs.**~~ **FIXED (Phase B1-B2).** Tier ordering corrected (strict-to-broad: EIN > name+city+state > name+state > aggressive > Splink fuzzy > trigram). First-hit-wins replaced with best-match-wins (keeps highest-tier match per source record). Splink re-integrated as tier 5a with name similarity floor (token_sort_ratio >= 0.70, raised from 0.65 on 2026-02-19) after discovering Splink model overweights geography.

7. ~~**Missing unions.**~~ **RESOLVED (2026-02-21).** Was 195/92,627 -> 166/61,743 (crosswalk) -> 165/23,551 (CWA) -> 138/19,155 (manual adds). All 27 active (post-2021) orphans identified as locals of known national affiliates and added to `unions_master`. 138 remaining are HISTORICAL (pre-2021 defunct). 0 active orphans. See `docs/MISSING_UNIONS_ANALYSIS.md`.

8. ~~**Corporate hierarchy endpoints are broken.**~~ **FIXED (Phase A3).** 7 RealDictCursor indexing bugs fixed, route shadowing resolved (search before parameterized).

9. **Platform only runs on one laptop.** No Docker, no CI/CD, no automated maintenance.

### MEDIUM

10. ~~Match quality dashboard inflates numbers (counts rows, not distinct employers).~~ **FIXED (Phase A4).** API and report now show both `total_match_rows` and `unique_employers_matched`.
11. NLRB time-decay is a dead switch (always 1.0).
12. Model B propensity score is basically random (AUC 0.53).
13. Documentation keeps falling behind (19 known inaccuracies in CLAUDE.md).
14. ~~778 Python files with no manifest.~~ **PARTIALLY ADDRESSED** — Pipeline manifest created, dead scripts archived, credential pattern fixed. ~120 active scripts remain, down from 530+.
15. Database is twice as big as needed (~12 GB raw GLEIF). ~~~1.67 GB unused indexes~~ **FIXED:** 336 unused indexes dropped, 3.0 GB recovered.

---

## Section 5: Recent Decisions

From the Feb 16-17, 2026 planning session (full list in `UNIFIED_ROADMAP_2026_02_19.md` Appendix B). For redesign-era decisions (scoring weights, React migration, UX, page designs), see `UNIFIED_PLATFORM_REDESIGN_SPEC.md`.

| # | Topic | Decision |
|---|-------|----------|
| 1 | Stale materialized views | Fine for now, proof of concept first |
| 2 | F-7 orphan problem | Fix first (highest priority), detailed checkpoint procedure defined |
| 3 | OLMS unused data | Tier 1: organizing spend + membership trends. Tier 2: financial health. Future: officer/leadership |
| 4 | Matching bugs | Reorder strict-to-broad, fix first-hit-wins, bring Splink back, re-run, add confidence flags |
| 5 | Scorecard design | Unified pipeline, signal-strength scoring (missing=excluded not zero), all employers covered |
| 6 | Gower distance | Comparables display only, separate from score |
| 7 | Industry density | Drop as standalone score factor (not actionable), keep as informational display |
| 8 | Geographic favorability | Drop as standalone score factor (too broad), keep as informational display |
| 9 | Government contracts | Combine federal + state + municipal into one factor |
| 10 | Union proximity | Merge sibling unions + corporate hierarchy into one factor, weight siblings more heavily |
| 11 | BLS projections | Add industry growth/decline as component of financial indicators factor |
| 12 | Propensity model | Needs more non-union training data before improvement |
| 13 | Membership display | Distinguish "covered workers" vs "dues-paying members" in UI |
| 14 | 195 missing unions | Check crosswalk first, manual lookup top 20, categorize, remap |
| 15 | Corporate hierarchy | Fix broken API, improve crosswalk coverage. Master key deferred to long-term |
| 16 | FMCS data | Removed from roadmap |
| 17 | Web scraper | On-demand deep-dive tool, not always-running crawler |
| 18 | Workforce demographics | Phase 1: expose BLS matrix. Phase 2: ACS PUMS. Phase 3: revenue-to-headcount. Phase 4: O*NET |
| 19 | F-7 time boundaries | Investigate after orphan fix |
| 20 | Frontend redesign | Major redesign after data foundation is solid |
| 21 | Checkpoints | Built into every work session |
| 22 | Contract database | Lower priority, Wave 3 |
| 23 | Project organization | Script manifest, archive dead files, PROJECT_STATE.md for multi-AI workflow |
| 24 | Multi-AI context | Shared PROJECT_STATE.md with auto-generated sections, session handoff notes |
| 25 | Simpler communication | Explain all technical concepts in plain language |

---

## Section 6: Key Design Rationale

### Phase B Progress (2026-02-17) — Matching Pipeline Fixes

**Status:** B1-B3 complete, B4 partially complete (OSHA re-run reverted), B5 complete.

| Task | Status | Description |
|------|--------|-------------|
| B1 | DONE | Tier reordering: strict-to-broad cascade (EIN 100 > name+city+state 90 > name+state 80 > aggressive 60 > Splink 45 > trigram 40) |
| B2 | DONE | Name collision fix: best-match-wins replaces first-hit-wins |
| B3 | DONE | Splink re-integrated as tier 5a with name similarity floor. Trigram fallback as tier 5b |
| B4 | DONE | All source re-runs complete. OSHA(97,142), SEC(5,339), 990(20,215), WHD(19,462), SAM(28,816), BMF(9). Legacy tables rebuilt. All MVs refreshed. 9h15m total. |
| B5 | DONE | Added confidence flags to UI (HIGH hidden, MEDIUM=Probable match, LOW=Verify match) |

**Critical Finding — Splink Model Calibration:**
The pre-trained Splink model (`adaptive_fuzzy_model.json`) overweights geographic features. State (BF~25), city (BF~400), and zip (BF~840) Bayes factors multiply to ~8.5M, overwhelming the 0.0001 prior to give 0.99+ match probability regardless of name similarity. First OSHA re-run produced 835K active matches (81% match rate vs expected ~4%) before being killed and reverted. Fix: added `rapidfuzz.fuzz.token_sort_ratio >= 0.65` post-filter. Dry-run on 5K records showed 3.8% active rate (matches old 4.2% baseline). The model works for disambiguation (2-10 candidates with similar names) but NOT for open-ended batch matching without a name floor.

**Data State After Revert:**
- unified_match_log: 119,747 active + 119,451 rejected (verified matches pre-run state)
- osha_f7_matches: 147,271 (unchanged)
- Bad run entries (860K) deleted, 119,747 superseded entries restored to active

### B4 Batched Re-run (2026-02-18) — OSHA

**Approach:** Added `--batch N/M` flag to `run_deterministic.py`. Processes records in 25% slices with per-batch supersede (only touches current batch's old matches). Checkpoint file at `checkpoints/osha_rerun.json` tracks progress and per-batch stats.

**Command:** `py scripts/matching/run_deterministic.py osha --rematch-all --batch 1/4`

**OSHA Batch 1/4 Interim Quality Check (~252K records, still running):**

| Category | Count | Notes |
|----------|-------|-------|
| Exact tiers 1-4 (HIGH/MED) | ~11,900 | Solid: name+city+state, name+state, aggressive |
| Splink HIGH | ~12,270 | 94% scored 0.95+. Name floor 0.65 working. |
| Splink MEDIUM | ~612 | OK |
| Trigram HIGH+MED | ~1,058 | Marginal |
| Trigram LOW (rejected) | ~29,486 | Garbage -- correctly rejected, not in legacy |
| Ambiguous (rejected) | ~2,459 | Correctly flagged |
| **Active match rate** | **~9%** | Higher than old 4.2% baseline but not the 81% disaster |

**Verdict:** Name similarity floor (token_sort_ratio >= 0.65) is working. The 81% overmatching catastrophe from the first attempt is gone. Active rate of ~9% is higher than old baseline (~4%) mainly from Splink finding ~12K legitimate new matches (Supreme Steel, Teva Pharmaceuticals, etc.).

**Known concern:** A few Splink false positives at the 0.65 name floor -- e.g., "nex transport" matched to "cassens transport" (0.733 name sim but different companies). Splink probability is 1.0 because geography overweights. Could tighten floor to 0.70 for stricter matching, but would lose some good matches.

**To resume:** Run batches 2-4:
```
py scripts/matching/run_deterministic.py osha --rematch-all --batch 2/4
py scripts/matching/run_deterministic.py osha --rematch-all --batch 3/4
py scripts/matching/run_deterministic.py osha --rematch-all --batch 4/4
```
Check progress: `py scripts/matching/run_deterministic.py osha --batch-status`

**Pre-run DB state (for rollback reference):**
- UML osha active: 62,903
- UML osha rejected: 132,430
- UML osha superseded: 147,865
- osha_f7_matches: 147,271

---

## Section 7: Recent Phase A Fixes (2026-02-16)

*Moved from Section 4 inline notes — see Section 4 for current status of each issue.*

---

### Why signal-strength scoring instead of penalizing missing data
Most employers are only matched to 2-3 of the 8+ data sources. If missing data counted as zero, 85% of employers would get artificially low scores. Signal-strength scoring only evaluates factors where data exists, paired with a coverage percentage ("scored on 3 of 8 factors") so users know how much information is behind the number.

### Why Splink over trigram for fuzzy matching
Trigram matching (pg_trgm) only measures string similarity between names. Splink weighs multiple evidence fields (name, state, city, ZIP, industry, address) and calculates a probability that two records are the same entity. "Springfield Hospital" and "Springfield Health Center" score ~0.6 on trigram but ~0.94 on Splink when they share city, state, and industry. Splink is already installed and was used for earlier deduplication work.

### Why F-7 is the foundation (not OSHA or NLRB)
The DOL F-7 filing is the only comprehensive registry of union-employer bargaining relationships. OSHA covers workplaces (not employers), NLRB covers elections (not ongoing relationships), and SEC/990/SAM each cover narrow slices. F-7 provides the most complete list of employers with active union contracts — 146,863 records. Everything else matches against F-7.

### Why the master employer key is deferred
A master employer key (one platform ID per real-world employer, mapped to all source IDs) is the ideal architecture. But building it too early bakes in matching errors that are hard to undo. The current approach uses `f7_employer_id` as the de facto key with match tables linking other sources. The master key will be built during Phase E (scorecard rebuild) when matching quality is higher and confidence thresholds are established.

## Section 8: Session Handoff Notes (2026-02-20c, Claude Code — NY Export v2)

### Completed in this session
- **Rewrote `export_ny_deduped.py`** — collapsed, one-row-per-real-employer CSV for NY.
  - 5-step pipeline: canonical group collapse -> multi-employer detection -> fuzzy dedup -> public sector at top -> NLRB append
  - Rows: 18,482 -> 15,509 (16% reduction)
  - Starbucks: 20+ rows -> 3 (1 canonical group, 513 workers, 19 locations)
  - SAG-AFTRA: 6+ rows -> 2 (1 office + 1 flagged multi-employer agreement)
  - 78 multi-employer agreements detected and flagged
  - 20 public-sector entries at top of CSV
- **Created methodology document:** `docs/NY_EXPORT_METHODOLOGY.md` (detailed methodology, problems, alternatives)

### Output file
- `ny_employers_deduped.csv` — 15,509 rows, 23 columns

### What's next
- Consider expanding canonical grouping to catch more duplicates upstream
- Consider address-based or EIN-based dedup as supplementary signals
- Multi-employer agreement member enumeration (list individual employers under each agreement)
- Corporate hierarchy collapsing (SEC/GLEIF parent-subsidiary data)

### File references
- Modified: `export_ny_deduped.py`
- New: `docs/NY_EXPORT_METHODOLOGY.md`, `docs/session-summaries/SESSION_SUMMARY_2026-02-20c_claude_ny_export_v2.md`

---

## Previous: Session Handoff Notes (2026-02-20, Claude Code — Phase B COMPLETE + Frontend Fixes)

### Completed in this session
- **PHASE B COMPLETE.** All B4 source re-runs finished (9h 15m via `run_remaining_reruns.py`):
  - 990 5/5: 586,767 records, 20,215 active (3.4%)
  - WHD: 363,365 records, 19,462 active (5.4%). No OOM (ran solo).
  - SAM 5/5: 826,042 records, 28,816 active (3.5%). No OOM (batched to 165K each).
- **Legacy match tables rebuilt** from UML: osha(97,142), sam(28,816), 990(20,005), whd(19,462), nlrb_xref(13,031).
- **All 3 MVs refreshed:** scorecard(212,441), data_sources(146,863), unified(146,863).
- **Frontend cross-nav bugs fixed.** `loadUnionDetail()` and `selectUnionByFnum()` now call `/api/unions/{fNum}` directly.
- **Pagination fix.** `totalPages` divided by 50 not 15. Extracted `PAGE_SIZE` constant.
- **4 dead API endpoints marked DEPRECATED** in `employers.py`.
- **Misclassification audit.** 2,776 employer records = labor orgs (only 3 flagged). Remediation deferred.
- **990 adapter bug fixed.** Dual unique constraints on legacy table. Changed to `ON CONFLICT DO NOTHING`.
- **UML:** 1,738,115 rows. Tests: 456/457.

### Active match counts (post-B4)
| Source | Active | Rate |
|--------|--------|------|
| OSHA | 97,142 | 9.6% |
| SAM | 28,816 | 3.5% |
| 990 | 20,215 | 3.4% |
| crosswalk | 19,293 | — |
| WHD | 19,462 | 5.4% |
| NLRB | 13,031 | — |
| SEC | 5,339 | 1.0% |
| GLEIF | 1,840 | — |
| mergent | 1,045 | — |
| BMF | 9 | — |

### What's next (per roadmap)
- **Phase C:** 166 missing unions (61,743 workers). CWA District 7 geographic devolution.
- **Phase D remaining:** D2 (GLEIF archive, ~12GB), D6 (redundant files, ~9.3GB), D7 (credential fixes), D9 (docs refresh).
- **Phase F:** Docker, CI/CD, hosting, beta testers. Critical path: A -> B -> E -> **F** (we're here).
- **Misclassification:** 2,776 labor orgs in employer table need bulk flagging.

### File references
- Committed + pushed: `files/js/detail.js`, `files/js/search.js`, `api/routers/employers.py`
- Modified (not committed): `scripts/matching/adapters/n990_adapter.py`, `run_remaining_reruns.py`
- New: `docs/session-summaries/SESSION_SUMMARY_2026-02-20_claude_b4_completion.md`

---

## Previous: Session Handoff Notes (2026-02-18c, Claude Code — Frontend Unified Scorecard + B4 Completion + Source Re-runs)

### Completed in this session
- **B4 OSHA All 4 Batches COMPLETE.** Remarkably consistent results:
  - Batch 1: 251,804 records, 40.3%, 24,349 H+M
  - Batch 2: 251,804 records, 40.4%, 24,178 H+M
  - Batch 3: 251,804 records, 40.4%, 24,252 H+M
  - Batch 4: 251,805 records, 40.3%, 24,363 H+M
  - **Total: 1,007,217 records, 97,142 HIGH+MEDIUM active matches (9.6%)**
- **BMF re-run COMPLETE.** 15/25 matched (60%), 9 H+M. Fixed `bmf_adapter_module.py` ON CONFLICT bug (corporate_identifier_crosswalk has no unique constraint on f7_employer_id due to 2,306 duplicates — switched to UPDATE-then-INSERT pattern).
- **SEC re-run PARTIAL.** Was in final trigram tail when stopped. Active: 6,750, rejected: ~25K. Needs re-run.
- **990 re-run PARTIAL.** Was writing legacy tables when stopped. Active: 34,000, rejected: ~14K. Needs re-run.
- **WHD re-run FAILED (OOM).** PostgreSQL ran out of memory during trigram batch write when running 4 sources in parallel. Needs re-run solo.
- **SAM re-run FAILED (OOM).** numpy OOM on Splink pass — 826K records is too large for parallel. Needs batched re-run (`--batch` flag) or solo run.
- **Frontend unified scorecard DONE.** Wired up `scorecard.js` to use `/api/scorecard/unified` endpoints:
  - `loadUnifiedResults()` — calls unified API, maps data, supports pagination
  - `renderUnifiedDetail()` — 7 factors (0-10) with color bars, explanations, OSHA/NLRB/WHD/contracts context
  - `loadUnifiedStates()` — state filter from unified endpoint with avg scores
  - Dynamic tier labels (TOP 7+, HIGH 5+, MEDIUM 3.5+, LOW <3.5)
  - Dynamic legend using UNIFIED_SCORE_FACTORS
  - Unified-specific badges (OSHA/NLRB/WHD/Fed Contractor), coverage stats
  - 439/441 tests pass (same 2 pre-existing failures)

### To resume
1. **Re-run SEC:** `py scripts/matching/run_deterministic.py sec --rematch-all`
2. **Re-run 990:** `py scripts/matching/run_deterministic.py 990 --rematch-all`
3. **Re-run WHD:** `py scripts/matching/run_deterministic.py whd --rematch-all` (run SOLO, not in parallel — OOM risk)
4. **Re-run SAM:** `py scripts/matching/run_deterministic.py sam --rematch-all` (run SOLO — 826K records, OOM risk. Consider `--batch 1/2` and `--batch 2/2` if still OOM)
5. **After all sources complete:** Refresh MVs:
   ```
   py scripts/scoring/create_scorecard_mv.py --refresh
   py scripts/scoring/build_employer_data_sources.py --refresh
   py scripts/scoring/build_unified_scorecard.py --refresh
   ```
6. **Important:** Run sources ONE AT A TIME to avoid OOM. Do NOT run WHD or SAM in parallel with anything.

---

## Older Sessions (2026-02-18b and earlier)

Full session handoff notes for earlier sessions have been moved to `docs/session-summaries/SESSION_LOG_2026.md`. Summary of key work completed:

- **2026-02-18b (Claude Code):** OSHA batch 1/4 done. 336 unused indexes dropped (3.0 GB). Freshness "3023" bug fixed. 29 crosswalk remaps (orphans 195->166, workers 92K->62K). CWA District 7 deferred.
- **2026-02-18 (Codex):** Missing unions analysis (195 orphans, 30 crosswalk mappings). WHD score backfill (11,297 employers). NLRB ULP matching gap analysis.
- **2026-02-18 (Codex):** Scorecard router, employer match provenance endpoint, API error tests (9 new).
- **2026-02-18 (Gemini):** State PERB research (12 states). BLS OEWS, cosine similarity, revenue-per-employee, ACS PUMS, calibration engine, O*NET research reports.
- **2026-02-18 (Gemini CLI):** Deep dive architecture research. Frontend expansion research (shadcn + TanStack Table). Revenue-per-employee data source confirmed.
- **2026-02-18 (Claude Code):** Batched re-run feature (`--batch N/M`). OSHA batch 1/4 started. Splink name floor 0.65 working (later raised to 0.70).
- **2026-02-17 (Claude Code):** Phase D1 auth hardening. Startup guard, centralized deps, 3 admin + 3 write endpoints protected.

For full details on any session, see `docs/session-summaries/SESSION_LOG_2026.md`.
