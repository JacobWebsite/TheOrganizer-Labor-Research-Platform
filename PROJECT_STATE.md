# PROJECT_STATE.md — Labor Relations Research Platform

**Purpose:** Shared context document for all AI tools (Claude Code, Codex, Gemini) and human developers. Read this first before any work session.

**Last manually updated:** 2026-02-18 (Phase B UI/API follow-up)

---

## Section 1: Quick Start

### Database Connection
- **Engine:** PostgreSQL 17
- **Database:** `olms_multiyear`
- **Host:** localhost:5432
- **User:** `postgres`
- **Credentials:** Stored in `.env` at project root (never commit this file)
- **Shared module:** `from db_config import get_connection` — used by all scripts and the API

### Start the API Server
```bash
py -m uvicorn api.main:app --reload --port 8001
```
Or use `start-claude.bat` which runs the same command.

The API serves at `http://localhost:8001`. API docs at `http://localhost:8001/docs`.

### Run Tests
```bash
py -m pytest tests/ -q
```
380 tests. All should pass except `test_expands_hospital_abbreviation` (pre-existing name normalization edge case).

### Key Files
| File | Purpose |
|------|---------|
| `db_config.py` | Shared database connection — imported by 500+ files |
| `.env` | Database credentials and JWT secret |
| `api/main.py` | FastAPI application entry point |
| `CLAUDE.md` | Detailed project instructions for AI tools |
| `UNIFIED_ROADMAP_2026_02_17.md` | Single source of truth for status, problems, and plan |
| `PIPELINE_MANIFEST.md` | Every active script — what it does, when to run it |

---

## Section 2: Database Inventory

*Auto-generated by `scripts/maintenance/generate_db_inventory.py` on 2026-02-16 22:47. Re-run to refresh.*

| Metric | Value |
|--------|-------|
| Database size | 20 GB |
| Tables | 178 |
| Views | 186 |
| Materialized views | 6 |
| Indexes | 559 (total size: 2,718 MB) |
| Estimated total rows | 25,358,111 |

**Materialized Views:**

| View | Rows |
|------|------|
| `mv_whd_employer_agg` | 330,419 |
| `mv_organizing_scorecard` | 201,258 |
| `mv_employer_search` | 170,775 |
| `mv_employer_data_sources` | 146,863 |
| `mv_unified_scorecard` | 146,863 |
| `mv_employer_features` | 54,968 |

**Top 30 Tables by Row Count:**

| Table | Rows |
|-------|------|
| `ar_disbursements_emp_off` | 2,813,076 |
| `osha_violations_detail` | 2,245,012 |
| `nlrb_docket` | 2,046,151 |
| `qcew_annual` | 1,943,426 |
| `nlrb_participants` | 1,905,912 |
| `epi_union_membership` | 1,420,064 |
| `employers_990_deduped` | 1,046,167 |
| `osha_establishments` | 1,008,397 |
| `osha_violation_summary` | 872,163 |
| `sam_entities` | 827,972 |
| `nlrb_allegations` | 715,805 |
| `national_990_filers` | 586,767 |
| `sec_companies` | 517,403 |
| `gleif_ownership_links` | 498,963 |
| `nlrb_filings` | 498,749 |
| `nlrb_cases` | 477,688 |
| `gleif_us_entities` | 379,192 |
| `whd_cases` | 362,634 |
| `lm_data` | 331,238 |
| `mv_whd_employer_agg` | 330,419 |
| `ar_assets_investments` | 304,816 |
| `employer_comparables` | 269,785 |
| `unified_match_log` | 265,526 |
| `ar_membership` | 216,508 |
| `ar_disbursements_total` | 216,372 |
| `nlrb_employer_xref` | 179,275 |
| `union_names_crosswalk` | 171,481 |
| `mv_employer_search` | 170,775 |
| `f7_employers_deduped` | 146,863 |
| `f7_employers` | 146,863 |

*178 tables total. 2 empty tables.*

---

## Section 3: Active Pipeline

See **`PIPELINE_MANIFEST.md`** for the complete script inventory.

**Summary:** 69 active pipeline scripts across 5 stages:
- **Stage 1 — ETL:** 24 scripts loading data from OSHA, WHD, SAM, SEC, NLRB, BLS, GLEIF, IRS, and more
- **Stage 2 — Matching:** 29 scripts (core pipeline + adapters + matchers) linking records across databases
- **Stage 3 — Scoring:** 8 scripts (4 scoring + 4 ML) computing the organizing scorecard and propensity model
- **Stage 4 — Maintenance:** 2 scripts for periodic refresh (scorecard, data freshness)
- **Stage 5 — Web Scraping:** 7 scripts for union website data extraction

**Typical full pipeline run order:**
```
1.  ETL: Load/refresh source data
2.  Matching: py scripts/matching/run_deterministic.py all
3.  Matching: py scripts/matching/splink_pipeline.py (optional fuzzy)
4.  Matching: py scripts/matching/build_employer_groups.py
4.5 Scoring: py scripts/scoring/build_employer_data_sources.py --refresh
4.6 Scoring: py scripts/scoring/build_unified_scorecard.py --refresh
5.  Scoring: py scripts/scoring/compute_nlrb_patterns.py
6.  Scoring: py scripts/scoring/create_scorecard_mv.py --refresh
7.  Scoring: py scripts/scoring/compute_gower_similarity.py --refresh-view
8.  ML: py scripts/ml/train_propensity_model.py --score-only
9.  Maintenance: py scripts/maintenance/create_data_freshness.py --refresh
```

---

## Section 4: Current Status and Known Issues

### CRITICAL (fix before anything else)

1. ~~**Scorecard uses 10-year-old OSHA data.**~~ **FIXED (Phase A2).** Root cause: OSHA changed `union_status` codes from N/Y to A/B after 2015. View filter changed from `= 'N'` to `!= 'Y'`. MV expanded from 22,389 to 201,258 rows.

2. ~~**Security is turned off by default.**~~ **HARDENED (Phase D1).** Auth is now enforced by default -- API refuses to start without `LABOR_JWT_SECRET` unless `DISABLE_AUTH=true` is explicitly set. Admin endpoints require admin role. Write endpoints require authentication. Local dev still uses `DISABLE_AUTH=true` in `.env`.

3. **Half of union-employer relationships are invisible.** 60,373 of 119,844 relationships (50.4%) in `f7_union_employer_relations` point to employer IDs that don't exist in the deduped table. 7M workers (44.3%) are associated with orphaned records.

### HIGH (fix before letting others use it)

4. ~~**Scorecard coverage improved but still OSHA-centric.**~~ **FIXED (Phase E3).** Unified scorecard (`mv_unified_scorecard`) scores ALL 146,863 F7 employers using signal-strength approach: 7 factors (each 0-10), missing factors excluded, score = average of available factors. Coverage percentage shows data completeness.

5. ~~**Two separate scorecards with different logic.**~~ **FIXED (Phase E3).** One unified scorecard pipeline replaces both OSHA-based and Mergent-based scoring. Old scorecard (`mv_organizing_scorecard`) kept for backward compatibility.

6. ~~**Matching pipeline has two bugs.**~~ **FIXED (Phase B1-B2).** Tier ordering corrected (strict-to-broad: EIN > name+city+state > name+state > aggressive > Splink fuzzy > trigram). First-hit-wins replaced with best-match-wins (keeps highest-tier match per source record). Splink re-integrated as tier 5a with name similarity floor (token_sort_ratio >= 0.65) after discovering Splink model overweights geography.

7. **195 missing unions covering 92,627 workers.** Relations reference file numbers not in the unions master table.

8. ~~**Corporate hierarchy endpoints are broken.**~~ **FIXED (Phase A3).** 7 RealDictCursor indexing bugs fixed, route shadowing resolved (search before parameterized).

9. **Platform only runs on one laptop.** No Docker, no CI/CD, no automated maintenance.

### MEDIUM

10. ~~Match quality dashboard inflates numbers (counts rows, not distinct employers).~~ **FIXED (Phase A4).** API and report now show both `total_match_rows` and `unique_employers_matched`.
11. NLRB time-decay is a dead switch (always 1.0).
12. Model B propensity score is basically random (AUC 0.53).
13. Documentation keeps falling behind (19 known inaccuracies in CLAUDE.md).
14. ~~778 Python files with no manifest.~~ **PARTIALLY ADDRESSED** — Pipeline manifest created, dead scripts archived, credential pattern fixed. ~120 active scripts remain, down from 530+.
15. Database is twice as big as needed (~12 GB raw GLEIF + ~1.67 GB unused indexes).

---

## Section 5: Recent Decisions

From the Feb 16-17, 2026 planning session (full list in UNIFIED_ROADMAP Appendix B):

| # | Topic | Decision |
|---|-------|----------|
| 1 | Stale materialized views | Fine for now, proof of concept first |
| 2 | F-7 orphan problem | Fix first (highest priority), detailed checkpoint procedure defined |
| 3 | OLMS unused data | Tier 1: organizing spend + membership trends. Tier 2: financial health. Future: officer/leadership |
| 4 | Matching bugs | Reorder strict-to-broad, fix first-hit-wins, bring Splink back, re-run, add confidence flags |
| 5 | Scorecard design | Unified pipeline, signal-strength scoring (missing=excluded not zero), all employers covered |
| 6 | Gower distance | Comparables display only, separate from score |
| 7 | Industry density | Drop as standalone score factor (not actionable), keep as informational display |
| 8 | Geographic favorability | Drop as standalone score factor (too broad), keep as informational display |
| 9 | Government contracts | Combine federal + state + municipal into one factor |
| 10 | Union proximity | Merge sibling unions + corporate hierarchy into one factor, weight siblings more heavily |
| 11 | BLS projections | Add industry growth/decline as component of financial indicators factor |
| 12 | Propensity model | Needs more non-union training data before improvement |
| 13 | Membership display | Distinguish "covered workers" vs "dues-paying members" in UI |
| 14 | 195 missing unions | Check crosswalk first, manual lookup top 20, categorize, remap |
| 15 | Corporate hierarchy | Fix broken API, improve crosswalk coverage. Master key deferred to long-term |
| 16 | FMCS data | Removed from roadmap |
| 17 | Web scraper | On-demand deep-dive tool, not always-running crawler |
| 18 | Workforce demographics | Phase 1: expose BLS matrix. Phase 2: ACS PUMS. Phase 3: revenue-to-headcount. Phase 4: O*NET |
| 19 | F-7 time boundaries | Investigate after orphan fix |
| 20 | Frontend redesign | Major redesign after data foundation is solid |
| 21 | Checkpoints | Built into every work session |
| 22 | Contract database | Lower priority, Wave 3 |
| 23 | Project organization | Script manifest, archive dead files, PROJECT_STATE.md for multi-AI workflow |
| 24 | Multi-AI context | Shared PROJECT_STATE.md with auto-generated sections, session handoff notes |
| 25 | Simpler communication | Explain all technical concepts in plain language |

---

## Section 6: Key Design Rationale

### Phase B Progress (2026-02-17) — Matching Pipeline Fixes

**Status:** B1-B3 complete, B4 partially complete (OSHA re-run reverted), B5 complete.

| Task | Status | Description |
|------|--------|-------------|
| B1 | DONE | Tier reordering: strict-to-broad cascade (EIN 100 > name+city+state 90 > name+state 80 > aggressive 60 > Splink 45 > trigram 40) |
| B2 | DONE | Name collision fix: best-match-wins replaces first-hit-wins |
| B3 | DONE | Splink re-integrated as tier 5a with name similarity floor. Trigram fallback as tier 5b |
| B4 | IN PROGRESS | Re-run affected match tables. OSHA first run reverted (quality problem). SEC/BMF adapter source_system bugs fixed. All adapters upgraded to ON CONFLICT DO UPDATE. Supersede logic added for --rematch-all |
| B5 | DONE | Added confidence flags to UI (HIGH hidden, MEDIUM=Probable match, LOW=Verify match) |

**Critical Finding — Splink Model Calibration:**
The pre-trained Splink model (`adaptive_fuzzy_model.json`) overweights geographic features. State (BF~25), city (BF~400), and zip (BF~840) Bayes factors multiply to ~8.5M, overwhelming the 0.0001 prior to give 0.99+ match probability regardless of name similarity. First OSHA re-run produced 835K active matches (81% match rate vs expected ~4%) before being killed and reverted. Fix: added `rapidfuzz.fuzz.token_sort_ratio >= 0.65` post-filter. Dry-run on 5K records showed 3.8% active rate (matches old 4.2% baseline). The model works for disambiguation (2-10 candidates with similar names) but NOT for open-ended batch matching without a name floor.

**Data State After Revert:**
- unified_match_log: 119,747 active + 119,451 rejected (verified matches pre-run state)
- osha_f7_matches: 147,271 (unchanged)
- Bad run entries (860K) deleted, 119,747 superseded entries restored to active

---

## Section 7: Recent Phase A Fixes (2026-02-16)

*Moved from Section 4 inline notes — see Section 4 for current status of each issue.*

---

### Why signal-strength scoring instead of penalizing missing data
Most employers are only matched to 2-3 of the 8+ data sources. If missing data counted as zero, 85% of employers would get artificially low scores. Signal-strength scoring only evaluates factors where data exists, paired with a coverage percentage ("scored on 3 of 8 factors") so users know how much information is behind the number.

### Why Splink over trigram for fuzzy matching
Trigram matching (pg_trgm) only measures string similarity between names. Splink weighs multiple evidence fields (name, state, city, ZIP, industry, address) and calculates a probability that two records are the same entity. "Springfield Hospital" and "Springfield Health Center" score ~0.6 on trigram but ~0.94 on Splink when they share city, state, and industry. Splink is already installed and was used for earlier deduplication work.

### Why F-7 is the foundation (not OSHA or NLRB)
The DOL F-7 filing is the only comprehensive registry of union-employer bargaining relationships. OSHA covers workplaces (not employers), NLRB covers elections (not ongoing relationships), and SEC/990/SAM each cover narrow slices. F-7 provides the most complete list of employers with active union contracts — 146,863 records. Everything else matches against F-7.

### Why the master employer key is deferred
A master employer key (one platform ID per real-world employer, mapped to all source IDs) is the ideal architecture. But building it too early bakes in matching errors that are hard to undo. The current approach uses `f7_employer_id` as the de facto key with match tables linking other sources. The master key will be built during Phase E (scorecard rebuild) when matching quality is higher and confidence thresholds are established.

## Section 8: Session Handoff Notes (2026-02-18, Codex)

### Completed in this session
- Added scorecard namespace endpoints in new router `api/routers/scorecard.py`:
  - `GET /api/scorecard/` with pagination wrapper (`data`, `total`, `offset`, `page_size`, `has_more`)
  - `GET /api/scorecard/states` (distinct state + count from `mv_organizing_scorecard`)
  - `GET /api/scorecard/versions`
  - `GET /api/scorecard/versions/current`
  - `GET /api/scorecard/{estab_id}` (detail passthrough)
- Registered new router in `api/main.py`.
- Added global DB error mapping in `api/main.py`: `psycopg2.Error -> 503`.
- Added employer match provenance endpoint:
  - `GET /api/employers/{employer_id}/matches` in `api/routers/corporate.py`
  - Reads active F7-target matches from `unified_match_log`.
- Updated scorecard modal UI:
  - Uses `/api/scorecard/` for OSHA mode
  - Supports load-more pagination
  - Loads state filter from `/api/scorecard/states`
  - Shows current score version/timestamp from `/api/scorecard/versions/current`
- Updated employer detail modal UI:
  - Added `Match Info` table (source_system, match_method, confidence_band, confidence_score)
- Added new API error tests in `tests/test_api_errors.py`:
  - bogus ID -> 404 coverage for scorecard/corporate/employers focus paths
  - invalid query type -> 422
  - DB connection failure path -> 503
  - Result: `9 passed`

### Route note
- Existing detailed health endpoint moved to `GET /api/health/details`.
- New lightweight health endpoint remains `GET /api/health` via `api/routers/system.py`.

### File references
- Backend: `api/main.py`, `api/routers/scorecard.py`, `api/routers/corporate.py`, `api/routers/employers.py`, `api/routers/health.py`, `api/routers/system.py`
- Frontend: `files/organizer_v5.html`, `files/js/scorecard.js`, `files/js/detail.js`
- Tests: `tests/test_api_errors.py`

## Session Handoff Notes (2026-02-17, Claude Code — Phase D1 Auth Hardening)

### Completed in this session
- **Auth hardening (Phase D1):**
  - Created `api/dependencies.py` — centralized `require_admin` and `require_auth` FastAPI dependencies
  - Startup guard in `api/main.py`: `sys.exit(1)` if no JWT_SECRET and DISABLE_AUTH is not true (was: silent warning)
  - Exported `AUTH_DISABLED` boolean from `api/config.py` (was private `_disable_auth`)
  - 3 admin endpoints (`refresh-scorecard`, `refresh-freshness`, `match-review`) now use `Depends(require_admin)` — replaced inline role checks; `match-review` previously had NO role check
  - 3 write endpoints (`POST /api/employers/flags`, `DELETE /api/employers/flags/{id}`, `POST /api/employers/refresh-search`) now require authentication via `Depends(require_auth)` — previously unprotected
  - `.env` updated: auth enforced by default, `DISABLE_AUTH=true` kept for local dev with clear documentation
  - `tests/conftest.py` updated: explicitly sets `DISABLE_AUTH=true` in test environment
  - `tests/test_auth.py`: 6 new role-based tests (admin endpoint 403 for read users, 401 without token, write endpoint auth)
  - All 22 auth tests pass. 375/396 total tests pass (21 failures are pre-existing: scorecard 503s, rate limiting 429s, hospital abbreviation)

### Deployment checklist
- Remove `DISABLE_AUTH=true` from `.env` (or don't include it in production)
- `LABOR_JWT_SECRET` already set (64 chars)
- First user self-registers as admin at `POST /api/auth/register`

### File references
- New: `api/dependencies.py`
- Modified: `api/config.py`, `api/main.py`, `api/middleware/auth.py`, `api/routers/organizing.py`, `api/routers/employers.py`, `.env`, `tests/conftest.py`, `tests/test_auth.py`

