# PROJECT_STATE.md — Labor Relations Research Platform

**Purpose:** Shared context document for all AI tools (Claude Code, Codex, Gemini) and human developers. Read this first before any work session.

**Last manually updated:** 2026-02-16

---

## Section 1: Quick Start

### Database Connection
- **Engine:** PostgreSQL 17
- **Database:** `olms_multiyear`
- **Host:** localhost:5432
- **User:** `postgres`
- **Credentials:** Stored in `.env` at project root (never commit this file)
- **Shared module:** `from db_config import get_connection` — used by all scripts and the API

### Start the API Server
```bash
py -m uvicorn api.main:app --reload --port 8001
```
Or use `start-claude.bat` which runs the same command.

The API serves at `http://localhost:8001`. API docs at `http://localhost:8001/docs`.

### Run Tests
```bash
py -m pytest tests/ -q
```
359 tests. All should pass except `test_expands_hospital_abbreviation` (pre-existing name normalization edge case).

### Key Files
| File | Purpose |
|------|---------|
| `db_config.py` | Shared database connection — imported by 500+ files |
| `.env` | Database credentials and JWT secret |
| `api/main.py` | FastAPI application entry point |
| `CLAUDE.md` | Detailed project instructions for AI tools |
| `UNIFIED_ROADMAP_2026_02_17.md` | Single source of truth for status, problems, and plan |
| `PIPELINE_MANIFEST.md` | Every active script — what it does, when to run it |

---

## Section 2: Database Inventory

*Auto-generated by `scripts/maintenance/generate_db_inventory.py` on 2026-02-16 22:13. Re-run to refresh.*

| Metric | Value |
|--------|-------|
| Database size | 20 GB |
| Tables | 178 |
| Views | 186 |
| Materialized views | 4 |
| Indexes | 559 (total size: 2,704 MB) |
| Estimated total rows | 25,179,241 |

**Materialized Views:**

| View | Rows |
|------|------|
| `mv_whd_employer_agg` | 330,419 |
| `mv_employer_search` | 170,775 |
| `mv_employer_features` | 54,968 |
| `mv_organizing_scorecard` | 22,389 |

**Top 30 Tables by Row Count:**

| Table | Rows |
|-------|------|
| `ar_disbursements_emp_off` | 2,813,076 |
| `osha_violations_detail` | 2,245,012 |
| `nlrb_docket` | 2,046,151 |
| `qcew_annual` | 1,943,426 |
| `nlrb_participants` | 1,905,912 |
| `epi_union_membership` | 1,420,064 |
| `employers_990_deduped` | 1,046,167 |
| `osha_establishments` | 1,008,397 |
| `osha_violation_summary` | 872,163 |
| `sam_entities` | 827,972 |
| `nlrb_allegations` | 715,805 |
| `national_990_filers` | 586,767 |
| `sec_companies` | 517,403 |
| `gleif_ownership_links` | 498,963 |
| `nlrb_filings` | 498,749 |
| `nlrb_cases` | 477,688 |
| `gleif_us_entities` | 379,192 |
| `whd_cases` | 362,634 |
| `lm_data` | 331,238 |
| `mv_whd_employer_agg` | 330,419 |
| `ar_assets_investments` | 304,816 |
| `employer_comparables` | 269,785 |
| `unified_match_log` | 265,526 |
| `ar_membership` | 216,508 |
| `ar_disbursements_total` | 216,372 |
| `nlrb_employer_xref` | 179,275 |
| `union_names_crosswalk` | 171,481 |
| `mv_employer_search` | 170,775 |
| `f7_employers_deduped` | 146,863 |
| `f7_employers` | 146,863 |

*178 tables total. 2 empty tables.*

---

## Section 3: Active Pipeline

See **`PIPELINE_MANIFEST.md`** for the complete script inventory.

**Summary:** 69 active pipeline scripts across 5 stages:
- **Stage 1 — ETL:** 24 scripts loading data from OSHA, WHD, SAM, SEC, NLRB, BLS, GLEIF, IRS, and more
- **Stage 2 — Matching:** 29 scripts (core pipeline + adapters + matchers) linking records across databases
- **Stage 3 — Scoring:** 8 scripts (4 scoring + 4 ML) computing the organizing scorecard and propensity model
- **Stage 4 — Maintenance:** 2 scripts for periodic refresh (scorecard, data freshness)
- **Stage 5 — Web Scraping:** 7 scripts for union website data extraction

**Typical full pipeline run order:**
```
1. ETL: Load/refresh source data
2. Matching: py scripts/matching/run_deterministic.py all
3. Matching: py scripts/matching/splink_pipeline.py (optional fuzzy)
4. Matching: py scripts/matching/build_employer_groups.py
5. Scoring: py scripts/scoring/compute_nlrb_patterns.py
6. Scoring: py scripts/scoring/create_scorecard_mv.py --refresh
7. Scoring: py scripts/scoring/compute_gower_similarity.py --refresh-view
8. ML: py scripts/ml/train_propensity_model.py --score-only
9. Maintenance: py scripts/maintenance/create_data_freshness.py --refresh
```

---

## Section 4: Current Status and Known Issues

### CRITICAL (fix before anything else)

1. **Scorecard uses 10-year-old OSHA data.** Scoring MV only pulls inspections from 2012-2016, despite raw OSHA data going through 2025. The platform's main output could be misleading.

2. **Security is turned off by default.** `.env` has `DISABLE_AUTH=true`. If deployed without changing this, anyone can access everything.

3. **Half of union-employer relationships are invisible.** 60,373 of 119,844 relationships (50.4%) in `f7_union_employer_relations` point to employer IDs that don't exist in the deduped table. 7M workers (44.3%) are associated with orphaned records.

### HIGH (fix before letting others use it)

4. **Scorecard only covers ~15% of employers.** 22,389 out of 146,863 — built around OSHA establishments only.

5. **Two separate scorecards with different logic.** OSHA-based (22,389) and Mergent-based (947) use different factors and weights.

6. **Matching pipeline has two bugs.** Loose rules sometimes run before strict rules. Name collisions silently drop one match.

7. **195 missing unions covering 92,627 workers.** Relations reference file numbers not in the unions master table.

8. **Corporate hierarchy endpoints are broken.** 5 API endpoints reference a column name that doesn't exist.

9. **Platform only runs on one laptop.** No Docker, no CI/CD, no automated maintenance.

### MEDIUM

10. Match quality dashboard inflates numbers (counts rows, not distinct employers).
11. NLRB time-decay is a dead switch (always 1.0).
12. Model B propensity score is basically random (AUC 0.53).
13. Documentation keeps falling behind (19 known inaccuracies in CLAUDE.md).
14. ~~778 Python files with no manifest.~~ **PARTIALLY ADDRESSED** — Pipeline manifest created, dead scripts archived, credential pattern fixed. ~120 active scripts remain, down from 530+.
15. Database is twice as big as needed (~12 GB raw GLEIF + ~1.67 GB unused indexes).

---

## Section 5: Recent Decisions

From the Feb 16-17, 2026 planning session (full list in UNIFIED_ROADMAP Appendix B):

| # | Topic | Decision |
|---|-------|----------|
| 1 | Stale materialized views | Fine for now, proof of concept first |
| 2 | F-7 orphan problem | Fix first (highest priority), detailed checkpoint procedure defined |
| 3 | OLMS unused data | Tier 1: organizing spend + membership trends. Tier 2: financial health. Future: officer/leadership |
| 4 | Matching bugs | Reorder strict-to-broad, fix first-hit-wins, bring Splink back, re-run, add confidence flags |
| 5 | Scorecard design | Unified pipeline, signal-strength scoring (missing=excluded not zero), all employers covered |
| 6 | Gower distance | Comparables display only, separate from score |
| 7 | Industry density | Drop as standalone score factor (not actionable), keep as informational display |
| 8 | Geographic favorability | Drop as standalone score factor (too broad), keep as informational display |
| 9 | Government contracts | Combine federal + state + municipal into one factor |
| 10 | Union proximity | Merge sibling unions + corporate hierarchy into one factor, weight siblings more heavily |
| 11 | BLS projections | Add industry growth/decline as component of financial indicators factor |
| 12 | Propensity model | Needs more non-union training data before improvement |
| 13 | Membership display | Distinguish "covered workers" vs "dues-paying members" in UI |
| 14 | 195 missing unions | Check crosswalk first, manual lookup top 20, categorize, remap |
| 15 | Corporate hierarchy | Fix broken API, improve crosswalk coverage. Master key deferred to long-term |
| 16 | FMCS data | Removed from roadmap |
| 17 | Web scraper | On-demand deep-dive tool, not always-running crawler |
| 18 | Workforce demographics | Phase 1: expose BLS matrix. Phase 2: ACS PUMS. Phase 3: revenue-to-headcount. Phase 4: O*NET |
| 19 | F-7 time boundaries | Investigate after orphan fix |
| 20 | Frontend redesign | Major redesign after data foundation is solid |
| 21 | Checkpoints | Built into every work session |
| 22 | Contract database | Lower priority, Wave 3 |
| 23 | Project organization | Script manifest, archive dead files, PROJECT_STATE.md for multi-AI workflow |
| 24 | Multi-AI context | Shared PROJECT_STATE.md with auto-generated sections, session handoff notes |
| 25 | Simpler communication | Explain all technical concepts in plain language |

---

## Section 6: Key Design Rationale

### Why signal-strength scoring instead of penalizing missing data
Most employers are only matched to 2-3 of the 8+ data sources. If missing data counted as zero, 85% of employers would get artificially low scores. Signal-strength scoring only evaluates factors where data exists, paired with a coverage percentage ("scored on 3 of 8 factors") so users know how much information is behind the number.

### Why Splink over trigram for fuzzy matching
Trigram matching (pg_trgm) only measures string similarity between names. Splink weighs multiple evidence fields (name, state, city, ZIP, industry, address) and calculates a probability that two records are the same entity. "Springfield Hospital" and "Springfield Health Center" score ~0.6 on trigram but ~0.94 on Splink when they share city, state, and industry. Splink is already installed and was used for earlier deduplication work.

### Why F-7 is the foundation (not OSHA or NLRB)
The DOL F-7 filing is the only comprehensive registry of union-employer bargaining relationships. OSHA covers workplaces (not employers), NLRB covers elections (not ongoing relationships), and SEC/990/SAM each cover narrow slices. F-7 provides the most complete list of employers with active union contracts — 146,863 records. Everything else matches against F-7.

### Why the master employer key is deferred
A master employer key (one platform ID per real-world employer, mapped to all source IDs) is the ideal architecture. But building it too early bakes in matching errors that are hard to undo. The current approach uses `f7_employer_id` as the de facto key with match tables linking other sources. The master key will be built during Phase E (scorecard rebuild) when matching quality is higher and confidence thresholds are established.
